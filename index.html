<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- =====================================================
       DTAI_Online ‚Äì index.html FULL
       H·ªá th·ªëng: ƒêƒÉng k√Ω HS, ƒêƒÉng nh·∫≠p, Thi tr·∫Øc nghi·ªám n·ªôi b·ªô,
       L·ªãch s·ª≠ thi, Dashboard GVCN/T·ªï m√¥n, Import ƒë·ªÅ t·ª´ Word/Docs.
       https://script.google.com/macros/s/AKfycbwYP02sEb6PIUYigcNQhOALAXNtLqH36PXRtPYiUf9TYW3FpScvHHJkF0TRWPVCtYSE/exec
       ===================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DTAI_Online ‚Äì Ki·ªÉm tra tr·∫Øc nghi·ªám n·ªôi b·ªô</title>

  <!-- ============ CSS GIAO DI·ªÜN MOBILE-FRIENDLY ============ -->
  <style>
    :root {
      --brand: #2563eb;
      --brand-soft: #dbeafe;
      --accent: #22c55e;
      --danger: #ef4444;
      --bg: #0f172a;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d3b73, #020617);
      color: #0f172a;
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 10px 32px;
    }

    header {
      color: #e5e7eb;
      margin-bottom: 10px;
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    /* NAV TAB */
    .nav-tabs {
      display: flex;
      gap: 6px;
      margin: 10px 0 14px;
      flex-wrap: wrap;
    }

    .nav-tab-btn {
      flex: 1 1 120px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.6);
      color: #e5e7eb;
      font-size: 0.86rem;
      padding: 7px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.18s ease;
      white-space: nowrap;
    }

    .nav-tab-btn span.icon {
      font-size: 1rem;
    }

    .nav-tab-btn.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(37,99,235,0.6);
    }

    .nav-tab-btn:hover {
      background: rgba(30,64,175,0.9);
    }

    /* LAYOUT CHUNG SECTION */
    section {
      display: none;
    }

    section.active {
      display: block;
    }

    .card {
      background: #f9fafb;
      border-radius: var(--radius-lg);
      padding: 14px 14px 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.25);
      border: 1px solid rgba(148,163,184,0.4);
      margin-bottom: 14px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title .pill {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: var(--brand-soft);
      color: #1e40af;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .two-col {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 768px) {
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    /* FORM ELEMENTS */
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 3px;
    }

    .field-row {
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="date"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.86rem;
      outline: none;
      background: #ffffff;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    textarea {
      border-radius: 10px;
      resize: vertical;
      min-height: 60px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }

    .inline-fields {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    @media (max-width: 600px) {
      .inline-fields {
        grid-template-columns: 1fr;
      }
    }

    .help-text {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 2px;
    }

    /* BUTTONS */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37,99,235,0.65);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(37,99,235,0.8);
    }

    .btn-outline {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    .btn-outline:hover {
      background: #e5e7eb;
    }

    .btn-danger {
      background: #ef4444;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(239,68,68,0.4);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.8rem;
    }

    .btn-block {
      width: 100%;
      justify-content: center;
    }

    /* ALERT/STATUS */
    .status {
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .status.ok {
      color: #15803d;
    }

    .status.err {
      color: #b91c1c;
    }

    .badge {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--brand-soft);
      font-size: 0.7rem;
      color: #1e40af;
      align-items: center;
      gap: 4px;
    }

    /* QUIZ UI */
    .quiz-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
    }

    .quiz-header-left {
      font-size: 0.8rem;
    }

    .quiz-timer {
      font-size: 0.9rem;
      font-weight: 600;
      color: #b91c1c;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .quiz-question {
      border-radius: var(--radius-md);
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 8px 10px;
      margin-bottom: 8px;
    }

    .quiz-question h4 {
      margin: 0 0 5px;
      font-size: 0.86rem;
      font-weight: 600;
    }

    .quiz-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
    }

    .option-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.84rem;
      padding: 4px 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .option-row:hover {
      background: #f3f4f6;
    }

    .option-row input[type="radio"] {
      margin-top: 2px;
    }

    .quiz-result-box {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      font-size: 0.85rem;
    }

    .quiz-result-box strong {
      font-size: 0.9rem;
    }

    .quiz-review {
      margin-top: 8px;
      border-top: 1px dashed #e5e7eb;
      padding-top: 6px;
    }

    .review-item {
      font-size: 0.8rem;
      margin-bottom: 6px;
      padding: 5px 7px;
      border-radius: 8px;
      background: #f9fafb;
    }

    .review-item.correct {
      border-left: 3px solid #22c55e;
    }

    .review-item.incorrect {
      border-left: 3px solid #ef4444;
    }

    .review-item .q-text {
      font-weight: 500;
    }

    .review-item .ans-line {
      margin-top: 2px;
    }

    /* TABLES */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 6px;
    }

    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      background: #eff6ff;
      font-weight: 600;
    }

    tr:hover {
      background: #f9fafb;
    }

    .link {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.78rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      gap: 4px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .divider {
      border-top: 1px dashed #e5e7eb;
      margin: 8px 0;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- ============ HEADER ============ -->
  <header>
    <h1>DTAI_Online ‚Äì H·ªá th·ªëng ki·ªÉm tra tr·∫Øc nghi·ªám n·ªôi b·ªô</h1>
    <p>Tr∆∞·ªùng THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu ‚Äì ƒêƒÉng k√Ω h·ªçc sinh ¬∑ L√†m b√†i ¬∑ L·ªãch s·ª≠ ¬∑ Dashboard GVCN/T·ªï m√¥n</p>
  </header>

  <!-- ============ NAV TABS ============ -->
  <nav class="nav-tabs">
    <button class="nav-tab-btn active" data-target="section-registration" onclick="showSection('section-registration', this)">
      <span class="icon">üìù</span><span>1. ƒêƒÉng k√Ω th√¥ng tin HS</span>
    </button>
    <button class="nav-tab-btn" data-target="section-student" onclick="showSection('section-student', this)">
      <span class="icon">üéì</span><span>2. HS: ƒêƒÉng nh·∫≠p & l√†m b√†i</span>
    </button>
    <button class="nav-tab-btn" data-target="section-teacher" onclick="showSection('section-teacher', this)">
      <span class="icon">üë®‚Äçüè´</span><span>3. GVCN / T·ªï m√¥n</span>
    </button>
    <button class="nav-tab-btn" data-target="section-admin" onclick="showSection('section-admin', this)">
      <span class="icon">üß©</span><span>4. Import ƒë·ªÅ & Ng√¢n h√†ng</span>
    </button>
  </nav>

  <!-- =====================================================
       SECTION 1 ‚Äì FORM ƒêƒÇNG K√ù TH√îNG TIN C√Å NH√ÇN H·ªåC SINH
       G·ª≠i tr·ª±c ti·∫øp v√†o doPost (mode m·∫∑c ƒë·ªãnh = reg)
       ===================================================== -->
  <section id="section-registration" class="active">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            üìù ƒêƒÉng k√Ω th√¥ng tin h·ªçc sinh
            <span class="pill">Step 1</span>
          </div>
          <div class="card-subtitle">
            H·ªçc sinh ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc khi tham gia l√†m b√†i ki·ªÉm tra n·ªôi b·ªô.
          </div>
        </div>
      </div>

      <!-- FORM: POST ‚Üí doPost -->

<!-- FORM: POST ‚Üí doPost -->
      <form
        id="regForm"
        method="post"
        action="https://script.google.com/macros/s/AKfycbz8CxplZ76PQrGDMkBF6KzUmZQqGLL5I3xro-lFhpyVFFNi-0eyXw8YfTKBOxsQ32Qt/exec"
        target="_top">
        <!-- NH·ªö: thay __WEB_APP_URL_EXEC__ b·∫±ng ƒë√∫ng URL Web App /exec c·ªßa anh -->

        <!-- action="" ‚Üí POST l√™n ch√≠nh Web App URL, doPost x·ª≠ l√Ω -->
        <input type="hidden" name="mode" value="reg" />

        <div class="two-col">
          <!-- C·ªòT TR√ÅI -->
          <div>
            <div class="field-row">
              <label>H·ªç v√† t√™n (IN HOA) / Full name *</label>
              <input type="text" name="hoten" required />
              <div class="help-text">V√≠ d·ª•: NGUY·ªÑN VƒÇN A</div>
            </div>

            <div class="inline-fields field-row">
              <div>
                <label>Ng√†y sinh / Date of birth (dd/mm/yyyy) *</label>
                <input type="text" name="ngaysinh" placeholder="dd/mm/yyyy" required />
              </div>
              <div>
                <label>Gi·ªõi t√≠nh / Gender *</label>
                <select name="gioitinh" required>
                  <option value="">-- Ch·ªçn / Select --</option>
                  <option value="Nam / Male">Nam / Male</option>
                  <option value="N·ªØ / Female">N·ªØ / Female</option>
                  <option value="Kh√°c / Other">Kh√°c / Other</option>
                </select>
              </div>
            </div>

            <div class="inline-fields field-row">
              <div>
                <label>Kh·ªëi / Grade *</label>
                <select name="khoi" required>
                  <option value="">-- Ch·ªçn --</option>
                  <option value="10">Kh·ªëi 10</option>
                  <option value="11">Kh·ªëi 11</option>
                  <option value="12">Kh·ªëi 12</option>
                </select>
              </div>
              <div>
                <label>M√£ l·ªõp / Class code *</label>
                <input type="text" name="malop" placeholder="V√≠ d·ª•: 12A1" required />
              </div>
            </div>

            <div class="field-row">
              <label>CCCD *</label>
              <input type="text" name="cccd" required />
              <div class="help-text">H·ªá th·ªëng d√πng CCCD ƒë·ªÉ ƒëƒÉng nh·∫≠p v√† tra c·ª©u k·∫øt qu·∫£.</div>
            </div>

            <div class="field-row">
              <label>Email (n√™n d√πng Gmail) *</label>
              <input type="email" name="email" required />
              <div class="help-text">Email ƒë·ªÉ nh·∫≠n m·∫≠t kh·∫©u v√† phi·∫øu ƒëi·ªÉm PDF.</div>
            </div>
          </div>

          <!-- C·ªòT PH·∫¢I -->
          <div>
            <div class="field-row">
              <label>D√¢n t·ªôc / Ethnicity *</label>
              <input type="text" name="dantoc" placeholder="Kinh, M'N√¥ng, √ä ƒê√™, ..." required />
            </div>

            <div class="field-row">
              <label>Tr∆∞·ªùng / School *</label>
              <input type="text" name="truong" placeholder="THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu" required />
            </div>

            <div class="inline-fields field-row">
              <div>
                <label>X√£/Ph∆∞·ªùng / Ward *</label>
                <input type="text" name="xa" required />
              </div>
              <div>
                <label>T·ªânh/TP / Province *</label>
                <input type="text" name="tinh" placeholder="ƒê·∫Øk N√¥ng, L√¢m ƒê·ªìng, ..." required />
              </div>
            </div>

            <div class="field-row">
              <label>Ghi ch√∫ / Notes</label>
              <textarea name="ghichu" placeholder="Ghi ch√∫ ƒë·∫∑c bi·ªát (n·∫øu c√≥)..."></textarea>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <button type="submit" class="btn btn-primary btn-block">
          <span>G·ª≠i ƒëƒÉng k√Ω / Submit registration</span>
        </button>
        <div class="help-text" style="margin-top:6px;">
          Sau khi g·ª≠i, h·ªá th·ªëng s·∫Ω t·∫°o t√†i kho·∫£n v√† g·ª≠i m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p v√†o email c·ªßa h·ªçc sinh.
        </div>
      </form>
    </div>
  </section>

  <!-- =====================================================
       SECTION 2 ‚Äì KHU V·ª∞C H·ªåC SINH:
       - ƒêƒÉng nh·∫≠p CCCD/Email + m·∫≠t kh·∫©u
       - Ch·ªçn m√¥n & h√¨nh th·ª©c & s·ªë c√¢u ‚Üí L√†m b√†i n·ªôi b·ªô
       - Countdown, xem l·∫°i ƒë√°p √°n
       - L·ªãch s·ª≠ c√°c b√†i thi n·ªôi b·ªô theo CCCD
       ===================================================== -->
  <section id="section-student">
    <!-- CARD 2.1 ‚Äì ƒêƒÇNG NH·∫¨P -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            üéì ƒêƒÉng nh·∫≠p t√†i kho·∫£n h·ªçc sinh
            <span class="pill">Step 2</span>
          </div>
          <div class="card-subtitle">
            D√πng CCCD ho·∫∑c Email + m·∫≠t kh·∫©u (ƒë√£ g·ª≠i v·ªÅ email sau khi ƒëƒÉng k√Ω).
          </div>
        </div>
      </div>

      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="inline-fields field-row">
          <div>
            <label>CCCD (∆∞u ti√™n)</label>
            <input type="text" id="loginCccd" placeholder="Nh·∫≠p CCCD n·∫øu c√≥" />
          </div>
          <div>
            <label>Email (n·∫øu kh√¥ng d√πng CCCD)</label>
            <input type="email" id="loginEmail" placeholder="Nh·∫≠p Email" />
          </div>
        </div>
        <div class="field-row">
          <label>M·∫≠t kh·∫©u / Password *</label>
          <input type="password" id="loginPass" required />
        </div>

        <button type="submit" class="btn btn-primary">
          <span>üîê ƒêƒÉng nh·∫≠p / Login</span>
        </button>
        <span id="loginStatus" class="status"></span>
      </form>

      <div id="studentInfoBox" class="help-text" style="margin-top:10px; display:none;"></div>
    </div>

    <!-- CARD 2.2 ‚Äì CH·ªåN M√îN & H√åNH TH·ª®C + L√ÄM B√ÄI -->
    <div class="card" id="quizConfigCard" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">
            ‚úÖ C·∫•u h√¨nh b√†i ki·ªÉm tra n·ªôi b·ªô
            <span class="pill">Step 3</span>
          </div>
          <div class="card-subtitle">
            Ch·ªçn m√¥n, h√¨nh th·ª©c ki·ªÉm tra, s·ªë c√¢u h·ªèi v√† th·ªùi gian l√†m b√†i.
          </div>
        </div>
      </div>

      <div class="two-col">
        <!-- C·∫§U H√åNH B√ÄI KI·ªÇM TRA -->
        <div>
          <div class="field-row">
            <label>M√¥n ki·ªÉm tra / Subject *</label>
            <select id="quizSubject">
              <option value="">-- Ch·ªçn m√¥n --</option>
              <option value="To√°n">To√°n</option>
              <option value="L√Ω">L√Ω</option>
              <option value="H√≥a">H√≥a</option>
              <option value="Sinh">Sinh</option>
              <option value="Tin">Tin</option>
              <option value="VƒÉn">VƒÉn</option>
              <option value="S·ª≠">S·ª≠</option>
              <option value="ƒê·ªãa">ƒê·ªãa</option>
              <option value="Ngo·∫°i ng·ªØ">Ngo·∫°i ng·ªØ</option>
              <option value="GD Kinh t·∫ø ph√°p lu·∫≠t">GD Kinh t·∫ø ph√°p lu·∫≠t</option>
              <option value="K·ªπ thu·∫≠t C√¥ng nghi·ªáp">K·ªπ thu·∫≠t C√¥ng nghi·ªáp</option>
              <option value="K·ªπ thu·∫≠t N√¥ng nghi·ªáp">K·ªπ thu·∫≠t N√¥ng nghi·ªáp</option>
            </select>
          </div>

          <div class="inline-fields field-row">
            <div>
              <label>H√¨nh th·ª©c ki·ªÉm tra / Exam type *</label>
              <select id="quizExamType">
                <option value="">-- Ch·ªçn --</option>
                <option value="TX">Ki·ªÉm tra th∆∞·ªùng xuy√™n (TX)</option>
                <option value="GK">Ki·ªÉm tra gi·ªØa k·ª≥ (GK)</option>
                <option value="CK">Ki·ªÉm tra cu·ªëi k·ª≥ (CK)</option>
              </select>
            </div>
            <div>
              <label>S·ªë c√¢u / Number of questions *</label>
              <input type="number" id="quizNumQuestions" min="1" max="100" value="10" />
            </div>
          </div>

          <div class="inline-fields field-row">
            <div>
              <label>Th·ªùi gian (ph√∫t) / Time (minutes) *</label>
              <input type="number" id="quizTimeMinutes" min="1" max="180" value="15" />
            </div>
            <div>
              <label>M√£ ƒë·ªÅ (t·ª± ƒë·ªông n·∫øu b·ªè tr·ªëng)</label>
              <input type="text" id="quizExamCode" placeholder="VD: TIN_TX_01" />
            </div>
          </div>

          <button class="btn btn-primary btn-block" onclick="startInternalQuiz()">
            üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i tr·∫Øc nghi·ªám n·ªôi b·ªô
          </button>
          <div id="quizConfigStatus" class="status"></div>
        </div>

        <!-- TH√îNG TIN B√ÄI THI & TIMER -->
        <div>
          <div class="badge" style="margin-bottom:6px;">
            ‚è± Countdown & random c√¢u h·ªèi tr√™n t·ª´ng m√°y
          </div>
          <p class="muted">
            H·ªá th·ªëng s·∫Ω tr√≠ch <b>ng·∫´u nhi√™n</b> c√°c c√¢u h·ªèi t·ª´ <b>QuestionBank</b> theo s·ªë l∆∞·ª£ng th·∫ßy/c√¥ c·∫•u h√¨nh.
            M·ªói h·ªçc sinh c√≥ ƒë·ªÅ s·∫Øp x·∫øp kh√°c nhau ƒë·ªÉ h·∫°n ch·∫ø trao ƒë·ªïi b√†i.
          </p>
          <p class="muted">
            Sau khi n·ªôp b√†i, h·ªçc sinh ƒë∆∞·ª£c xem l·∫°i c√¢u ƒë√∫ng/sai v√† ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o <b>DiemThi</b>,
            ƒë·ªìng th·ªùi sinh <b>PDF phi·∫øu ƒëi·ªÉm + QR</b> v√† g·ª≠i email (n·∫øu c√≥).
          </p>
        </div>
      </div>

      <!-- V√ôNG L√ÄM B√ÄI TR·∫ÆC NGHI·ªÜM -->
      <div id="quizArea" style="margin-top:10px; display:none;">
        <div class="quiz-header">
          <div class="quiz-header-left" id="quizHeaderInfo"></div>
          <div class="quiz-timer" id="quizTimerBox">
            ‚è± <span id="quizTimerLabel">--:--</span>
          </div>
        </div>

        <div id="quizContainer"></div>

        <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="submitQuiz()" id="btnSubmitQuiz">
            ‚úÖ N·ªôp b√†i
          </button>
          <button class="btn btn-outline btn-sm" onclick="cancelQuiz()">
            ‚ùå H·ªßy b√†i / Tho√°t
          </button>
        </div>

        <div id="quizResultBox" class="quiz-result-box" style="display:none;"></div>
        <div id="quizReview" class="quiz-review" style="display:none;"></div>
      </div>
    </div>

    <!-- CARD 2.3 ‚Äì L·ªäCH S·ª¨ THI N·ªòI B·ªò THEO CCCD -->
    <div class="card" id="historyCard" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">
            üìö L·ªãch s·ª≠ c√°c b√†i ki·ªÉm tra n·ªôi b·ªô
            <span class="pill">History</span>
          </div>
          <div class="card-subtitle">
            Tra c·ª©u k·∫øt qu·∫£ c√°c b√†i l√†m n·ªôi b·ªô (ngu·ªìn Internal) theo CCCD.
          </div>
        </div>
      </div>

      <div class="inline-fields field-row">
        <div>
          <label>M√¥n / Subject (l·ªçc)</label>
          <select id="historySubject">
            <option value="">T·∫•t c·∫£</option>
            <option value="To√°n">To√°n</option>
            <option value="L√Ω">L√Ω</option>
            <option value="H√≥a">H√≥a</option>
            <option value="Sinh">Sinh</option>
            <option value="Tin">Tin</option>
            <option value="VƒÉn">VƒÉn</option>
            <option value="S·ª≠">S·ª≠</option>
            <option value="ƒê·ªãa">ƒê·ªãa</option>
            <option value="Ngo·∫°i ng·ªØ">Ngo·∫°i ng·ªØ</option>
            <option value="GD Kinh t·∫ø ph√°p lu·∫≠t">GD Kinh t·∫ø ph√°p lu·∫≠t</option>
            <option value="K·ªπ thu·∫≠t C√¥ng nghi·ªáp">K·ªπ thu·∫≠t C√¥ng nghi·ªáp</option>
            <option value="K·ªπ thu·∫≠t N√¥ng nghi·ªáp">K·ªπ thu·∫≠t N√¥ng nghi·ªáp</option>
          </select>
        </div>
        <div>
          <label>H√¨nh th·ª©c / Exam type</label>
          <select id="historyExamType">
            <option value="">T·∫•t c·∫£</option>
            <option value="TX">TX</option>
            <option value="GK">GK</option>
            <option value="CK">CK</option>
          </select>
        </div>
      </div>

      <div class="inline-fields field-row">
        <div>
          <label>T·ª´ ng√†y / From date</label>
          <input type="date" id="historyFromDate" />
        </div>
        <div>
          <label>ƒê·∫øn ng√†y / To date</label>
          <input type="date" id="historyToDate" />
        </div>
      </div>

      <button class="btn btn-outline btn-sm" onclick="loadStudentHistory()">
        üîç Xem l·ªãch s·ª≠
      </button>
      <span id="historyStatus" class="status"></span>

      <div id="historyTableBox" style="margin-top:6px;"></div>
    </div>
  </section>

  <!-- =====================================================
       SECTION 3 ‚Äì GVCN / T·ªî M√îN:
       - Dashboard theo l·ªõp (DiemThi)
       - Dashboard theo t·ªï m√¥n (SubjectGroup summary)
       ===================================================== -->
  <section id="section-teacher">
    <!-- CARD 3.1 ‚Äì DASHBOARD L·ªöP / GVCN -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            üë®‚Äçüè´ Dashboard GVCN ‚Äì K·∫øt qu·∫£ theo l·ªõp
          </div>
          <div class="card-subtitle">
            L·ªçc k·∫øt qu·∫£ theo L·ªõp ‚Äì M√¥n ‚Äì H√¨nh th·ª©c ‚Äì Th·ªùi gian, ƒë·ªÉ theo d√µi ti·∫øn ƒë·ªô v√† in phi·∫øu ƒëi·ªÉm.
          </div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="field-row">
            <label>L·ªõp / Class *</label>
            <input type="text" id="gvClassName" placeholder="VD: 12A1" />
          </div>
          <div class="inline-fields field-row">
            <div>
              <label>M√¥n / Subject</label>
              <select id="gvSubject">
                <option value="">T·∫•t c·∫£</option>
                <option value="To√°n">To√°n</option>
                <option value="L√Ω">L√Ω</option>
                <option value="H√≥a">H√≥a</option>
                <option value="Sinh">Sinh</option>
                <option value="Tin">Tin</option>
                <option value="VƒÉn">VƒÉn</option>
                <option value="S·ª≠">S·ª≠</option>
                <option value="ƒê·ªãa">ƒê·ªãa</option>
                <option value="Ngo·∫°i ng·ªØ">Ngo·∫°i ng·ªØ</option>
                <option value="GD Kinh t·∫ø ph√°p lu·∫≠t">GD Kinh t·∫ø ph√°p lu·∫≠t</option>
                <option value="K·ªπ thu·∫≠t C√¥ng nghi·ªáp">K·ªπ thu·∫≠t C√¥ng nghi·ªáp</option>
                <option value="K·ªπ thu·∫≠t N√¥ng nghi·ªáp">K·ªπ thu·∫≠t N√¥ng nghi·ªáp</option>
              </select>
            </div>
            <div>
              <label>H√¨nh th·ª©c / Exam type</label>
              <select id="gvExamType">
                <option value="">T·∫•t c·∫£</option>
                <option value="TX">TX</option>
                <option value="GK">GK</option>
                <option value="CK">CK</option>
              </select>
            </div>
          </div>

          <div class="inline-fields field-row">
            <div>
              <label>T·ª´ ng√†y</label>
              <input type="date" id="gvFromDate" />
            </div>
            <div>
              <label>ƒê·∫øn ng√†y</label>
              <input type="date" id="gvToDate" />
            </div>
          </div>

          <button class="btn btn-outline btn-sm" onclick="loadGvClassResults()">
            üìä Xem k·∫øt qu·∫£ l·ªõp
          </button>
          <span id="gvStatus" class="status"></span>
        </div>

        <div>
          <p class="muted">
            GVCN c√≥ th·ªÉ d√πng b·∫£ng n√†y ƒë·ªÉ:
          </p>
          <ul class="muted" style="padding-left:18px; margin-top:0;">
            <li>Theo d√µi ƒëi·ªÉm t·ª´ng b√†i ki·ªÉm tra.</li>
            <li>Xu·∫•t ra Excel/PDF (qua menu Sheets ho·∫∑c Apps Script b·ªï sung sau).</li>
            <li>Ch·ªçn 1 k·ª≥ (v√≠ d·ª•: gi·ªØa k·ª≥ 1) v√† in phi·∫øu ƒëi·ªÉm c·∫£ l·ªõp.</li>
          </ul>
        </div>
      </div>

      <div id="gvClassTableBox" style="margin-top:6px;"></div>
    </div>

    <!-- CARD 3.2 ‚Äì DASHBOARD T·ªî M√îN / BGH -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            üìà Dashboard T·ªï m√¥n / BGH ‚Äì T·ªïng h·ª£p theo t·ªï
          </div>
          <div class="card-subtitle">
            T·ªïng h·ª£p ƒêTB, t·ªâ l·ªá tr√™n trung b√¨nh theo T·ªï ‚Äì M√¥n ‚Äì Kh·ªëi ‚Äì Th·ªùi gian.
          </div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="field-row">
            <label>T·ªï m√¥n / Subject group</label>
            <select id="sgSubjectGroup">
              <option value="">T·∫•t c·∫£</option>
              <option value="T·ªï To√°n ‚Äì Tin">T·ªï To√°n ‚Äì Tin</option>
              <option value="T·ªï L√Ω ‚Äì CN">T·ªï L√Ω ‚Äì CN</option>
              <option value="T·ªï H√≥a ‚Äì Sinh">T·ªï H√≥a ‚Äì Sinh</option>
              <option value="T·ªï VƒÉn ‚Äì S·ª≠ ‚Äì ƒê·ªãa ‚Äì GDCD">T·ªï VƒÉn ‚Äì S·ª≠ ‚Äì ƒê·ªãa ‚Äì GDCD</option>
              <option value="T·ªï Ngo·∫°i ng·ªØ">T·ªï Ngo·∫°i ng·ªØ</option>
              <option value="Kh√°c">Kh√°c</option>
            </select>
          </div>

          <div class="inline-fields field-row">
            <div>
              <label>M√¥n / Subject</label>
              <select id="sgSubject">
                <option value="">T·∫•t c·∫£</option>
                <option value="To√°n">To√°n</option>
                <option value="Tin">Tin</option>
                <option value="L√Ω">L√Ω</option>
                <option value="H√≥a">H√≥a</option>
                <option value="Sinh">Sinh</option>
                <option value="VƒÉn">VƒÉn</option>
                <option value="S·ª≠">S·ª≠</option>
                <option value="ƒê·ªãa">ƒê·ªãa</option>
                <option value="Ngo·∫°i ng·ªØ">Ngo·∫°i ng·ªØ</option>
                <option value="GD Kinh t·∫ø ph√°p lu·∫≠t">GD Kinh t·∫ø ph√°p lu·∫≠t</option>
                <option value="K·ªπ thu·∫≠t C√¥ng nghi·ªáp">K·ªπ thu·∫≠t C√¥ng nghi·ªáp</option>
                <option value="K·ªπ thu·∫≠t N√¥ng nghi·ªáp">K·ªπ thu·∫≠t N√¥ng nghi·ªáp</option>
              </select>
            </div>
            <div>
              <label>Kh·ªëi / Grade</label>
              <select id="sgGrade">
                <option value="">T·∫•t c·∫£</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
            </div>
          </div>

          <div class="inline-fields field-row">
            <div>
              <label>T·ª´ ng√†y</label>
              <input type="date" id="sgFromDate" />
            </div>
            <div>
              <label>ƒê·∫øn ng√†y</label>
              <input type="date" id="sgToDate" />
            </div>
          </div>

          <button class="btn btn-outline btn-sm" onclick="loadSubjectGroupSummary()">
            üìä Xem t·ªïng h·ª£p t·ªï m√¥n
          </button>
          <span id="sgStatus" class="status"></span>
        </div>

        <div>
          <p class="muted">
            B·∫£ng t·ªïng h·ª£p n√†y ph·ª•c v·ª•:
          </p>
          <ul class="muted" style="padding-left:18px; margin-top:0;">
            <li>H·ªçp t·ªï chuy√™n m√¥n, s∆° k·∫øt, t·ªïng k·∫øt.</li>
            <li>K·∫øt n·ªëi v·ªõi Looker Studio ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.</li>
            <li>ƒê√°nh gi√° xu h∆∞·ªõng ch·∫•t l∆∞·ª£ng theo kh·ªëi, t·ªï, m√¥n.</li>
          </ul>
        </div>
      </div>

      <div id="sgTableBox" style="margin-top:6px;"></div>
    </div>
  </section>

  <!-- =====================================================
       SECTION 4 ‚Äì ADMIN / IMPORT ƒê·ªÄ:
       - Import t·ª´ Word .docx (upload t·ª´ m√°y)
       - Import t·ª´ Google Docs (docId)
       - Xem nhanh th√¥ng tin QuestionBank
       ===================================================== -->
  <section id="section-admin">
    <!-- CARD 4.1 ‚Äì IMPORT ƒê·ªÄ T·ª™ WORD .DOCX -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            üß© Import ƒë·ªÅ t·ª´ Word .docx (m√°y t√≠nh)
          </div>
          <div class="card-subtitle">
            D√πng file Word chu·∫©n (c√≥ b·∫£ng), sau ƒë√≥ upload ‚Üí h·ªá th·ªëng t·ª± ƒë·ªï v√†o sheet QuestionBank.
          </div>
        </div>
      </div>

      <form id="uploadDocxForm" onsubmit="handleUploadDocx(event)">
        <div class="field-row">
          <label>Ch·ªçn file Word (.docx) ch·ª©a ƒë·ªÅ tr·∫Øc nghi·ªám *</label>
          <input type="file" name="docxFile" id="docxFile" accept=".docx" required />
          <div class="help-text">
            M·∫´u file: 1 b·∫£ng, m·ªói d√≤ng 1 c√¢u, g·ªìm c√°c c·ªôt: STT, Code, QuestionVI, QuestionEN, Type,
            A_VI, A_EN, B_VI, B_EN, C_VI, C_EN, D_VI, D_EN, A_Key, B_Key, C_Key, D_Key, ExplanationVI, ExplanationEN.
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-sm">
          ‚¨ÜÔ∏è Upload & Import v√†o QuestionBank
        </button>
        <span id="uploadStatus" class="status"></span>
      </form>
    </div>

    <!-- CARD 4.2 ‚Äì IMPORT ƒê·ªÄ T·ª™ GOOGLE DOCS (docId) -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            üìÑ Import ƒë·ªÅ t·ª´ Google Docs (docId)
          </div>
          <div class="card-subtitle">
            D√πng docId c·ªßa t√†i li·ªáu Google Docs c√≥ b·∫£ng c√πng c·∫•u tr√∫c ƒë·ªÉ import v√†o QuestionBank.
          </div>
        </div>
      </div>

      <div class="field-row">
        <label>ID t√†i li·ªáu Google Docs (docId)</label>
        <input type="text" id="docIdInput" placeholder="V√≠ d·ª•: 1AbCdEFG..." />
      </div>

      <button class="btn btn-outline btn-sm" onclick="handleImportDocId()">
        üì• Import t·ª´ Google Docs ‚Üí QuestionBank
      </button>
      <span id="docImportStatus" class="status"></span>

      <div class="divider"></div>
      <p class="muted">
        Sau khi import, to√†n b·ªô c√¢u h·ªèi ƒë∆∞·ª£c l∆∞u trong sheet <b>QuestionBank</b>, s·∫µn s√†ng cho vi·ªác
        tr√≠ch xu·∫•t ng·∫´u nhi√™n khi h·ªçc sinh l√†m b√†i tr·∫Øc nghi·ªám n·ªôi b·ªô.
      </p>
    </div>
  </section>
</div>

<!-- =========================================================
     SCRIPT ‚Äì TO√ÄN B·ªò LOGIC FRONTEND:
     - Qu·∫£n l√Ω tab
     - ƒêƒÉng nh·∫≠p HS
     - C·∫•u h√¨nh & l√†m b√†i tr·∫Øc nghi·ªám n·ªôi b·ªô
     - Countdown, xem l·∫°i ƒë√°p √°n, l∆∞u ƒëi·ªÉm
     - L·ªãch s·ª≠ HS theo CCCD
     - Dashboard GVCN/T·ªï m√¥n
     - Import ƒê·ªÅ t·ª´ Word/Docs
     ========================================================= -->
<script>
  // ========== TR·∫†NG TH√ÅI TO√ÄN C·ª§C ==========
  let currentStudent = null;         // object student t·ª´ authLogin_
  let currentQuestions = [];         // m·∫£ng c√¢u h·ªèi t·ª´ QuestionBank
  let currentExamInfo = null;        // { subject, examType, examCode, source }
  let quizTimer = null;             // interval countdown
  let quizTimeLeft = 0;             // gi√¢y c√≤n l·∫°i
  let quizFinished = false;         // ƒë√£ n·ªôp b√†i hay ch∆∞a

  // ========== H√ÄM CHUY·ªÇN TAB / SECTION ==========
  function showSection(id, btn) {
    document.querySelectorAll('section').forEach(sec => {
      sec.classList.toggle('active', sec.id === id);
    });
    document.querySelectorAll('.nav-tab-btn').forEach(b => {
      b.classList.toggle('active', b === btn);
    });
  }

  // ========== ƒêƒÇNG NH·∫¨P H·ªåC SINH ==========
  function handleLogin(evt) {
    evt.preventDefault();
    const cccd = document.getElementById('loginCccd').value.trim();
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    const statusEl = document.getElementById('loginStatus');

    if (!cccd && !email) {
      statusEl.textContent = "Vui l√≤ng nh·∫≠p CCCD ho·∫∑c Email.";
      statusEl.className = "status err";
      return;
    }
    if (!pass) {
      statusEl.textContent = "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u.";
      statusEl.className = "status err";
      return;
    }

    statusEl.textContent = "ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p...";
    statusEl.className = "status";

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          statusEl.textContent = res && res.message ? res.message : "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.";
          statusEl.className = "status err";
          currentStudent = null;
          document.getElementById('studentInfoBox').style.display = "none";
          document.getElementById('quizConfigCard').style.display = "none";
          document.getElementById('historyCard').style.display = "none";
          return;
        }
        currentStudent = res.student;
        statusEl.textContent = res.message || "ƒêƒÉng nh·∫≠p th√†nh c√¥ng.";
        statusEl.className = "status ok";

        const box = document.getElementById('studentInfoBox');
        box.style.display = "block";
        box.innerHTML =
          "<b>H·ªçc sinh:</b> " + (currentStudent.name || "") +
          " ‚Äì L·ªõp: " + (currentStudent.className || "") +
          " ‚Äì Kh·ªëi: " + (currentStudent.grade || "") +
          "<br><b>CCCD:</b> " + (currentStudent.cccd || "") +
          " ‚Äì Tr∆∞·ªùng: " + (currentStudent.school || "") +
          "<br><span class='muted'>Sau khi c·∫•u h√¨nh, h·ªçc sinh c√≥ th·ªÉ l√†m b√†i tr·∫Øc nghi·ªám n·ªôi b·ªô v√† xem l·ªãch s·ª≠.</span>";

        document.getElementById('quizConfigCard').style.display = "block";
        document.getElementById('historyCard').style.display = "block";
      })
      .authLogin_({
        cccd: cccd,
        email: email,
        pass: pass
      });
  }

  // ========== B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI N·ªòI B·ªò ==========
  function startInternalQuiz() {
    if (!currentStudent) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi l√†m b√†i.");
      return;
    }
    const subject = document.getElementById('quizSubject').value;
    const examType = document.getElementById('quizExamType').value;
    const numQ = parseInt(document.getElementById('quizNumQuestions').value, 10);
    const timeMin = parseInt(document.getElementById('quizTimeMinutes').value, 10);
    let examCode = document.getElementById('quizExamCode').value.trim();
    const statusEl = document.getElementById('quizConfigStatus');

    if (!subject) {
      statusEl.textContent = "Vui l√≤ng ch·ªçn m√¥n.";
      statusEl.className = "status err";
      return;
    }
    if (!examType) {
      statusEl.textContent = "Vui l√≤ng ch·ªçn h√¨nh th·ª©c ki·ªÉm tra.";
      statusEl.className = "status err";
      return;
    }
    if (!numQ || numQ <= 0) {
      statusEl.textContent = "S·ªë c√¢u h·ªèi kh√¥ng h·ª£p l·ªá.";
      statusEl.className = "status err";
      return;
    }
    if (!timeMin || timeMin <= 0) {
      statusEl.textContent = "Th·ªùi gian l√†m b√†i kh√¥ng h·ª£p l·ªá.";
      statusEl.className = "status err";
      return;
    }
    if (!examCode) {
      const now = new Date();
      const stamp = now.getFullYear() + "" + String(now.getMonth()+1).padStart(2,"0") + "" + String(now.getDate()).padStart(2,"0");
      examCode = subject.toUpperCase().substring(0,3) + "_" + examType + "_" + stamp;
    }

    statusEl.textContent = "ƒêang tr√≠ch xu·∫•t c√¢u h·ªèi ng·∫´u nhi√™n t·ª´ QuestionBank...";
    statusEl.className = "status";

    currentExamInfo = {
      subject: subject,
      examType: examType,
      examCode: examCode,
      source: "Internal"
    };

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok || !res.questions || res.questions.length === 0) {
          statusEl.textContent = res && res.message ? res.message : "Kh√¥ng l·∫•y ƒë∆∞·ª£c c√¢u h·ªèi.";
          statusEl.className = "status err";
          return;
        }
        currentQuestions = res.questions;
        statusEl.textContent = "ƒê√£ t·∫£i " + currentQuestions.length + " c√¢u h·ªèi. B·∫Øt ƒë·∫ßu l√†m b√†i.";
        statusEl.className = "status ok";

        renderQuizUI(timeMin);
      })
      .getQuestionBank_({
        limit: numQ
        // n·∫øu sau n√†y mu·ªën ph√¢n lo·∫°i theo Type th√¨ truy·ªÅn filterType th√™m v√†o ƒë√¢y
      });
  }

  // ========== RENDER GIAO DI·ªÜN L√ÄM B√ÄI + COUNTDOWN ==========
  function renderQuizUI(timeMin) {
    const quizArea = document.getElementById('quizArea');
    const container = document.getElementById('quizContainer');
    const headerInfo = document.getElementById('quizHeaderInfo');
    const timerLabel = document.getElementById('quizTimerLabel');

    quizFinished = false;
    container.innerHTML = "";
    document.getElementById('quizResultBox').style.display = "none";
    document.getElementById('quizReview').style.display = "none";

    // Header th√¥ng tin b√†i
    headerInfo.innerHTML =
      "<b>M√¥n:</b> " + (currentExamInfo.subject || "") +
      " ‚Ä¢ <b>H√¨nh th·ª©c:</b> " + (currentExamInfo.examType || "") +
      " ‚Ä¢ <b>M√£ ƒë·ªÅ:</b> " + (currentExamInfo.examCode || "") +
      " ‚Ä¢ <b>S·ªë c√¢u:</b> " + currentQuestions.length;

    // V·∫Ω t·ª´ng c√¢u
    currentQuestions.forEach((q, idx) => {
      const qDiv = document.createElement('div');
      qDiv.className = "quiz-question";

      const qNum = idx + 1;
      const txt = q.qVI || q.qEN || ("C√¢u " + qNum);

      qDiv.innerHTML = `
        <h4>C√¢u ${qNum}. ${escapeHtmlClient(txt)}</h4>
        <div class="quiz-options">
          ${renderOptionRow("A", q.A)}
          ${renderOptionRow("B", q.B)}
          ${renderOptionRow("C", q.C)}
          ${renderOptionRow("D", q.D)}
        </div>
      `;
      // th√™m data ƒë·ªÉ review sau
      qDiv.dataset.index = idx;
      container.appendChild(qDiv);
    });

    quizArea.style.display = "block";

    // COUNTDOWN
    if (quizTimer) clearInterval(quizTimer);
    quizTimeLeft = timeMin * 60;
    updateTimerLabel(timerLabel);
    quizTimer = setInterval(() => {
      quizTimeLeft--;
      if (quizTimeLeft <= 0) {
        clearInterval(quizTimer);
        quizTimeLeft = 0;
        updateTimerLabel(timerLabel);
        if (!quizFinished) {
          alert("H·∫øt th·ªùi gian, h·ªá th·ªëng t·ª± ƒë·ªông n·ªôp b√†i.");
          submitQuiz();
        }
        return;
      }
      updateTimerLabel(timerLabel);
    }, 1000);
  }

  function renderOptionRow(letter, opt) {
    if (!opt) opt = {};
    const text = opt.vi || opt.en || "";
    if (!text) return "";
    const name = "q_" + letter + "_" + Math.random().toString(36).substring(2,6); // tr√°nh tr√πng? ta d√πng name theo c√¢u, value = letter
    // Ta override name sau: ƒë·∫∑t name theo q index, value = letter
    // ·ªû ƒë√¢y ch·ªâ render, sau s·∫Ω replace qua DOM; ƒë·ªÉ ƒë∆°n gi·∫£n, khai name = "q{index}"
    return `
      <label class="option-row">
        <input type="radio" name="__TEMP__" value="${letter}" />
        <span><b>${letter}.</b> ${escapeHtmlClient(text)}</span>
      </label>
    `;
  }

  // Sau khi th√™m v√†o DOM, ta s·∫Ω s·ª≠a l·∫°i name cho ƒë√∫ng theo t·ª´ng c√¢u
  // (ƒë·ªÉ d·ªÖ ƒë·ªçc, ta x·ª≠ l√Ω ngay trong renderQuizUI sau khi innerHTML xong)
  // => B·ªï sung: sau khi container innerHTML xong, s·ª≠a name:
  // Nh∆∞ng hi·ªán t·∫°i ta ƒë√£ inject t·ª´ng qDiv ri√™ng n√™n ta s·∫Ω s·ª≠a tr·ª±c ti·∫øp b·∫±ng JS
  // (ƒê·ªÉ ƒë∆°n gi·∫£n, ta l√†m theo c√°ch: sau forEach, duy·ªát l·∫°i container.)

  // Do ƒë√≥, ta override renderQuizUI m·ªôt ch√∫t: sau khi t·∫°o t·∫•t c·∫£ c√¢u, ta s·ª≠a l·∫°i name: "q_idx"
  // (ƒê√£ vi·∫øt xong renderQuizUI, n√™n th√™m kh√∫c d∆∞·ªõi c√πng.)

  // Ch·ªânh s·ª≠a renderQuizUI cho ƒë√∫ng name
  // (Ta ƒë·∫∑t h√†m ri√™ng, g·ªçi ·ªü cu·ªëi renderQuizUI)
  function fixQuizOptionNames() {
    const container = document.getElementById('quizContainer');
    const qBlocks = container.querySelectorAll('.quiz-question');
    qBlocks.forEach((block, idx) => {
      const radios = block.querySelectorAll('input[type="radio"]');
      radios.forEach(r => {
        r.name = "q_" + idx;
      });
    });
  }

  function updateTimerLabel(el) {
    const m = Math.floor(quizTimeLeft / 60);
    const s = quizTimeLeft % 60;
    el.textContent = String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
  }

  // G·ªçi fixQuizOptionNames sau khi render xong UI (override renderQuizUI c≈©)
  const _oldRenderQuizUI = renderQuizUI;
  renderQuizUI = function(timeMin) {
    _oldRenderQuizUI(timeMin);
    fixQuizOptionNames();
  };

  // ========== N·ªòP B√ÄI & CH·∫§M ƒêI·ªÇM ==========
  function submitQuiz() {
    if (!currentQuestions || currentQuestions.length === 0) {
      alert("Ch∆∞a c√≥ c√¢u h·ªèi.");
      return;
    }
    if (quizFinished) {
      alert("B√†i ƒë√£ ƒë∆∞·ª£c n·ªôp.");
      return;
    }

    quizFinished = true;
    if (quizTimer) clearInterval(quizTimer);

    const container = document.getElementById('quizContainer');
    const qBlocks = container.querySelectorAll('.quiz-question');

    let correctCount = 0;
    let total = currentQuestions.length;
    const reviewItems = [];

    qBlocks.forEach((block, idx) => {
      const q = currentQuestions[idx];
      const name = "q_" + idx;
      const chosen = (container.querySelector('input[name="' + name + '"]:checked') || {}).value || "";

      // x√°c ƒë·ªãnh ƒë√°p √°n ƒë√∫ng t·ª´ key
      const keys = {
        A: q.A && q.A.key,
        B: q.B && q.B.key,
        C: q.C && q.C.key,
        D: q.D && q.D.key
      };
      let correctLetter = "";
      ["A","B","C","D"].forEach(l => {
        if (!correctLetter && keys[l]) correctLetter = l;
      });

      const isCorrect = chosen && correctLetter && (chosen === correctLetter);
      if (isCorrect) correctCount++;

      const qText = q.qVI || q.qEN || ("C√¢u " + (idx+1));

      reviewItems.push({
        index: idx+1,
        text: qText,
        chosen: chosen || "(kh√¥ng ch·ªçn)",
        correct: correctLetter || "(ch∆∞a thi·∫øt l·∫≠p key)",
        isCorrect: isCorrect
      });
    });

    const score10 = total > 0 ? (correctCount * 10.0 / total) : 0;
    const resultBox = document.getElementById('quizResultBox');
    resultBox.style.display = "block";
    resultBox.innerHTML =
      "<strong>K·∫øt qu·∫£:</strong> " +
      correctCount + "/" + total +
      " c√¢u ƒë√∫ng, ƒëi·ªÉm = <b>" + score10.toFixed(2) + "/10</b>" +
      "<br><span class='muted'>ƒêi·ªÉm ƒë√£ ƒë∆∞·ª£c g·ª≠i l√™n h·ªá th·ªëng, vui l√≤ng ch·ªù phi·∫øu ƒëi·ªÉm PDF.</span>";

    // Render xem l·∫°i ƒë√°p √°n
    const reviewBox = document.getElementById('quizReview');
    reviewBox.style.display = "block";
    reviewBox.innerHTML = "<div class='muted'>Xem l·∫°i ƒë√°p √°n t·ª´ng c√¢u:</div>";

    reviewItems.forEach(item => {
      const div = document.createElement('div');
      div.className = "review-item " + (item.isCorrect ? "correct" : "incorrect");
      div.innerHTML =
        "<div class='q-text'>C√¢u " + item.index + ". " + escapeHtmlClient(item.text) + "</div>" +
        "<div class='ans-line'>Ch·ªçn: <b>" + escapeHtmlClient(item.chosen) +
        "</b> ‚Ä¢ ƒê√°p √°n ƒë√∫ng: <b>" + escapeHtmlClient(item.correct) + "</b></div>";
      reviewBox.appendChild(div);
    });

    // G·ª≠i k·∫øt qu·∫£ l√™n server (saveInternalResult_)
    if (!currentStudent || !currentExamInfo) {
      console.log("Kh√¥ng c√≥ student ho·∫∑c examInfo, b·ªè qua saveInternalResult_.");
      return;
    }

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          resultBox.innerHTML += "<br><span class='status err'>L∆∞u k·∫øt qu·∫£ l√™n h·ªá th·ªëng b·ªã l·ªói: " +
            (res && res.message ? res.message : "Kh√¥ng r√µ l·ªói") + "</span>";
          return;
        }
        if (res.pdfUrl) {
          resultBox.innerHTML +=
            "<br><span class='status ok'>ƒê√£ t·∫°o phi·∫øu ƒëi·ªÉm PDF. </span>" +
            "<a class='link' href='" + res.pdfUrl + "' target='_blank'>Xem phi·∫øu ƒëi·ªÉm</a>";
        } else {
          resultBox.innerHTML +=
            "<br><span class='status ok'>ƒê√£ l∆∞u k·∫øt qu·∫£. PDF ƒëang ƒë∆∞·ª£c h·ªá th·ªëng x·ª≠ l√Ω.</span>";
        }
      })
      .saveInternalResult_(currentStudent, currentExamInfo, {
        totalQuestions: total,
        correctCount: correctCount,
        score10: score10
      });
  }

  function cancelQuiz() {
    if (quizTimer) clearInterval(quizTimer);
    quizFinished = false;
    document.getElementById('quizArea').style.display = "none";
    document.getElementById('quizContainer').innerHTML = "";
    document.getElementById('quizResultBox').style.display = "none";
    document.getElementById('quizReview').style.display = "none";
  }

  // ========== L·ªäCH S·ª¨ HS (apiGetStudentHistory) ==========
  function loadStudentHistory() {
    if (!currentStudent || !currentStudent.cccd) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠.");
      return;
    }
    const cccd = currentStudent.cccd;
    const subject = document.getElementById('historySubject').value;
    const examType = document.getElementById('historyExamType').value;
    const fromDate = document.getElementById('historyFromDate').value;
    const toDate = document.getElementById('historyToDate').value;

    const statusEl = document.getElementById('historyStatus');
    const box = document.getElementById('historyTableBox');
    box.innerHTML = "";
    statusEl.textContent = "ƒêang t·∫£i l·ªãch s·ª≠...";
    statusEl.className = "status";

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          statusEl.textContent = res && res.message ? res.message : "Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠.";
          statusEl.className = "status err";
          return;
        }
        statusEl.textContent = res.message || "";
        statusEl.className = "status ok";
        renderHistoryTable(box, res.items || []);
      })
      .apiGetStudentHistory({
        cccd: cccd,
        subject: subject,
        examType: examType,
        fromDate: fromDate,
        toDate: toDate
      });
  }

  function renderHistoryTable(container, items) {
    if (!items || items.length === 0) {
      container.innerHTML = "<div class='muted'>Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ ph√π h·ª£p v·ªõi b·ªô l·ªçc.</div>";
      return;
    }
    let html = "<table><thead><tr>" +
      "<th>Th·ªùi gian</th><th>M√¥n</th><th>H√¨nh th·ª©c</th><th>L·ªõp</th><th>Kh·ªëi</th><th>ƒêi·ªÉm</th><th>PDF</th>" +
      "</tr></thead><tbody>";
    items.forEach(item => {
      const dtStr = formatDateTime(item.dateTime);
      const linkPdf = item.pdfUrl
        ? "<a class='link' href='" + item.pdfUrl + "' target='_blank'>Xem PDF</a>"
        : "<span class='muted'>Ch∆∞a c√≥</span>";
      html += "<tr>" +
        "<td>" + dtStr + "</td>" +
        "<td>" + escapeHtmlClient(item.subject || "") + "</td>" +
        "<td>" + escapeHtmlClient(item.examType || "") + "</td>" +
        "<td>" + escapeHtmlClient(item.className || "") + "</td>" +
        "<td>" + escapeHtmlClient(item.grade || "") + "</td>" +
        "<td>" + (item.score10 != null ? Number(item.score10).toFixed(2) : "") + "</td>" +
        "<td>" + linkPdf + "</td>" +
        "</tr>";
    });
    html += "</tbody></table>";
    container.innerHTML = html;
  }

  // ========== DASHBOARD L·ªöP ‚Äì GVCN (apiClassResults) ==========
  function loadGvClassResults() {
    const className = document.getElementById('gvClassName').value.trim();
    const subject = document.getElementById('gvSubject').value;
    const examType = document.getElementById('gvExamType').value;
    const fromDate = document.getElementById('gvFromDate').value;
    const toDate = document.getElementById('gvToDate').value;

    const statusEl = document.getElementById('gvStatus');
    const box = document.getElementById('gvClassTableBox');
    box.innerHTML = "";

    if (!className) {
      statusEl.textContent = "Vui l√≤ng nh·∫≠p t√™n l·ªõp (VD: 12A1).";
      statusEl.className = "status err";
      return;
    }

    statusEl.textContent = "ƒêang t·∫£i d·ªØ li·ªáu l·ªõp...";
    statusEl.className = "status";

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          statusEl.textContent = res && res.message ? res.message : "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu l·ªõp.";
          statusEl.className = "status err";
          return;
        }
        statusEl.textContent = res.message || "";
        statusEl.className = "status ok";
        renderGvClassTable(box, res.items || []);
      })
      .apiClassResults({
        className: className,
        subject: subject,
        examType: examType,
        fromDate: fromDate,
        toDate: toDate
      });
  }

  function renderGvClassTable(container, items) {
    if (!items || items.length === 0) {
      container.innerHTML = "<div class='muted'>Ch∆∞a c√≥ d·ªØ li·ªáu ph√π h·ª£p.</div>";
      return;
    }
    let html = "<table><thead><tr>" +
      "<th>Th·ªùi gian</th><th>H·ªçc sinh</th><th>M√¥n</th><th>H√¨nh th·ª©c</th><th>M√£ ƒë·ªÅ</th><th>ƒêi·ªÉm</th><th>PDF</th>" +
      "</tr></thead><tbody>";

    items.forEach(item => {
      const dtStr = formatDateTime(item.dateTime);
      const pdf = item.pdfUrl
        ? "<a class='link' href='" + item.pdfUrl + "' target='_blank'>Xem PDF</a>"
        : "<span class='muted'>-</span>";
      html += "<tr>" +
        "<td>" + dtStr + "</td>" +
        "<td>" + escapeHtmlClient(item.name || "") + "</td>" +
        "<td>" + escapeHtmlClient(item.subject || "") + "</td>" +
        "<td>" + escapeHtmlClient(item.examType || "") + "</td>" +
        "<td>" + escapeHtmlClient(item.examCode || "") + "</td>" +
        "<td>" + (item.score10 != null ? Number(item.score10).toFixed(2) : "") + "</td>" +
        "<td>" + pdf + "</td>" +
        "</tr>";
    });

    html += "</tbody></table>";
    container.innerHTML = html;
  }

  // ========== DASHBOARD T·ªî M√îN / BGH (apiSubjectGroupSummary) ==========
  function loadSubjectGroupSummary() {
    const subjectGroup = document.getElementById('sgSubjectGroup').value;
    const subject = document.getElementById('sgSubject').value;
    const grade = document.getElementById('sgGrade').value;
    const fromDate = document.getElementById('sgFromDate').value;
    const toDate = document.getElementById('sgToDate').value;

    const statusEl = document.getElementById('sgStatus');
    const box = document.getElementById('sgTableBox');
    box.innerHTML = "";

    statusEl.textContent = "ƒêang t·ªïng h·ª£p b√°o c√°o t·ªï m√¥n...";
    statusEl.className = "status";

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          statusEl.textContent = res && res.message ? res.message : "Kh√¥ng t·ªïng h·ª£p ƒë∆∞·ª£c.";
          statusEl.className = "status err";
          return;
        }
        statusEl.textContent = res.message || "";
        statusEl.className = "status ok";
        renderSubjectGroupTable(box, res.items || []);
      })
      .apiSubjectGroupSummary({
        subjectGroup: subjectGroup,
        subject: subject,
        grade: grade,
        fromDate: fromDate,
        toDate: toDate
      });
  }

  function renderSubjectGroupTable(container, items) {
    if (!items || items.length === 0) {
      container.innerHTML = "<div class='muted'>Ch∆∞a c√≥ d·ªØ li·ªáu ph√π h·ª£p.</div>";
      return;
    }

    let html = "<table><thead><tr>" +
      "<th>T·ªï m√¥n</th><th>M√¥n</th><th>Kh·ªëi</th><th>S·ªë l∆∞·ª£t</th><th>ƒêTB</th><th>% ‚â• 5.0</th><th>Min</th><th>Max</th>" +
      "</tr></thead><tbody>";

    items.forEach(it => {
      html += "<tr>" +
        "<td>" + escapeHtmlClient(it.subjectGroup || "") + "</td>" +
        "<td>" + escapeHtmlClient(it.subject || "") + "</td>" +
        "<td>" + escapeHtmlClient(it.grade || "") + "</td>" +
        "<td>" + (it.count != null ? it.count : "") + "</td>" +
        "<td>" + (it.avgScore != null ? Number(it.avgScore).toFixed(2) : "") + "</td>" +
        "<td>" + (it.passRate != null ? Number(it.passRate).toFixed(1) + "%" : "") + "</td>" +
        "<td>" + (it.minScore != null ? Number(it.minScore).toFixed(2) : "") + "</td>" +
        "<td>" + (it.maxScore != null ? Number(it.maxScore).toFixed(2) : "") + "</td>" +
        "</tr>";
    });

    html += "</tbody></table>";
    container.innerHTML = html;
  }

  // ========== IMPORT ƒê·ªÄ T·ª™ WORD (importQuestionsFromUpload) ==========
  function handleUploadDocx(evt) {
    evt.preventDefault();
    const form = document.getElementById('uploadDocxForm');
    const statusEl = document.getElementById('uploadStatus');
    statusEl.textContent = "ƒêang upload & import...";
    statusEl.className = "status";

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          statusEl.textContent = res && res.message ? res.message : "Import th·∫•t b·∫°i.";
          statusEl.className = "status err";
          return;
        }
        statusEl.textContent = res.message || ("ƒê√£ import " + res.imported + " c√¢u h·ªèi.");
        statusEl.className = "status ok";
        form.reset();
      })
      .importQuestionsFromUpload(form);
  }

  // ========== IMPORT ƒê·ªÄ T·ª™ GOOGLE DOCS (importQuestionsFromGoogleDoc_) ==========
  function handleImportDocId() {
    const docId = document.getElementById('docIdInput').value.trim();
    const statusEl = document.getElementById('docImportStatus');
    if (!docId) {
      statusEl.textContent = "Vui l√≤ng nh·∫≠p docId.";
      statusEl.className = "status err";
      return;
    }
    statusEl.textContent = "ƒêang import t·ª´ Google Docs...";
    statusEl.className = "status";

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          statusEl.textContent = res && res.message ? res.message : "Import th·∫•t b·∫°i.";
          statusEl.className = "status err";
          return;
        }
        statusEl.textContent = res.message || ("ƒê√£ import " + res.imported + " c√¢u h·ªèi.");
        statusEl.className = "status ok";
      })
      .importQuestionsFromGoogleDoc_(docId);
  }

  // ========== H√ÄM TI·ªÜN √çCH JS ==========
  function escapeHtmlClient(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function formatDateTime(dt) {
    if (!dt) return "";
    try {
      // Khi server tr·∫£ v·ªÅ, dt c√≥ th·ªÉ l√† string ho·∫∑c Date (Apps Script t·ª± convert)
      if (typeof dt === "string") {
        const d = new Date(dt);
        if (!isNaN(d.getTime())) dt = d;
      }
      if (dt instanceof Date) {
        const d = dt;
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return dd + "/" + mm + "/" + yyyy + " " + hh + ":" + mi;
      }
      return String(dt);
    } catch(e) {
      return String(dt);
    }
  }
</script>
</body>
</html>
