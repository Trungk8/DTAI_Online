<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DTAI_Online ‚Äì H·ªá th·ªëng ki·ªÉm tra & ƒë√°nh gi√° tr·ª±c tuy·∫øn</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #020617;
      --card: #020617;
      --primary: #2563eb;
      --primary-soft: rgba(37,99,235,0.14);
      --accent: #fbbf24;
      --accent-soft: rgba(251,191,36,0.18);
      --border-subtle: rgba(148,163,184,0.35);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #dc2626;
      --danger-soft: rgba(220,38,38,0.14);
      --radius-lg: 20px;
      --radius-pill: 999px;
      --shadow-soft: 0 32px 60px rgba(15,23,42,0.65);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.12), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(251,191,36,0.1), transparent 55%),
                  #020617;
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 18px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header.app-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
    }

    .logo-circle {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #4f46e5, #0f172a 60%);
      border: 2px solid rgba(191,219,254,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 18px 40px rgba(37,99,235,0.65);
      overflow: hidden;
    }

    .logo-inner {
      width: 80%;
      height: 80%;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      line-height: 1.25;
      color: #e5e7eb;
      background: radial-gradient(circle at top, #22c55e, #0f172a);
      padding: 4px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(37,99,235,0.18);
      color: #bfdbfe;
      border: 1px solid rgba(59,130,246,0.6);
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    @media (max-width: 680px) {
      header.app-header {
        align-items: flex-start;
      }
      .title-block h1 {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .nav-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .nav-btn {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,0.45);
      padding: 6px 12px;
      background: rgba(15,23,42,0.72);
      color: var(--text-soft);
      font-size: 0.82rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.18s ease-out;
    }

    .nav-btn span.icon {
      font-size: 1rem;
    }

    .nav-btn.active {
      background: linear-gradient(135deg,#2563eb,#4f46e5);
      color: #f9fafb;
      border-color: transparent;
      box-shadow: 0 14px 30px rgba(37,99,235,0.6);
    }

    .nav-btn:hover:not(.active) {
      border-color: rgba(129,140,248,0.8);
      color: #e5e7eb;
      background: rgba(15,23,42,0.94);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0,1.35fr) minmax(0,1fr);
      gap: 16px;
    }

    @media (max-width: 880px) {
      main {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .left-pane, .right-pane {
      border-radius: 18px;
    }

    .left-pane {
      background: linear-gradient(160deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border: 1px solid rgba(148,163,184,0.35);
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .right-pane {
      background: radial-gradient(circle at top,rgba(37,99,235,0.32),transparent 58%),
                  linear-gradient(145deg,#020617,#020617);
      border: 1px solid rgba(55,65,81,0.7);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .section-title {
      margin: 0;
      font-size: 1.02rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .section-desc {
      margin: 4px 0 10px;
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    .page {
      display: none;
    }
    .page.active {
      display: block;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-row {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 10px;
    }

    @media (max-width: 720px) {
      .field-row {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.8rem;
      color: #cbd5f5;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .field small {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 11px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.92);
      color: #e5e7eb;
      padding: 7px 10px;
      font-size: 0.84rem;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
      min-height: 33px;
    }

    .field textarea {
      resize: vertical;
      min-height: 70px;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(148,163,184,0.9);
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: rgba(59,130,246,0.9);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.9);
      background: rgba(15,23,42,0.98);
    }

    .dob-row {
      display: grid;
      grid-template-columns: 0.9fr 0.9fr 1.2fr;
      gap: 6px;
    }

    .badge-required {
      color: #f97373;
      font-weight: 600;
    }

    .btn-primary,
    .btn-ghost,
    .btn-small {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.84rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 16px;
      transition: all 0.18s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#4f46e5);
      color: #f9fafb;
      box-shadow: 0 16px 34px rgba(37,99,235,0.7);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 40px rgba(37,99,235,0.8);
    }

    .btn-ghost {
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
      padding-inline: 14px;
    }
    .btn-ghost:hover {
      background: rgba(15,23,42,0.98);
      border-color: rgba(59,130,246,0.8);
    }

    .btn-small {
      background: rgba(15,23,42,0.9);
      color: var(--text-soft);
      padding: 4px 10px;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
    }
    .btn-small:hover {
      background: rgba(15,23,42,0.98);
      color: #e5e7eb;
      border-color: rgba(59,130,246,0.9);
    }

    .btn-primary .icon,
    .btn-ghost .icon,
    .btn-small .icon {
      font-size: 1rem;
    }

    .note-small {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .login-status {
      font-size: 0.8rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .login-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #16a34a;
      box-shadow: 0 0 0 4px rgba(22,163,74,0.35);
    }
    .login-dot.off {
      background: #6b7280;
      box-shadow: none;
    }

    .right-pane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(110px,1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-card {
      background: rgba(15,23,42,0.92);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.45);
      padding: 8px 10px;
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .stat-card .label {
      color: var(--text-soft);
    }
    .stat-card .value {
      font-size: 1rem;
      font-weight: 600;
      color: #e5e7eb;
    }
    .stat-card .sub {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .table-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.9);
      max-height: 260px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .table-wrapper header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .table-scroll {
      overflow: auto;
      font-size: 0.8rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 420px;
    }
    th, td {
      padding: 4px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }
    th {
      text-align: left;
      font-weight: 500;
      font-size: 0.78rem;
      color: var(--text-soft);
      background: rgba(15,23,42,0.96);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: rgba(15,23,42,0.96);
    }

    .card-mini {
      background: rgba(15,23,42,0.92);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.55);
      padding: 8px 10px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .card-mini h3 {
      margin: 0 0 2px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .card-mini .sub {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .exam-warning {
      color: #fbbf24;
      font-weight: 600;
    }

    .pill-tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      gap: 4px;
    }

    .pill-tag span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .search-row {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,0.9fr) minmax(0,0.8fr);
      gap: 6px;
      margin-top: 6px;
    }

    @media (max-width: 720px) {
      .search-row {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .pill-soft {
      font-size: 0.74rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
    }

    .result-card {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.9);
      padding: 8px 10px;
      font-size: 0.78rem;
      margin-top: 6px;
    }

    .result-card h4 {
      margin: 0 0 4px;
      font-size: 0.86rem;
      color: #e5e7eb;
    }

    .result-card .meta {
      font-size: 0.76rem;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="app-header">
    <div class="logo-circle">
      <!-- TH·∫¶Y C√ì LOGO TH·∫¨T TH√å THAY block sau b·∫±ng <img src="LINK_LOGO" style="width:100%;height:100%;border-radius:999px;object-fit:cover;"> -->
      <div class="logo-inner">
        THPT<br>NGUY·ªÑN<br>ƒê√åNH CHI·ªÇU
      </div>
    </div>
    <div class="title-block">
      <h1>
        DTAI_Online
        <span class="title-badge">SK ‚Äì H·ªá th·ªëng ki·ªÉm tra &amp; ƒë√°nh gi√° Online</span>
      </h1>
      <p>Qu·∫£n l√Ω ƒëƒÉng k√Ω ‚Äì ca thi ‚Äì Dashboard ‚Äì tra c·ª©u k·∫øt qu·∫£ theo SK ki·ªÉm tra, thi Online.</p>
      <div class="nav-tabs">
        <button class="nav-btn active" data-target="register">
          <span class="icon">üìù</span><span>ƒêƒÉng k√Ω th√¥ng tin</span>
        </button>
        <button class="nav-btn" data-target="login">
          <span class="icon">üîê</span><span>ƒêƒÉng nh·∫≠p (ACCESS_CODE)</span>
        </button>
        <button class="nav-btn" data-target="exam">
          <span class="icon">üß™</span><span>V√†o ca thi</span>
        </button>
        <button class="nav-btn" data-target="dashboard">
          <span class="icon">üìä</span><span>Dashboard ƒëi·ªÉm</span>
        </button>
        <button class="nav-btn" data-target="lookup">
          <span class="icon">üìÑ</span><span>Xem k·∫øt qu·∫£</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: FORM PAGES -->
    <div class="left-pane">
      <!-- 1. ƒêƒÇNG K√ù -->
      <section id="register" class="page active">
        <h2 class="section-title">ƒêƒÉng k√Ω th√¥ng tin th√≠ sinh</h2>
        <p class="section-desc">
          ƒêi·ªÅn ch√≠nh x√°c c√°c th√¥ng tin b√™n d∆∞·ªõi. H·ªá th·ªëng s·∫Ω g·ª≠i email x√°c nh·∫≠n k√®m m·∫≠t kh·∫©u
          <b>ACCESS_CODE</b> ƒë·ªÉ ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi v√†o thi v√† xem k·∫øt qu·∫£.
        </p>

        <form id="regForm"
              method="POST"
              action="https://script.google.com/macros/s/AKfycbxIRwnJhmX8lqY78QYpGiXXCYtWfCBrGVNZUoyJvhgJ0Ej6cYooLL-pVZPGJmOXKtY2/exec"
              onsubmit="return handleRegisterSubmit(event)">
          <!-- H·ªç v√† t√™n -->
          <div class="field">
            <label>
              <span>H·ªç v√† t√™n</span>
              <span class="badge-required">(*) IN HOA t·ª± ƒë·ªông</span>
            </label>
            <input type="text" name="hoten" id="hoten" required
                   placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" autocomplete="name" />
            <small>Nh·∫≠p b√¨nh th∆∞·ªùng, h·ªá th·ªëng s·∫Ω t·ª± chuy·ªÉn th√†nh CH·ªÆ IN HOA khi l∆∞u.</small>
          </div>

          <!-- Ng√†y sinh + Gi·ªõi t√≠nh -->
          <div class="field-row">
            <div class="field">
              <label><span>Ng√†y sinh</span><span class="badge-required">(*)</span></label>
              <div class="dob-row">
                <select id="dobDay"></select>
                <select id="dobMonth"></select>
                <select id="dobYear"></select>
              </div>
              <input type="hidden" name="ngaysinh" id="ngaysinh" />
              <small>Ch·ªçn l·∫ßn l∆∞·ª£t <b>Ng√†y ‚Äì Th√°ng ‚Äì NƒÉm</b>. H·ªá th·ªëng t·ª± gh√©p theo d·∫°ng dd/mm/yyyy.</small>
            </div>
            <div class="field">
              <label><span>Gi·ªõi t√≠nh</span><span class="badge-required">(*)</span></label>
              <select name="gioitinh" id="gioitinh" required>
                <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
          </div>

          <!-- D√¢n t·ªôc + Tr∆∞·ªùng -->
          <div class="field-row">
            <div class="field">
              <label><span>D√¢n t·ªôc</span><span class="badge-required">(*)</span></label>
              <select name="dantoc" id="dantoc" required>
                <option value="">-- Ch·ªçn d√¢n t·ªôc --</option>
                <option value="Kinh">Kinh</option>
                <option value="M'N√¥ng">M'N√¥ng</option>
                <option value="√äƒë√™">√äƒë√™</option>
                <option value="N√πng">N√πng</option>
                <option value="T√†y">T√†y</option>
                <option value="Th√°i">Th√°i</option>
                <option value="Hoa">Hoa</option>
                <option value="Khmer">Khmer</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
              <small>Ch·ªçn ƒë√∫ng theo gi·∫•y khai sinh.</small>
            </div>
            <div class="field">
              <label><span>Tr∆∞·ªùng THPT</span><span class="badge-required">(*)</span></label>
              <select name="truong" id="truong" required>
                <option value="">-- Ch·ªçn tr∆∞·ªùng --</option>
                <option value="THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu">THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
                <option value="THPT Ph·∫°m VƒÉn ƒê·ªìng">THPT Ph·∫°m VƒÉn ƒê·ªìng</option>
                <option value="Tr∆∞·ªùng kh√°c">Tr∆∞·ªùng kh√°c...</option>
              </select>
              <input type="text" name="truong_khac" id="truong_khac"
                     placeholder="N·∫øu ch·ªçn 'Tr∆∞·ªùng kh√°c', ghi t√™n t·∫°i ƒë√¢y" />
            </div>
          </div>

          <!-- ƒê·ªãa ch·ªâ -->
          <div class="field-row">
            <div class="field">
              <label><span>X√£ / Ph∆∞·ªùng</span></label>
              <input type="text" name="xa" id="xa" placeholder="V√≠ d·ª•: X√£ Qu·∫£ng T√≠n" />
            </div>
            <div class="field">
              <label><span>T·ªânh / Th√†nh ph·ªë</span></label>
              <select name="tinh" id="tinh">
                <option value="">-- Ch·ªçn t·ªânh / th√†nh ph·ªë --</option>
                <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                <option value="TP. H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
                <option value="H√† N·ªôi">H√† N·ªôi</option>
                <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
                <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                <option value="Kh√°c">Kh√°c...</option>
              </select>
              <input type="text" name="tinh_khac" id="tinh_khac"
                     placeholder="N·∫øu ch·ªçn 'Kh√°c', ghi t√™n t·∫°i ƒë√¢y" />
            </div>
          </div>

          <!-- Kh·ªëi + L·ªõp -->
          <div class="field-row">
            <div class="field">
              <label><span>Kh·ªëi</span><span class="badge-required">(*)</span></label>
              <select name="khoi" id="khoi" required>
                <option value="">-- Ch·ªçn kh·ªëi --</option>
                <option value="10">Kh·ªëi 10</option>
                <option value="11">Kh·ªëi 11</option>
                <option value="12">Kh·ªëi 12</option>
              </select>
            </div>
            <div class="field">
              <label><span>L·ªõp (M√£ l·ªõp)</span><span class="badge-required">(*)</span></label>
              <input type="text" name="malop" id="malop" required
                     placeholder="VD: 12A1, 11A2..." />
              <small>Nh·∫≠p m√£ l·ªõp, h·ªá th·ªëng s·∫Ω t·ª± chuy·ªÉn th√†nh in hoa (VD: 12A1).</small>
            </div>
          </div>

          <!-- CCCD + Email -->
          <div class="field-row">
            <div class="field">
              <label>
                <span>S·ªë CCCD</span>
                <span class="badge-required">(*) k√Ω t·ª± s·ªë</span>
              </label>
              <input type="text" name="cccd" id="cccd"
                     inputmode="numeric"
                     placeholder="Nh·∫≠p d√£y s·ªë CCCD (kh√¥ng c√°ch)" />
              <small>H·ªá th·ªëng ch·ªâ gi·ªØ l·∫°i k√Ω t·ª± s·ªë, d√πng ƒë·ªÉ ki·ªÉm tra tr√πng ƒëƒÉng k√Ω v√† tra c·ª©u k·∫øt qu·∫£.</small>
            </div>
            <div class="field">
              <label><span>Email nh·∫≠n th√¥ng tin</span><span class="badge-required">(*)</span></label>
              <input type="email" name="email" id="email" required
                     placeholder="VD: hs123@gmail.com" autocomplete="email" />
              <small>D√πng email th·∫≠t ƒë·ªÉ nh·∫≠n <b>ACCESS_CODE</b> &amp; th√¥ng tin ƒëƒÉng k√Ω.</small>
            </div>
          </div>

          <!-- Ghi ch√∫ -->
          <div class="field">
            <label><span>Ghi ch√∫ (n·∫øu c√≥)</span></label>
            <textarea name="ghichu" id="ghichu"
                      placeholder="V√≠ d·ª•: HS di·ªán ∆∞u ti√™n, ghi ch√∫ s·ª©c kh·ªèe, thi·∫øt b·ªã..."></textarea>
          </div>

          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <button type="submit" class="btn-primary">
              <span class="icon">üì©</span><span>G·ª≠i ƒëƒÉng k√Ω</span>
            </button>
            <button type="reset" class="btn-ghost">
              <span class="icon">‚ôªÔ∏è</span><span>X√≥a form</span>
            </button>
            <span class="note-small">
              Sau khi g·ª≠i, ki·ªÉm tra email ƒë·ªÉ l·∫•y m·∫≠t kh·∫©u <b>ACCESS_CODE</b> ƒëƒÉng nh·∫≠p h·ªá th·ªëng.
            </span>
          </div>
        </form>
      </section>

      <!-- 2. ƒêƒÇNG NH·∫¨P -->
      <section id="login" class="page">
        <h2 class="section-title">ƒêƒÉng nh·∫≠p ACCESS_CODE</h2>
        <p class="section-desc">
          Nh·∫≠p m·∫≠t kh·∫©u <b>ACCESS_CODE</b> ƒë√£ ƒë∆∞·ª£c g·ª≠i qua email sau khi ƒëƒÉng k√Ω.
          Sau khi ƒëƒÉng nh·∫≠p, h·ªçc sinh m·ªõi d√πng ƒë∆∞·ª£c c√°c ch·ª©c nƒÉng: V√†o thi, Dashboard, Xem k·∫øt qu·∫£.
        </p>

        <form onsubmit="return handleLogin(event)">
          <div class="field">
            <label>
              <span>M·∫≠t kh·∫©u ACCESS_CODE</span>
              <span class="badge-required">(*)</span>
            </label>
            <input type="password" id="accessCodeInput"
                   placeholder="Nh·∫≠p ACCESS_CODE (VD: SK2025)" required />
            <small>M·∫≠t kh·∫©u d√πng chung cho k·ª≥ thi, do nh√† tr∆∞·ªùng cung c·∫•p (kh√¥ng ph·∫£i m·∫≠t kh·∫©u email).</small>
          </div>

          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <button type="submit" class="btn-primary">
              <span class="icon">üîì</span><span>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</span>
            </button>
            <button type="button" class="btn-ghost" onclick="handleLogout()">
              <span class="icon">üö™</span><span>ƒêƒÉng xu·∫•t</span>
            </button>
          </div>
        </form>
      </section>

      <!-- 3. V√ÄO THI -->
      <section id="exam" class="page">
        <h2 class="section-title">V√†o ca thi</h2>
        <p class="section-desc">
          H·ªá th·ªëng t·ª± l·∫•y c·∫•u h√¨nh k·ª≥ thi t·ª´ sheet <b>CauHinhThi</b> (MaKyThi, h√¨nh th·ª©c TKTx/TKDk/KTCk,
          th·ªùi gian b·∫Øt ƒë·∫ßu ‚Äì k·∫øt th√∫c). Ch·ªâ trong kho·∫£ng th·ªùi gian cho ph√©p, n√∫t <b>V√†o l√†m b√†i</b> m·ªõi m·ªü.
        </p>

        <div class="card-mini" id="examConfigBox">
          <h3 id="examTitle">Ch∆∞a c·∫•u h√¨nh k·ª≥ thi</h3>

          <div class="sub">
            <b>M√£ ca thi:</b> <span id="examCodeText">‚Äì</span>
          </div>

          <div class="sub" id="examTypeText">
            H√£y ki·ªÉm tra sheet <b>CauHinhThi</b> trong file ƒêƒÉng k√Ω.
          </div>

          <div class="sub" id="examTimeText"></div>

          <div class="sub exam-warning" id="examWarningText"></div>

          <div class="sub" id="examStatusText"></div>

          <div class="sub">
            <b>ƒê·ªìng h·ªì:</b> <span id="examCountdown">--:--:--</span>
          </div>
        </div>

        <button id="btnStartExam" class="btn-primary" type="button" onclick="openExam()" disabled>
          <span class="icon">üß™</span><span>V√†o l√†m b√†i ki·ªÉm tra</span>
        </button>

        <div class="note-small" id="examNote">
          H·∫øt gi·ªù l√†m b√†i, h·ªá th·ªëng s·∫Ω <b>t·ª± ƒë·ªông kh√≥a n√∫t V√†o thi</b> (kh√¥ng cho m·ªü ƒë·ªÅ m·ªõi).
          Vi·ªác n·ªôp b√†i b√™n trong Google Form v·∫´n do h·ªçc sinh b·∫•m ‚ÄúG·ª¨I‚Äù v√†/ho·∫∑c add-on trong Google Form x·ª≠ l√Ω.
        </div>
      </section>

      <!-- 4. XEM K·∫æT QU·∫¢ -->
      <section id="lookup" class="page">
        <h2 class="section-title">Tra c·ª©u k·∫øt qu·∫£ b√†i thi</h2>
        <p class="section-desc">
          H·ªçc sinh c√≥ th·ªÉ xem ƒëi·ªÉm b·∫±ng c√°ch nh·∫≠p <b>CCCD</b> ho·∫∑c <b>H·ªç t√™n (IN HOA) + L·ªõp</b>.
          D·ªØ li·ªáu l·∫•y t·ª´ sheet <b>DiemThi</b>.
        </p>

        <div class="pill-soft">
          H·ªá th·ªëng y√™u c·∫ßu ƒë√£ <b>ƒêƒÉng nh·∫≠p ACCESS_CODE</b> tr∆∞·ªõc khi tra c·ª©u.
        </div>

        <div class="search-row">
          <div class="field">
            <label><span>CCCD (∆∞u ti√™n)</span></label>
            <input type="text" id="srCccd" inputmode="numeric"
                   placeholder="Nh·∫≠p CCCD ƒë·ªÉ tra c·ª©u nhanh" />
          </div>
          <div class="field">
            <label><span>H·ªç t√™n (IN HOA)</span></label>
            <input type="text" id="srName"
                   placeholder="VD: NGUY·ªÑN VƒÇN A" />
          </div>
          <div class="field">
            <label><span>L·ªõp (m√£ l·ªõp)</span></label>
            <input type="text" id="srClass"
                   placeholder="VD: 12A1" />
          </div>
        </div>

        <div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn-primary" onclick="handleSearchResult()">
            <span class="icon">üîç</span><span>Tra c·ª©u k·∫øt qu·∫£</span>
          </button>
          <button type="button" class="btn-ghost" onclick="clearSearchResult()">
            <span class="icon">üßπ</span><span>X√≥a k·∫øt qu·∫£</span>
          </button>
          <span class="note-small">∆Øu ti√™n nh·∫≠p CCCD. N·∫øu kh√¥ng nh·ªõ, d√πng H·ªå T√äN (IN HOA) + L·ªöP.</span>
        </div>

        <div id="lookupResult" style="margin-top:8px;"></div>
      </section>
    </div>

    <!-- RIGHT: DASHBOARD -->
    <div class="right-pane">
      <div class="right-pane-header">
        <div>
          <div style="font-size:0.86rem;color:#e5e7eb;font-weight:600;display:flex;align-items:center;gap:6px;">
            <span>Dashboard ƒëi·ªÉm ‚Äì DTAI_Online</span>
          </div>
          <div style="font-size:0.75rem;color:var(--text-soft);">
            Th·ªëng k√™ b√†i l√†m t·ª´ sheet <b>DiemThi</b> (Google Form/Quiz).
          </div>
        </div>
        <div class="login-status">
          <span id="authStatusText">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
          <span class="login-dot off" id="authStatusDot"></span>
        </div>
      </div>

      <div class="stat-grid" id="statGrid">
        <div class="stat-card">
          <div class="label">T·ªïng s·ªë b√†i thi</div>
          <div class="value" id="stTotalRows">‚Äì</div>
          <div class="sub">D·ªØ li·ªáu t·ª´ sheet DiemThi</div>
        </div>
        <div class="stat-card">
          <div class="label">Kh·ªëi c√≥ nhi·ªÅu b√†i nh·∫•t</div>
          <div class="value" id="stTopGrade">‚Äì</div>
          <div class="sub" id="stTopGradeSub">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
        <div class="stat-card">
          <div class="label">L·ªõp c√≥ nhi·ªÅu b√†i nh·∫•t</div>
          <div class="value" id="stTopClass">‚Äì</div>
          <div class="sub" id="stTopClassSub">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
      </div>

      <div class="table-wrapper">
        <header>
          <span>B·∫£ng ƒëi·ªÉm g·∫ßn nh·∫•t</span>
          <button type="button" class="btn-small" onclick="loadDashboard()">
            <span class="icon">üîÑ</span><span>T·∫£i l·∫°i</span>
          </button>
        </header>
        <div class="table-scroll" id="resultsTableBox">
          <!-- B·∫£ng ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  // üëâ URL Web App Apps Script (mode=stats/results/search/examConfig + doPost)
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIRwnJhmX8lqY78QYpGiXXCYtWfCBrGVNZUoyJvhgJ0Ej6cYooLL-pVZPGJmOXKtY2/exec";

  // üëâ ACCESS_CODE ‚Äì ph·∫£i tr√πng v·ªõi Code.gs
  const ACCESS_CODE = "SK2025";

  let isLoggedIn = false;

  // Bi·∫øn c·∫•u h√¨nh k·ª≥ thi
  let examConfig = null;
  let examTimeOffset = 0;
  let examCountdownTimer = null;

  /***************** NAV & PAGING *****************/
  const navButtons = document.querySelectorAll(".nav-btn");
  const pages = document.querySelectorAll(".page");

  navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      switchPage(target);
    });
  });

  function switchPage(target) {
    navButtons.forEach(b => b.classList.toggle("active", b.getAttribute("data-target") === target));
    pages.forEach(p => p.classList.toggle("active", p.id === target));
  }

  /***************** NG√ÄY SINH: DAY/MONTH/YEAR *****************/

  function initDobSelects() {
    const daySel = document.getElementById("dobDay");
    const monthSel = document.getElementById("dobMonth");
    const yearSel = document.getElementById("dobYear");
    if (!daySel || !monthSel || !yearSel) return;

    daySel.innerHTML = '<option value="">Ng√†y</option>';
    for (let d = 1; d <= 31; d++) {
      const op = document.createElement("option");
      op.value = String(d).padStart(2, "0");
      op.textContent = String(d).padStart(2, "0");
      daySel.appendChild(op);
    }

    monthSel.innerHTML = '<option value="">Th√°ng</option>';
    for (let m = 1; m <= 12; m++) {
      const op = document.createElement("option");
      op.value = String(m).padStart(2, "0");
      op.textContent = String(m).padStart(2, "0");
      monthSel.appendChild(op);
    }

    const currentYear = new Date().getFullYear();
    yearSel.innerHTML = '<option value="">NƒÉm</option>';
    for (let y = currentYear - 25; y >= currentYear - 80; y--) {
      const op = document.createElement("option");
      op.value = String(y);
      op.textContent = String(y);
      yearSel.appendChild(op);
    }

    function updateDobHidden() {
      const d = daySel.value;
      const m = monthSel.value;
      const y = yearSel.value;
      const hidden = document.getElementById("ngaysinh");
      if (!hidden) return;
      if (d && m && y) {
        hidden.value = d + "/" + m + "/" + y;
      } else {
        hidden.value = "";
      }
    }

    daySel.addEventListener("change", updateDobHidden);
    monthSel.addEventListener("change", updateDobHidden);
    yearSel.addEventListener("change", updateDobHidden);
  }

  /***************** ƒêƒÇNG K√ù: SUBMIT *****************/

  function handleRegisterSubmit(e) {
    const day = document.getElementById("dobDay")?.value || "";
    const month = document.getElementById("dobMonth")?.value || "";
    const year = document.getElementById("dobYear")?.value || "";
    const hidden = document.getElementById("ngaysinh");

    if (hidden) {
      if (day && month && year) {
        hidden.value = day + "/" + month + "/" + year;
      } else {
        alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß Ng√†y sinh (Ng√†y/Th√°ng/NƒÉm).");
        e.preventDefault();
        return false;
      }
    }

    // Cho ph√©p form submit b√¨nh th∆∞·ªùng sang Apps Script (HTML success/duplicate)
    return true;
  }

  /***************** AUTH ‚Äì ACCESS_CODE *****************/

  function loadAuthFromStorage() {
    try {
      const v = localStorage.getItem("DTAI_LOGGED_IN");
      isLoggedIn = v === "1";
    } catch (err) {
      isLoggedIn = false;
    }
  }

  function saveAuthToStorage() {
    try {
      localStorage.setItem("DTAI_LOGGED_IN", isLoggedIn ? "1" : "0");
    } catch (err) {}
  }

  function updateAuthUI() {
    const dot = document.getElementById("authStatusDot");
    const text = document.getElementById("authStatusText");
    if (!dot || !text) return;

    if (isLoggedIn) {
      dot.classList.remove("off");
      text.textContent = "ƒê√£ ƒëƒÉng nh·∫≠p ACCESS_CODE";
    } else {
      dot.classList.add("off");
      text.textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
    }

    // N√∫t V√†o thi ph·ª• thu·ªôc v√†o login + th·ªùi gian
    updateExamCountdown();
  }

  function handleLogin(e) {
    e.preventDefault();
    const inp = document.getElementById("accessCodeInput");
    if (!inp) return false;
    const val = (inp.value || "").trim();

    if (!val) {
      alert("Vui l√≤ng nh·∫≠p ACCESS_CODE.");
      return false;
    }
    if (val !== ACCESS_CODE) {
      alert("ACCESS_CODE ch∆∞a ƒë√∫ng. Ki·ªÉm tra l·∫°i email ho·∫∑c li√™n h·ªá gi√°o vi√™n ph·ª• tr√°ch.");
      return false;
    }

    isLoggedIn = true;
    saveAuthToStorage();
    updateAuthUI();
    alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Th·∫ßy/c√¥/h·ªçc sinh c√≥ th·ªÉ v√†o thi, xem Dashboard v√† tra c·ª©u k·∫øt qu·∫£.");
    return false;
  }

  function handleLogout() {
    isLoggedIn = false;
    saveAuthToStorage();
    updateAuthUI();
    alert("ƒê√£ ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng.");
  }

  function requireLogin() {
    if (!isLoggedIn) {
      alert("C·∫ßn ƒëƒÉng nh·∫≠p ACCESS_CODE tr∆∞·ªõc khi s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.");
      switchPage("login");
      return false;
    }
    return true;
  }

  /***************** C·∫§U H√åNH K·ª≤ THI + ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C *****************/

  function examTypeLabel(code) {
    switch ((code || "").toUpperCase()) {
      case "TKTX": return "Ki·ªÉm tra th∆∞·ªùng xuy√™n (TKTx)";
      case "TKDK": return "Ki·ªÉm tra ƒë·ªãnh k·ª≥ (TKDk)";
      case "KTCK": return "Ki·ªÉm tra cu·ªëi k·ª≥ (KTCk)";
      default:     return code || "Kh√¥ng x√°c ƒë·ªãnh";
    }
  }

  async function loadExamConfig() {
    try {
      const data = await callJsonp(WEB_APP_URL + "?mode=examConfig", "examCfgCallback");
      renderExamConfig(data);
    } catch (err) {
      console.error(err);
      const statusEl = document.getElementById("examStatusText");
      if (statusEl) {
        statusEl.textContent = "L·ªói t·∫£i c·∫•u h√¨nh k·ª≥ thi. Th·∫ßy/c√¥ ki·ªÉm tra l·∫°i Code.gs ho·∫∑c sheet CauHinhThi.";
      }
    }
  }

  function renderExamConfig(data) {
    const titleEl     = document.getElementById("examTitle");
    const codeTextEl  = document.getElementById("examCodeText");
    const typeTextEl  = document.getElementById("examTypeText");
    const timeTextEl  = document.getElementById("examTimeText");
    const warnTextEl  = document.getElementById("examWarningText");
    const statusEl    = document.getElementById("examStatusText");
    const countdownEl = document.getElementById("examCountdown");
    const btn         = document.getElementById("btnStartExam");

    if (examCountdownTimer) {
      clearInterval(examCountdownTimer);
      examCountdownTimer = null;
    }

    if (!data || !data.ok) {
      examConfig = null;
      if (titleEl) titleEl.textContent = "Ch∆∞a c·∫•u h√¨nh k·ª≥ thi.";
      if (codeTextEl) codeTextEl.textContent = "‚Äì";
      if (typeTextEl) typeTextEl.innerHTML = "H√£y m·ªü sheet <b>CauHinhThi</b> v√† ƒëi·ªÅn c·∫•u h√¨nh ·ªü h√†ng 2.";
      if (timeTextEl) timeTextEl.textContent = "";
      if (warnTextEl) warnTextEl.textContent = "";
      if (statusEl) statusEl.textContent = data && data.error ? ("L·ªói: " + data.error) : "";
      if (countdownEl) countdownEl.textContent = "--:--:--";
      if (btn) btn.disabled = true;
      return;
    }

    examConfig = data;
    examTimeOffset = Date.now() - (data.serverNowMs || Date.now());

    const code      = data.examCode || "‚Äì";
    const typeLabel = examTypeLabel(data.examType);

    if (titleEl) titleEl.textContent = data.title || "K·ª≥ thi hi·ªán t·∫°i";
    if (codeTextEl) codeTextEl.textContent = code;
    if (typeTextEl) typeTextEl.innerHTML = "H√¨nh th·ª©c: <b>" + typeLabel + "</b>";

    if (data.startMs && data.endMs) {
      const start = new Date(data.startMs);
      const end   = new Date(data.endMs);
      const fmtFull = d => d.toLocaleString("vi-VN");
      const fmtTime = d => d.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});

      if (timeTextEl) {
        timeTextEl.textContent =
          "Th·ªùi gian l√†m b√†i: t·ª´ " + fmtFull(start) + " ƒë·∫øn " + fmtFull(end) + ".";
      }

      if (warnTextEl) {
        const endTimeStr = fmtTime(end);
        warnTextEl.innerHTML =
          "ƒê·∫øn <b>" + endTimeStr +
          "</b> h·ªá th·ªëng s·∫Ω <b>kh√¥ng nh·∫≠n b√†i n·ªØa</b>. " +
          "H√£y b·∫•m <b>G·ª¨I</b> b√†i tr√™n Google Form tr∆∞·ªõc th·ªùi ƒëi·ªÉm n√†y.";
      }
    } else {
      if (timeTextEl) {
        timeTextEl.textContent =
          "Th·ªùi gian l√†m b√†i: ch∆∞a c·∫•u h√¨nh ƒë·∫ßy ƒë·ªß (thi kh√¥ng gi·ªõi h·∫°n ho·∫∑c thi·∫øu th·ªùi gian).";
      }
      if (warnTextEl) warnTextEl.textContent = "";
    }

    if (statusEl) statusEl.textContent = "";
    if (btn) btn.disabled = true;

    updateExamCountdown();
    examCountdownTimer = setInterval(updateExamCountdown, 1000);
  }

  function formatRemain(ms) {
    if (ms <= 0) return "00:00:00";
    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    const pad = n => String(n).padStart(2, "0");
    return pad(h) + ":" + pad(m) + ":" + pad(s);
  }

  function updateExamCountdown() {
    const countdownEl = document.getElementById("examCountdown");
    const statusEl    = document.getElementById("examStatusText");
    const btn         = document.getElementById("btnStartExam");

    if (!examConfig) {
      if (countdownEl) countdownEl.textContent = "--:--:--";
      if (statusEl) statusEl.textContent = "";
      if (btn) btn.disabled = true;
      return;
    }

    const startMs = examConfig.startMs;
    const endMs   = examConfig.endMs;
    const nowMs   = Date.now() - examTimeOffset;

    if (!startMs || !endMs) {
      if (countdownEl) countdownEl.textContent = "Kh√¥ng gi·ªõi h·∫°n";
      if (statusEl) statusEl.textContent = "K·ª≥ thi kh√¥ng gi·ªõi h·∫°n ho·∫∑c ch∆∞a c·∫•u h√¨nh th·ªùi gian ƒë·∫ßy ƒë·ªß.";
      if (btn) btn.disabled = !isLoggedIn;
      return;
    }

    if (nowMs < startMs) {
      const remain = startMs - nowMs;
      if (countdownEl) countdownEl.textContent = "C√≤n " + formatRemain(remain) + " ƒë·∫øn gi·ªù b·∫Øt ƒë·∫ßu";
      if (statusEl) statusEl.textContent = "Ch∆∞a ƒë·∫øn gi·ªù l√†m b√†i. H·ªçc sinh ch·ªù ƒë·∫øn th·ªùi gian quy ƒë·ªãnh.";
      if (btn) btn.disabled = true;
      return;
    }

    if (nowMs >= startMs && nowMs <= endMs) {
      const remain = endMs - nowMs;
      if (countdownEl) countdownEl.textContent = formatRemain(remain);
      if (statusEl) statusEl.textContent = "K·ª≥ thi ƒëang di·ªÖn ra. H·ªçc sinh ch·ªâ n√™n m·ªü ƒë·ªÅ khi ƒë√£ s·∫µn s√†ng.";
      if (btn) btn.disabled = !isLoggedIn;
      return;
    }

    if (countdownEl) countdownEl.textContent = "00:00:00";
    if (statusEl) statusEl.textContent = "ƒê√£ h·∫øt gi·ªù l√†m b√†i. N√∫t V√†o thi ƒë√£ b·ªã kh√≥a.";
    if (btn) btn.disabled = true;
  }

  function openExam() {
    if (!requireLogin()) return;
    if (!examConfig || !examConfig.link) {
      alert("K·ª≥ thi ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh (link Google Form). Th·∫ßy/c√¥ ki·ªÉm tra l·∫°i sheet CauHinhThi.");
      return;
    }

    const startMs = examConfig.startMs;
    const endMs   = examConfig.endMs;
    if (startMs && endMs) {
      const nowMs = Date.now() - examTimeOffset;
      if (nowMs < startMs) {
        alert("Ch∆∞a ƒë·∫øn gi·ªù b·∫Øt ƒë·∫ßu l√†m b√†i.");
        return;
      }
      if (nowMs > endMs) {
        alert("ƒê√£ h·∫øt gi·ªù l√†m b√†i. B√†i thi ƒë√£ b·ªã kh√≥a.");
        return;
      }
    }

    window.open(examConfig.link, "_blank");
  }

  /***************** JSONP HELPER *****************/

  function callJsonp(url, cbName) {
    return new Promise((resolve, reject) => {
      const callbackName = cbName + "_" + Math.floor(Math.random() * 1e6);
      const script = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + callbackName;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 12000);

      function cleanup() {
        clearTimeout(timeout);
        script.remove();
        try { delete window[callbackName]; } catch(e) { window[callbackName] = undefined; }
      }

      window[callbackName] = function(data) {
        cleanup();
        resolve(data);
      };

      script.onerror = function() {
        cleanup();
        reject(new Error("JSONP error"));
      };

      document.body.appendChild(script);
    });
  }

  /***************** DASHBOARD: stats + results *****************/

  async function loadDashboard() {
    try {
      const stats = await callJsonp(WEB_APP_URL + "?mode=stats", "statsCb");
      renderStats(stats);
    } catch (err) {
      console.error("L·ªói stats:", err);
    }

    try {
      const results = await callJsonp(WEB_APP_URL + "?mode=results", "resultsCb");
      renderResultsTable(results);
    } catch (err) {
      console.error("L·ªói results:", err);
    }
  }

  function renderStats(stats) {
    const totalEl = document.getElementById("stTotalRows");
    const topGradeEl = document.getElementById("stTopGrade");
    const topGradeSubEl = document.getElementById("stTopGradeSub");
    const topClassEl = document.getElementById("stTopClass");
    const topClassSubEl = document.getElementById("stTopClassSub");

    if (!stats || !stats.rows) {
      if (totalEl) totalEl.textContent = "0";
      if (topGradeEl) topGradeEl.textContent = "‚Äì";
      if (topGradeSubEl) topGradeSubEl.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu";
      if (topClassEl) topClassEl.textContent = "‚Äì";
      if (topClassSubEl) topClassSubEl.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu";
      return;
    }

    if (totalEl) totalEl.textContent = stats.rows.toString();

    let bestGrade = "‚Äì";
    let bestGradeCount = 0;
    if (stats.byGrade) {
      Object.keys(stats.byGrade).forEach(k => {
        const c = stats.byGrade[k]?.count || 0;
        if (c > bestGradeCount) {
          bestGradeCount = c;
          bestGrade = k;
        }
      });
    }
    if (topGradeEl) topGradeEl.textContent = bestGrade;
    if (topGradeSubEl) {
      topGradeSubEl.textContent = bestGrade === "‚Äì"
        ? "Ch∆∞a c√≥ d·ªØ li·ªáu"
        : (bestGradeCount + " b√†i thi");
    }

    let bestClass = "‚Äì";
    let bestClassCount = 0;
    if (stats.byClass) {
      Object.keys(stats.byClass).forEach(k => {
        const c = stats.byClass[k]?.count || 0;
        if (c > bestClassCount) {
          bestClassCount = c;
          bestClass = k;
        }
      });
    }
    if (topClassEl) topClassEl.textContent = bestClass;
    if (topClassSubEl) {
      topClassSubEl.textContent = bestClass === "‚Äì"
        ? "Ch∆∞a c√≥ d·ªØ li·ªáu"
        : (bestClassCount + " b√†i thi");
    }
  }

  function renderResultsTable(data) {
    const box = document.getElementById("resultsTableBox");
    if (!box) return;

    if (!data || !data.rows || !data.rows.length) {
      box.innerHTML = '<div style="padding:8px;font-size:0.8rem;color:var(--text-soft);">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm.</div>';
      return;
    }

    let html = '<table><thead><tr>' +
      '<th>Th·ªùi gian</th>' +
      '<th>H·ªç t√™n</th>' +
      '<th>L·ªõp</th>' +
      '<th>ƒêi·ªÉm</th>' +
      '</tr></thead><tbody>';

    data.rows.forEach(r => {
      html += '<tr>' +
        '<td>' + escapeHtml(r.time || "") + '</td>' +
        '<td>' + escapeHtml(r.name || "") + '</td>' +
        '<td>' + escapeHtml(r.class || "") + '</td>' +
        '<td>' + escapeHtml(r.score != null ? String(r.score) : "") + '</td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    box.innerHTML = html;
  }

  /***************** TRA C·ª®U K·∫æT QU·∫¢ *****************/

  async function handleSearchResult() {
    if (!requireLogin()) return;

    const cccd  = (document.getElementById("srCccd")?.value || "").trim();
    const name  = (document.getElementById("srName")?.value || "").trim();
    const clazz = (document.getElementById("srClass")?.value || "").trim();

    if (!cccd && !name) {
      alert("Vui l√≤ng nh·∫≠p CCCD ho·∫∑c H·ªå T√äN (IN HOA) ƒë·ªÉ tra c·ª©u.");
      return;
    }

    const params = new URLSearchParams();
    params.set("mode", "search");
    if (cccd) params.set("cccd", cccd);
    if (name) params.set("name", name);
    if (clazz) params.set("className", clazz);

    const url = WEB_APP_URL + "?" + params.toString();

    try {
      const data = await callJsonp(url, "searchCb");
      renderSearchResult(data);
    } catch (err) {
      console.error(err);
      const box = document.getElementById("lookupResult");
      if (box) {
        box.innerHTML = '<div style="font-size:0.8rem;color:var(--text-soft);">L·ªói tra c·ª©u. Th·∫ßy/c√¥ ki·ªÉm tra l·∫°i c·∫•u h√¨nh.</div>';
      }
    }
  }

  function renderSearchResult(data) {
    const box = document.getElementById("lookupResult");
    if (!box) return;

    if (!data) {
      box.innerHTML = "";
      return;
    }

    if (!data.found || !data.results || !data.results.length) {
      box.innerHTML = '<div class="result-card">' +
        '<h4>K·∫øt qu·∫£ tra c·ª©u</h4>' +
        '<div class="meta">' + escapeHtml(data.message || "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.") + '</div>' +
        '</div>';
      return;
    }

    let html = "";
    html += '<div class="result-card">';
    html += '<h4>K·∫øt qu·∫£ tra c·ª©u</h4>';
    html += '<div class="meta">' + escapeHtml(data.message || "") + '</div>';
    data.results.forEach((r, index) => {
      html += '<div style="margin-top:6px;border-top:1px dashed rgba(75,85,99,0.8);padding-top:4px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">';
      html += '<span><b>' + escapeHtml(r.name || "") + '</b> ‚Äì ' + escapeHtml(r.className || "") + '</span>';
      html += '<span class="pill-soft">ƒêi·ªÉm: <b>' + escapeHtml(r.score != null ? String(r.score) : "") + '</b></span>';
      html += '</div>';
      html += '<div class="meta">Gi·ªõi t√≠nh: ' + escapeHtml(r.gender || "‚Äì") +
              ' | D√¢n t·ªôc: ' + escapeHtml(r.ethnic || "‚Äì") +
              ' | Tr∆∞·ªùng: ' + escapeHtml(r.school || "‚Äì") + '</div>';
      if (r.cccd) {
        html += '<div class="meta">CCCD: ' + escapeHtml(r.cccd) + '</div>';
      }
      html += '</div>';
    });
    html += '</div>';

    box.innerHTML = html;
  }

  function clearSearchResult() {
    const box = document.getElementById("lookupResult");
    if (box) box.innerHTML = "";
  }

  /***************** UTILS *****************/

  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  /***************** INIT *****************/

  document.addEventListener("DOMContentLoaded", function() {
    initDobSelects();
    loadAuthFromStorage();
    updateAuthUI();
    loadDashboard();
    loadExamConfig();
  });
</script>
</body>
</html>
