<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PWA meta -->
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root {
      /* ====== M√ÄU CH·ª¶ ƒê·∫†O ‚Äì THAY ·ªû ƒê√ÇY ====== */
      --bg: #020617;
      --bg-soft: #020617;
      --card-bg: #020617;
      --card-border: rgba(148, 163, 184, 0.35);
      --accent: #2563eb;     /* n√∫t ch√≠nh */
      --accent-soft: #1d4ed8;
      --accent-alt: #22c55e; /* ƒë·∫øm ng∆∞·ª£c OK */
      --danger: #ef4444;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --chip-bg: rgba(15, 23, 42, 0.9);

      --radius-lg: 22px;
      --shadow-soft: 0 22px 60px rgba(15, 23, 42, 0.6);

      --font-size-base: 17px;      /* tƒÉng font 2‚Äì3px */
      --font-size-label: 0.9rem;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: var(--font-size-base);
      color: var(--text-main);
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 14px 32px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 6px 18px;
    }

    .logo-circle {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #4f46e5, #1e293b);
      box-shadow: 0 12px 35px rgba(37, 99, 235, .7);
      padding: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* üëâ ƒê·ªîI LOGO TH·∫¨T ·ªû ƒê√ÇY */
    .logo-circle img {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      object-fit: cover;
    }

    .header-text h1 {
      margin: 0 0 4px;
      font-size: 1.15rem;
      letter-spacing: .02em;
    }
    .header-text p {
      margin: 0;
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* ===== NAV / MENU ===== */
    nav {
      display: flex;
      gap: 8px;
      padding: 4px 4px 10px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    nav::-webkit-scrollbar { display: none; }

    .nav-btn {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      padding: 7px 14px;
      font-size: .84rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all .15s ease;
      white-space: nowrap;
    }
    .nav-btn span.icon {
      font-size: 1rem;
    }
    .nav-btn.active {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      border-color: transparent;
      box-shadow: 0 10px 26px rgba(37, 99, 235, .6);
    }
    .nav-btn:hover {
      transform: translateY(-1px);
    }

    /* ===== CARD / FORM ===== */
    .card {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, .12), rgba(15, 23, 42, .95));
      border: 1px solid var(--card-border);
      padding: 18px 16px 18px;
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .card-header-title {
      font-weight: 600;
      font-size: 1rem;
    }
    .card-header-sub {
      margin-top: 2px;
      font-size: .8rem;
      color: var(--text-muted);
    }

    .chip {
      font-size: .7rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, .8);
      border: 1px solid rgba(148, 163, 184, 0.38);
    }

    form {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 11px;
    }

    @media (min-width: 720px) {
      form.grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        column-gap: 14px;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: var(--font-size-label);
      color: var(--text-muted);
    }
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .hint {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .control {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, .6);
      padding: 9px 11px;
      font-size: var(--font-size-base);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      width: 100%;
    }
    .control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, .6);
    }
    select.control {
      padding-right: 30px;
    }

    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    button.primary {
      border: none;
      border-radius: 999px;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #fff;
      padding: 9px 20px;
      font-size: .9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(37, 99, 235, .7);
    }
    button.secondary {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, .8);
      color: var(--text-main);
      padding: 8px 16px;
      font-size: .9rem;
      cursor: pointer;
    }
    button[disabled] {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .alert {
      margin-top: 6px;
      border-radius: 14px;
      padding: 8px 10px;
      font-size: .8rem;
      line-height: 1.5;
    }
    .alert.info {
      background: rgba(37, 99, 235, .12);
      border: 1px dashed rgba(96, 165, 250, .6);
    }
    .alert.danger {
      background: rgba(239, 68, 68, .12);
      border: 1px dashed rgba(248, 113, 113, .9);
      color: #fecaca;
    }
    .alert.success {
      background: rgba(34, 197, 94, .12);
      border: 1px dashed rgba(52, 211, 153, .9);
      color: #bbf7d0;
    }

    .small {
      font-size: .78rem;
    }

    .badge-timer {
      font-size: .8rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, .9);
      border: 1px solid rgba(52, 211, 153, .6);
      color: #6ee7b7;
    }

    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    /* table for results / dashboard */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
      margin-top: 8px;
    }
    .table th,
    .table td {
      padding: 5px 7px;
      border-bottom: 1px solid rgba(30, 64, 175, .55);
      text-align: left;
    }
    .table th {
      color: #93c5fd;
      font-weight: 500;
    }
    .table tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.7);
    }

    .pill {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: .72rem;
      background: rgba(15,23,42,.9);
    }

    .center {
      text-align: center;
    }
  </style>
</head>
<body>
<div class="shell">

  <!-- ===== HEADER ===== -->
  <header>
    <div class="logo-circle">
      <!-- ƒê·ªîI SRC LOGO TH·∫¨T C·ª¶A TR∆Ø·ªúNG ·ªû ƒê√ÇY -->
      <img src="https://via.placeholder.com/120x120.png?text=NDC" alt="Logo tr∆∞·ªùng" />
    </div>
    <div class="header-text">
      <h1>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</h1>
      <p>Tr∆∞·ªùng THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu ¬∑ Digital Assessment Platform</p>
    </div>
  </header>

  <!-- ===== NAV ===== -->
  <nav>
    <button class="nav-btn active" data-target="section-reg">
      <span class="icon">üìù</span> ƒêƒÉng k√Ω / Register
    </button>
    <button class="nav-btn" data-target="section-login">
      <span class="icon">üîê</span> ƒêƒÉng nh·∫≠p / Login
    </button>
    <button class="nav-btn" data-target="section-exam">
      <span class="icon">üéØ</span> V√†o thi / Take exam
    </button>
    <button class="nav-btn" data-target="section-results">
      <span class="icon">üìÑ</span> Xem k·∫øt qu·∫£ / View result
    </button>
    <button class="nav-btn" data-target="section-dashboard">
      <span class="icon">üìä</span> Dashboard
    </button>
  </nav>

  <!-- ============ SECTION: ƒêƒÇNG K√ù ============ -->
  <section id="section-reg" class="section active">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-header-title">ƒêƒÉng k√Ω tham gia ki·ªÉm tra / Exam registration</div>
          <div class="card-header-sub">
            H·ªç t√™n &amp; L·ªõp s·∫Ω t·ª± chuy·ªÉn sang CH·ªÆ IN HOA ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu.
          </div>
        </div>
        <div class="chip">STEP 1 ‚Äì REGISTER</div>
      </div>

      <div id="reg-warning" class="alert info small">
        ‚è∞ <b>C·∫£nh b√°o/Notice:</b> V√≠ d·ª•: ‚Äúƒê·∫øn <b>08:45</b> h·ªá th·ªëng s·∫Ω kh√¥ng nh·∫≠n b√†i n·ªØa.
        H√£y b·∫•m <b>G·ª¨I / SUBMIT</b> tr∆∞·ªõc th·ªùi ƒëi·ªÉm n√†y.‚Äù (Th·∫ßy/c√¥ s·ª≠a n·ªôi dung c·∫£nh b√°o ·ªü HTML n·∫øu c·∫ßn.)
      </div>

      <form id="reg-form" class="grid-2" autocomplete="off">
        <!-- H·ªç t√™n -->
        <div class="form-group">
          <div class="label-row">
            <label for="hoten">
              H·ªç v√† t√™n / <b>Full name</b>
            </label>
            <span class="hint">S·∫Ω t·ª± chuy·ªÉn sang <b>IN HOA</b></span>
          </div>
          <input id="hoten" name="hoten" class="control" placeholder="NGUY·ªÑN VƒÇN A" required />
        </div>

        <!-- Ng√†y sinh -->
        <div class="form-group">
          <label>Ng√†y sinh / <b>Date of birth</b></label>
          <div class="row-3">
            <select id="dob-day" class="control" required>
              <option value="">Ng√†y</option>
            </select>
            <select id="dob-month" class="control" required>
              <option value="">Th√°ng</option>
            </select>
            <select id="dob-year" class="control" required>
              <option value="">NƒÉm</option>
            </select>
          </div>
          <input type="hidden" id="ngaysinh" name="ngaysinh" />
        </div>

        <!-- Gi·ªõi t√≠nh -->
        <div class="form-group">
          <label for="gioitinh">
            Gi·ªõi t√≠nh / Gender
          </label>
          <select id="gioitinh" name="gioitinh" class="control" required>
            <option value="">Ch·ªçn / Select‚Ä¶</option>
            <option>Nam / Male</option>
            <option>N·ªØ / Female</option>
            <option>Kh√°c / Other</option>
          </select>
        </div>

        <!-- Kh·ªëi -->
        <div class="form-group">
          <label for="khoi">
            Kh·ªëi / Grade
          </label>
          <select id="khoi" name="khoi" class="control" required>
            <option value="">Ch·ªçn kh·ªëi / Select grade‚Ä¶</option>
            <option value="10">Kh·ªëi 10 / Grade 10</option>
            <option value="11">Kh·ªëi 11 / Grade 11</option>
            <option value="12">Kh·ªëi 12 / Grade 12</option>
          </select>
        </div>

        <!-- D√¢n t·ªôc -->
        <div class="form-group">
          <label for="dantoc">
            D√¢n t·ªôc / Ethnicity
          </label>
          <select id="dantoc" name="dantoc" class="control">
            <option value="">Ch·ªçn / Select‚Ä¶</option>
            <option value="Kinh">Kinh</option>
            <option value="N√πng">N√πng</option>
            <option value="T√†y">T√†y</option>
            <option value="M'N√¥ng">M'N√¥ng</option>
            <option value="Kh√°c">Kh√°c / Other</option>
          </select>
        </div>

        <!-- Tr∆∞·ªùng -->
        <div class="form-group">
          <label for="truong">
            Tr∆∞·ªùng / School
          </label>
          <select id="truong" name="truong" class="control">
            <option value="">Ch·ªçn tr∆∞·ªùng / Select school‚Ä¶</option>
            <option>THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
            <option>THPT Ph·∫°m VƒÉn ƒê·ªìng</option>
            <option>THPT kh√°c / Other</option>
          </select>
        </div>

        <!-- Tr∆∞·ªùng kh√°c -->
        <div class="form-group">
          <label for="truong_khac">
            Tr∆∞·ªùng (kh√°c) / Other school
          </label>
          <input id="truong_khac" name="truong_khac" class="control"
                 placeholder="VD: THPT ABC‚Ä¶" />
        </div>

        <!-- X√£/Ph∆∞·ªùng -->
        <div class="form-group">
          <label for="xa">
            X√£ / Ph∆∞·ªùng / Ward
          </label>
          <input id="xa" name="xa" class="control"
                 placeholder="VD: Qu·∫£ng T√≠n‚Ä¶" />
        </div>

        <!-- T·ªânh -->
        <div class="form-group">
          <label for="tinh">
            T·ªânh / Th√†nh ph·ªë / Province
          </label>
          <select id="tinh" name="tinh" class="control">
            <option value="">Ch·ªçn / Select‚Ä¶</option>
            <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
            <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
            <option value="Kh√°c">T·ªânh kh√°c / Other</option>
          </select>
        </div>

        <!-- M√£ l·ªõp -->
        <div class="form-group">
          <label for="malop">
            L·ªõp / Class code
          </label>
          <input id="malop" name="malop" class="control"
                 placeholder="VD: 11A3‚Ä¶" />
        </div>

        <!-- CCCD -->
        <div class="form-group">
          <div class="label-row">
            <label for="cccd">
              CCCD / Citizen ID
            </label>
            <span class="hint">D√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p, ch·ªâ nh·∫≠p <b>s·ªë</b>.</span>
          </div>
          <input id="cccd" name="cccd" class="control"
                 inputmode="numeric" pattern="[0-9]*"
                 placeholder="Ch·ªâ nh·∫≠p s·ªë / digits only" required />
        </div>

        <!-- Email -->
        <div class="form-group">
          <label for="email">
            Email (nh·∫≠n m·∫≠t kh·∫©u) / Email (for password)
          </label>
          <input id="email" name="email" class="control"
                 type="email"
                 placeholder="yourname@example.com" required />
        </div>

        <!-- Ghi ch√∫ -->
        <div class="form-group">
          <label for="ghichu">
            Ghi ch√∫ / Notes (optional)
          </label>
          <textarea id="ghichu" name="ghichu" class="control" rows="2"
                    placeholder="Nh·∫≠p th√™m th√¥ng tin n·∫øu c·∫ßn‚Ä¶"></textarea>
        </div>
      </form>

      <div class="actions">
        <button id="btn-reg-submit" class="primary">
          <span>G·ª≠i ƒëƒÉng k√Ω / Submit</span> <span>üì§</span>
        </button>
        <button id="btn-reg-reset" class="secondary">
          X√≥a form / Reset
        </button>
      </div>

      <div id="reg-message" class="alert small" style="display:none;"></div>
    </div>
  </section>

  <!-- ============ SECTION: LOGIN ============ -->
  <section id="section-login" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-header-title">ƒêƒÉng nh·∫≠p h·ªá th·ªëng / Sign in</div>
          <div class="card-header-sub">
            S·ª≠ d·ª•ng <b>CCCD + m·∫≠t kh·∫©u</b> ƒë√£ ƒë∆∞·ª£c g·ª≠i qua email sau khi ƒëƒÉng k√Ω.
          </div>
        </div>
        <div class="chip">STEP 2 ‚Äì LOGIN</div>
      </div>

      <form id="login-form">
        <div class="form-group">
          <label for="login-cccd">CCCD / Citizen ID</label>
          <input id="login-cccd" class="control" inputmode="numeric" pattern="[0-9]*"
                 placeholder="Nh·∫≠p CCCD‚Ä¶" required />
        </div>
        <div class="form-group">
          <label for="login-pass">M·∫≠t kh·∫©u / Password</label>
          <input id="login-pass" class="control" type="password"
                 autocomplete="current-password" required />
        </div>
      </form>

      <div class="actions">
        <button id="btn-login" class="primary">
          <span>ƒêƒÉng nh·∫≠p / Sign in</span> <span>üîê</span>
        </button>
        <button id="btn-logout" class="secondary" style="display:none;">
          ƒêƒÉng xu·∫•t / Logout
        </button>
      </div>

      <div id="login-message" class="alert small" style="display:none;"></div>
    </div>
  </section>

  <!-- ============ SECTION: EXAM ============ -->
  <section id="section-exam" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-header-title">V√†o thi / Take exam</div>
          <div class="card-header-sub">
            H·ªá th·ªëng hi·ªÉn th·ªã th√¥ng tin th√≠ sinh, h√¨nh th·ª©c ki·ªÉm tra v√† ƒë·∫øm ng∆∞·ª£c th·ªùi gian.
          </div>
        </div>
        <div class="chip">STEP 3 ‚Äì EXAM</div>
      </div>

      <div id="exam-user-info" class="alert info small">
        üîé Ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng v√†o m·ª•c <b>ƒêƒÉng nh·∫≠p / Login</b> tr∆∞·ªõc khi v√†o thi.
      </div>

      <form id="exam-config" class="grid-2">
        <div class="form-group">
          <label for="exam-type">H√¨nh th·ª©c ki·ªÉm tra / Exam type</label>
          <select id="exam-type" class="control">
            <option value="TKTx">TKTx ‚Äì Ki·ªÉm tra th∆∞·ªùng xuy√™n</option>
            <option value="TKDk">TKDk ‚Äì Ki·ªÉm tra ƒë·ªãnh k·ª≥</option>
            <option value="KTCk">KTCk ‚Äì Ki·ªÉm tra cu·ªëi k·ª≥</option>
          </select>
        </div>

        <div class="form-group">
          <label for="exam-subject">M√¥n / Subject</label>
          <select id="exam-subject" class="control">
            <option value="">Ch·ªçn m√¥n / Select‚Ä¶</option>
            <option>To√°n</option>
            <option>V·∫≠t l√≠</option>
            <option>H√≥a h·ªçc</option>
            <option>Sinh h·ªçc</option>
            <option>Tin h·ªçc</option>
            <option>Ng·ªØ vƒÉn</option>
            <option>L·ªãch s·ª≠</option>
            <option>ƒê·ªãa l√≠</option>
            <option>Ti·∫øng Anh</option>
            <option>GDKT&PL</option>
            <option>CNN (C√¥ng ngh·ªá c√¥ng nghi·ªáp)</option>
            <option>CNTrTr (CN Tr·ªìng tr·ªçt)</option>
            <option>Th·ªÉ d·ª•c</option>
            <option>Qu·ªëc ph√≤ng ‚Äì An ninh</option>
          </select>
        </div>

        <div class="form-group">
          <label for="exam-code">
            M√£ ca thi / Exam slot code
          </label>
          <input id="exam-code" class="control" placeholder="VD: 11A3-M1-TKTx-TOAN‚Ä¶" />
        </div>

        <div class="form-group">
          <label for="exam-duration">
            Th·ªùi l∆∞·ª£ng / Duration (ph√∫t / minutes)
          </label>
          <input id="exam-duration" class="control" type="number" min="5" max="180"
                 value="45" />
        </div>

        <div class="form-group">
          <label for="exam-url">
            Link ƒë·ªÅ (Google Form/Quiz) / Exam URL
          </label>
          <input id="exam-url" class="control"
                 placeholder="D√°n link Google Form t·∫°i ƒë√¢y‚Ä¶" />
        </div>

        <div class="form-group">
          <label for="exam-start">
            Th·ªùi gian b·∫Øt ƒë·∫ßu (t√πy ch·ªçn) / Start time (optional)
          </label>
          <input id="exam-start" type="datetime-local" class="control" />
        </div>
      </form>

      <div class="alert info small" id="exam-warning">
        ‚è∞ Khi b·∫•m ‚ÄúB·∫Øt ƒë·∫ßu l√†m b√†i‚Äù, ƒë·ªìng h·ªì s·∫Ω ƒë·∫øm ng∆∞·ª£c.
        H·∫øt gi·ªù h·ªá th·ªëng kh√≥a n√∫t ‚ÄúM·ªü ƒë·ªÅ thi‚Äù v√† nh·∫Øc h·ªçc sinh g·ª≠i b√†i tr√™n Form.
      </div>

      <div class="actions">
        <button id="btn-exam-start" class="primary" disabled>
          <span>B·∫Øt ƒë·∫ßu l√†m b√†i / Start</span> <span>‚ñ∂</span>
        </button>
        <span id="exam-timer" class="badge-timer" style="display:none;">
          00:00
        </span>
      </div>
    </div>
  </section>

  <!-- ============ SECTION: XEM K·∫æT QU·∫¢ ============ -->
  <section id="section-results" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-header-title">
            Xem l·∫°i k·∫øt qu·∫£ / View your results
          </div>
          <div class="card-header-sub">
            Tra c·ª©u theo <b>CCCD</b> ho·∫∑c <b>H·ªç t√™n + L·ªõp</b> (s·ª≠ d·ª•ng mode=search t·ª´ Code.gs).
          </div>
        </div>
        <div class="chip">RESULT LOOKUP</div>
      </div>

      <form id="search-form">
        <div class="form-group">
          <label for="search-cccd">CCCD / Citizen ID (∆∞u ti√™n)</label>
          <input id="search-cccd" class="control" inputmode="numeric" pattern="[0-9]*"
                 placeholder="Nh·∫≠p CCCD‚Ä¶" />
        </div>
        <div class="form-group">
          <label for="search-name">H·ªç t√™n / Full name (IN HOA)</label>
          <input id="search-name" class="control"
                 placeholder="NGUY·ªÑN VƒÇN B‚Ä¶" />
        </div>
        <div class="form-group">
          <label for="search-class">L·ªõp / Class</label>
          <input id="search-class" class="control" placeholder="VD: 12A1‚Ä¶" />
        </div>
      </form>

      <div class="actions">
        <button id="btn-search" class="primary">
          <span>Tra c·ª©u / Search</span> <span>üîé</span>
        </button>
      </div>

      <div id="search-message" class="alert small" style="display:none;"></div>

      <div id="search-results"></div>
    </div>
  </section>

  <!-- ============ SECTION: DASHBOARD ============ -->
  <section id="section-dashboard" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-header-title">Dashboard ‚Äì Th·ªëng k√™ nhanh</div>
          <div class="card-header-sub">
            L·∫•y d·ªØ li·ªáu t·ªïng h·ª£p qua <code>mode=stats</code> v√† danh s√°ch k·∫øt qu·∫£ m·ªõi qua
            <code>mode=results</code>.
          </div>
        </div>
        <div class="chip">OVERVIEW</div>
      </div>

      <div class="actions">
        <button id="btn-load-stats" class="secondary">
          T·∫£i th·ªëng k√™ / Load stats
        </button>
        <button id="btn-load-latest" class="secondary">
          Xem danh s√°ch g·∫ßn nh·∫•t / Latest results
        </button>
      </div>

      <div id="dash-summary" class="alert info small" style="margin-top:10px;display:none;"></div>
      <div id="dash-lists"></div>
    </div>
  </section>

</div>

<script>
  // ===== C·∫§U H√åNH SCRIPT URL =====
 // const SCRIPT_URL = "PASTE_WEB_APP_URL_HERE"; // TODO: thay URL Web App th·∫≠t
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxbG-oxupd6949_d6uUlVmvYaJly8t5voJNWuwsAzwoar9BAgcmn9_AJP-kH1hB_vyGLA/exec";
  let CURRENT_USER = null; // {hoten, cccd, email, lop, khoi, ...}
  let examTimer = null;
  let examRemainingSec = 0;

  // ===== NAV SWITCH =====
  const navButtons = document.querySelectorAll(".nav-btn");
  const sections = document.querySelectorAll(".section");

  navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      navButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.getAttribute("data-target");
      sections.forEach(sec => {
        sec.classList.toggle("active", sec.id === target);
      });
    });
  });

  // ===== DOB DROPDOWNS =====
  function initDobSelects() {
    const dSel = document.getElementById("dob-day");
    const mSel = document.getElementById("dob-month");
    const ySel = document.getElementById("dob-year");

    for (let d = 1; d <= 31; d++) {
      const opt = document.createElement("option");
      opt.value = String(d).padStart(2, "0");
      opt.textContent = d;
      dSel.appendChild(opt);
    }

    const monthNames = ["1","2","3","4","5","6","7","8","9","10","11","12"];
    monthNames.forEach((m, idx) => {
      const opt = document.createElement("option");
      const mVal = String(idx + 1).padStart(2, "0");
      opt.value = mVal;
      opt.textContent = m;
      mSel.appendChild(opt);
    });

    const currentYear = new Date().getFullYear();
    for (let y = currentYear - 25; y >= currentYear - 70; y--) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      ySel.appendChild(opt);
    }
  }
  initDobSelects();

  function getDobString() {
    const d = document.getElementById("dob-day").value;
    const m = document.getElementById("dob-month").value;
    const y = document.getElementById("dob-year").value;
    if (!d || !m || !y) return "";
    return `${d}/${m}/${y}`;
  }

  // ===== REGISTER =====
  const regForm = document.getElementById("reg-form");
  const regMsg = document.getElementById("reg-message");
  const btnRegSubmit = document.getElementById("btn-reg-submit");
  const btnRegReset = document.getElementById("btn-reg-reset");

  function showRegMessage(type, html) {
    regMsg.className = "alert small " + type;
    regMsg.innerHTML = html;
    regMsg.style.display = "block";
  }

  btnRegReset.addEventListener("click", () => {
    regForm.reset();
    regMsg.style.display = "none";
  });

  btnRegSubmit.addEventListener("click", async () => {
    const hotenInput = document.getElementById("hoten");
    const malopInput = document.getElementById("malop");
    const ngaysinhHidden = document.getElementById("ngaysinh");

    const dob = getDobString();
    if (!dob) {
      showRegMessage("danger", "Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß <b>Ng√†y / Th√°ng / NƒÉm</b>.");
      return;
    }
    ngaysinhHidden.value = dob;

    // Chu·∫©n h√≥a h·ªç t√™n + l·ªõp IN HOA
    if (hotenInput.value) {
      hotenInput.value = hotenInput.value.toUpperCase();
    }
    if (malopInput.value) {
      malopInput.value = malopInput.value.toUpperCase();
    }

    const formData = new FormData(regForm);
    // B·ªï sung tr∆∞·ªùng t·ª´ c√°c select ngo√†i grid
    formData.set("hoten", hotenInput.value.trim());
    formData.set("ngaysinh", ngaysinhHidden.value);

    const truongChon = document.getElementById("truong").value;
    const truongKhac = document.getElementById("truong_khac").value.trim();
    formData.set("truong", truongChon === "THPT kh√°c / Other" && truongKhac ? truongKhac : truongChon);

    const params = new URLSearchParams();
    for (const [k, v] of formData.entries()) {
      params.append(k, v);
    }

    btnRegSubmit.disabled = true;
    showRegMessage("info", "ƒêang g·ª≠i ƒëƒÉng k√Ω, vui l√≤ng ch·ªù‚Ä¶ / Sending registration‚Ä¶");

    try {
      // G·ª≠i POST sang Web App. Apps Script tr·∫£ v·ªÅ HTML; ta d√πng redirect ·∫©n.
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: params
      });
      // Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c body v√¨ no-cors; gi·∫£ ƒë·ªãnh OK:
      showRegMessage(
        "success",
        "H·ªá th·ªëng ƒë√£ nh·∫≠n ƒëƒÉng k√Ω (gi·∫£ ƒë·ªãnh).<br>" +
        "Vui l√≤ng ki·ªÉm tra <b>email</b> ƒë·ªÉ l·∫•y <b>m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p</b>. " +
        "N·∫øu kh√¥ng th·∫•y, h√£y ki·ªÉm tra h·ªôp th∆∞ r√°c ho·∫∑c li√™n h·ªá GV ph·ª• tr√°ch."
      );
      regForm.reset();
    } catch (err) {
      showRegMessage(
        "danger",
        "L·ªói khi g·ª≠i ƒëƒÉng k√Ω: " + err.toString() +
        "<br>Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c b√°o cho GV ph·ª• tr√°ch."
      );
    } finally {
      btnRegSubmit.disabled = false;
    }
  });

  // ===== JSONP HELPER =====
  function callJSONP(params, callbackName) {
    const cb = callbackName || ("jsonp_cb_" + Date.now());
    return new Promise((resolve, reject) => {
      const url = SCRIPT_URL + "?" +
        new URLSearchParams({
          ...params,
          callback: cb
        }).toString();

      const script = document.createElement("script");
      script.src = url;
      script.async = true;

      let timeoutId = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 15000);

      function cleanup() {
        clearTimeout(timeoutId);
        delete window[cb];
        script.remove();
      }

      window[cb] = function(data) {
        cleanup();
        resolve(data);
      };

      script.onerror = function() {
        cleanup();
        reject(new Error("JSONP error"));
      };

      document.body.appendChild(script);
    });
  }

  // ===== LOGIN via CCCD + PASSWORD (mode=auth) =====
  const loginForm = document.getElementById("login-form");
  const loginMsg = document.getElementById("login-message");
  const btnLogin = document.getElementById("btn-login");
  const btnLogout = document.getElementById("btn-logout");
  const examUserInfo = document.getElementById("exam-user-info");
  const btnExamStart = document.getElementById("btn-exam-start");

  function showLoginMessage(type, html) {
    loginMsg.className = "alert small " + type;
    loginMsg.innerHTML = html;
    loginMsg.style.display = "block";
  }

  btnLogin.addEventListener("click", async () => {
    const cccd = document.getElementById("login-cccd").value.trim();
    const pw = document.getElementById("login-pass").value;

    if (!cccd || !pw) {
      showLoginMessage("danger", "Vui l√≤ng nh·∫≠p ƒë·ªß <b>CCCD</b> v√† <b>m·∫≠t kh·∫©u</b>.");
      return;
    }

    btnLogin.disabled = true;
    showLoginMessage("info", "ƒêang ki·ªÉm tra th√¥ng tin ƒëƒÉng nh·∫≠p‚Ä¶");

    try {
      const data = await callJSONP(
        { mode: "auth", cccd: cccd, password: pw },
        "authCallback_" + Date.now()
      );

      if (!data || !data.ok) {
        showLoginMessage(
          "danger",
          (data && data.message) ? data.message :
          "CCCD ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng ki·ªÉm tra l·∫°i."
        );
        CURRENT_USER = null;
        examUserInfo.innerHTML = "üîé Ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng v√†o m·ª•c ƒêƒÉng nh·∫≠p / Login.";
        btnExamStart.disabled = true;
      } else {
        CURRENT_USER = data.user || {};
        showLoginMessage(
          "success",
          "ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Xin ch√†o <b>" +
          (CURRENT_USER.hoten || "") +
          "</b>."
        );
        btnLogin.style.display = "none";
        btnLogout.style.display = "inline-flex";

        const infoHtml =
          "<b>H·ªçc sinh / Student:</b> " + (CURRENT_USER.hoten || "") + "<br>" +
          "<b>CCCD:</b> " + (CURRENT_USER.cccd || "") + "<br>" +
          "<b>L·ªõp:</b> " + (CURRENT_USER.lop || "") + " ¬∑ <b>Kh·ªëi:</b> " + (CURRENT_USER.khoi || "") + "<br>" +
          "<b>Email:</b> " + (CURRENT_USER.email || "");
        examUserInfo.className = "alert info small";
        examUserInfo.innerHTML = infoHtml;
        btnExamStart.disabled = false;
      }
    } catch (err) {
      showLoginMessage("danger", "L·ªói ƒëƒÉng nh·∫≠p: " + err.toString());
    } finally {
      btnLogin.disabled = false;
    }
  });

  btnLogout.addEventListener("click", () => {
    CURRENT_USER = null;
    loginForm.reset();
    btnLogin.style.display = "inline-flex";
    btnLogout.style.display = "none";
    loginMsg.style.display = "none";
    examUserInfo.className = "alert info small";
    examUserInfo.innerHTML =
      "üîé Ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng v√†o m·ª•c <b>ƒêƒÉng nh·∫≠p / Login</b> tr∆∞·ªõc khi v√†o thi.";
    btnExamStart.disabled = true;
  });

  // ===== EXAM TIMER & OPEN FORM =====
  function updateTimerDisplay() {
    const timerEl = document.getElementById("exam-timer");
    if (examRemainingSec <= 0) {
      timerEl.textContent = "00:00";
      clearInterval(examTimer);
      examTimer = null;
      btnExamStart.disabled = true;
      document.getElementById("exam-warning").className = "alert danger small";
      document.getElementById("exam-warning").innerHTML =
        "‚è∞ ƒê√É H·∫æT GI·ªú. H·ªá th·ªëng ƒë√£ kh√≥a ca thi. H·ªçc sinh ph·∫£i ƒë·∫£m b·∫£o ƒë√£ b·∫•m G·ª¨I b√†i tr√™n Google Form.";
      return;
    }
    const m = Math.floor(examRemainingSec / 60);
    const s = examRemainingSec % 60;
    timerEl.textContent =
      String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    examRemainingSec--;
  }

  btnExamStart.addEventListener("click", () => {
    if (!CURRENT_USER) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.");
      return;
    }

    const subject = document.getElementById("exam-subject").value;
    const type = document.getElementById("exam-type").value;
    const code = document.getElementById("exam-code").value.trim();
    const duration = parseInt(document.getElementById("exam-duration").value || "45", 10);
    const url = document.getElementById("exam-url").value.trim();

    if (!subject || !url) {
      alert("Vui l√≤ng ch·ªçn m√¥n v√† nh·∫≠p Link ƒë·ªÅ (Google Form).");
      return;
    }

    examRemainingSec = duration * 60;
    document.getElementById("exam-timer").style.display = "inline-flex";
    updateTimerDisplay();
    if (examTimer) clearInterval(examTimer);
    examTimer = setInterval(updateTimerDisplay, 1000);

    // M·ªü ƒë·ªÅ thi (Google Form) trong tab m·ªõi, c√≥ th·ªÉ b·ªï sung query string n·∫øu c·∫ßn
    window.open(url, "_blank", "noopener");

    const warn = document.getElementById("exam-warning");
    warn.className = "alert info small";
    warn.innerHTML =
      "‚è± Ca thi <b>" + (code || "(ch∆∞a ƒë·∫∑t m√£)") + "</b>, m√¥n <b>" + subject +
      "</b>, h√¨nh th·ª©c <b>" + type + "</b>. ƒê·ªìng h·ªì ƒëang ƒë·∫øm ng∆∞·ª£c, h√£y n·ªôp b√†i tr∆∞·ªõc khi h·∫øt gi·ªù.";
  });

  // ===== SEARCH RESULT (mode=search) =====
  const btnSearch = document.getElementById("btn-search");
  const searchMsg = document.getElementById("search-message");
  const searchResultsDiv = document.getElementById("search-results");

  btnSearch.addEventListener("click", async () => {
    const cccd = document.getElementById("search-cccd").value.trim();
    let name = document.getElementById("search-name").value.trim();
    const cl = document.getElementById("search-class").value.trim().toUpperCase();

    if (!cccd && !name) {
      searchMsg.style.display = "block";
      searchMsg.className = "alert danger small";
      searchMsg.innerHTML = "Vui l√≤ng nh·∫≠p <b>CCCD</b> ho·∫∑c <b>H·ªç t√™n</b>.";
      return;
    }

    if (name) name = name.toUpperCase();

    searchMsg.style.display = "block";
    searchMsg.className = "alert info small";
    searchMsg.innerHTML = "ƒêang tra c·ª©u k·∫øt qu·∫£‚Ä¶";

    try {
      const data = await callJSONP({
        mode: "search",
        cccd: cccd,
        name: name,
        className: cl
      }, "searchCallback_" + Date.now());

      if (!data || !data.found) {
        searchMsg.className = "alert danger small";
        searchMsg.innerHTML = data && data.message
          ? data.message
          : "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.";
        searchResultsDiv.innerHTML = "";
        return;
      }

      searchMsg.className = "alert success small";
      searchMsg.innerHTML = data.message || "ƒê√£ t√¨m th·∫•y k·∫øt qu·∫£.";

      const rows = data.results || [];
      let html = "<table class='table'><thead><tr>" +
        "<th>Th·ªùi gian</th><th>H·ªç t√™n</th><th>L·ªõp</th><th>ƒêi·ªÉm</th>" +
        "<th>Gi·ªõi t√≠nh</th><th>D√¢n t·ªôc</th><th>Tr∆∞·ªùng</th><th>CCCD</th>" +
        "</tr></thead><tbody>";
      rows.forEach(r => {
        html += "<tr>" +
          "<td>" + (r.timestamp || "") + "</td>" +
          "<td>" + (r.name || "") + "</td>" +
          "<td>" + (r.className || "") + "</td>" +
          "<td><b>" + (r.score || "") + "</b></td>" +
          "<td>" + (r.gender || "") + "</td>" +
          "<td>" + (r.ethnic || "") + "</td>" +
          "<td>" + (r.school || "") + "</td>" +
          "<td>" + (r.cccd || "") + "</td>" +
          "</tr>";
      });
      html += "</tbody></table>";
      searchResultsDiv.innerHTML = html;
    } catch (err) {
      searchMsg.className = "alert danger small";
      searchMsg.innerHTML = "L·ªói tra c·ª©u: " + err.toString();
      searchResultsDiv.innerHTML = "";
    }
  });

  // ===== DASHBOARD (mode=stats & mode=results) =====
  const btnLoadStats = document.getElementById("btn-load-stats");
  const btnLoadLatest = document.getElementById("btn-load-latest");
  const dashSummary = document.getElementById("dash-summary");
  const dashLists = document.getElementById("dash-lists");

  btnLoadStats.addEventListener("click", async () => {
    dashSummary.style.display = "block";
    dashSummary.className = "alert info small";
    dashSummary.innerHTML = "ƒêang t·∫£i th·ªëng k√™‚Ä¶";

    try {
      const data = await callJSONP({ mode: "stats" }, "statsCallback_" + Date.now());
      if (!data) throw new Error("No data");
      const byGrade = data.byGrade || {};
      const byClass = data.byClass || {};
      const total = data.total || 0;

      let html = "<b>T·ªïng s·ªë b√†i:</b> " + total + "<br><br>";
      html += "<b>Theo kh·ªëi:</b><br>";
      html += "<div>";
      Object.keys(byGrade).forEach(k => {
        const g = byGrade[k];
        html += "<span class='pill' style='margin-right:6px;margin-bottom:4px;'>" +
          "Kh·ªëi " + k + ": " + g.count + "</span>";
      });
      html += "</div>";

      html += "<br><b>Top l·ªõp theo s·ªë b√†i:</b>";
      const classEntries = Object.entries(byClass);
      classEntries.sort((a, b) => b[1].count - a[1].count);
      html += "<table class='table'><thead><tr><th>L·ªõp</th><th>S·ªë b√†i</th><th>ƒêi·ªÉm TB (tham kh·∫£o)</th></tr></thead><tbody>";
      classEntries.slice(0, 10).forEach(([cls, info]) => {
        const avg = info.count ? (info.total / info.count).toFixed(2) : "-";
        html += `<tr><td>${cls}</td><td>${info.count}</td><td>${avg}</td></tr>`;
      });
      html += "</tbody></table>";

      dashSummary.className = "alert success small";
      dashSummary.innerHTML = html;
    } catch (err) {
      dashSummary.className = "alert danger small";
      dashSummary.innerHTML = "L·ªói t·∫£i th·ªëng k√™: " + err.toString();
    }
  });

  btnLoadLatest.addEventListener("click", async () => {
    dashLists.innerHTML = "";
    try {
      const data = await callJSONP({ mode: "results" }, "resultsCallback_" + Date.now());
      const rows = (data && data.rows) || [];
      if (!rows.length) {
        dashLists.innerHTML = "<div class='alert info small'>Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm.</div>";
        return;
      }
      let html = "<h4 class='small'>Danh s√°ch k·∫øt qu·∫£ m·ªõi nh·∫•t</h4>";
      html += "<table class='table'><thead><tr><th>Th·ªùi gian</th><th>H·ªç t√™n</th><th>L·ªõp</th><th>ƒêi·ªÉm</th></tr></thead><tbody>";
      rows.forEach(r => {
        html += `<tr><td>${r.time || ""}</td><td>${r.name || ""}</td><td>${r.class || ""}</td><td><b>${r.score || ""}</b></td></tr>`;
      });
      html += "</tbody></table>";
      dashLists.innerHTML = html;
    } catch (err) {
      dashLists.innerHTML =
        "<div class='alert danger small'>L·ªói t·∫£i danh s√°ch: " + err.toString() + "</div>";
    }
  });

  // ƒêƒÉng k√Ω Service Worker cho PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('sw.js')
        .catch(function (err) {
          console.log('SW registration failed:', err);
        });
    });
  }
  
</script>
</body>
</html>
