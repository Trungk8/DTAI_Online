<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>DTAI Online ‚Äì ƒêƒÉng k√Ω & Ki·ªÉm tra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #020617;
      --card: #0b1220;
      --accent: #2563eb;
      --accent-soft: #1d4ed8;
      --accent-grad-1: #4f46e5;
      --accent-grad-2: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --border: #1f2937;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-strong: 0 30px 80px rgba(15,23,42,0.85);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .shell {
      width: 100%;
      max-width: 1080px;
      background: radial-gradient(circle at top left,#1f2937,#020617);
      border-radius: 28px;
      padding: 22px 22px 24px;
      box-shadow: var(--shadow-strong);
      border: 1px solid rgba(148,163,184,0.25);
      position: relative;
      overflow: hidden;
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 20%, rgba(59,130,246,0.20) 0, transparent 60%),
        radial-gradient(circle at 80% 0, rgba(56,189,248,0.18) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(99,102,241,0.20) 0, transparent 60%);
      opacity: .7;
      pointer-events: none;
    }

    .shell-inner {
      position: relative;
      z-index: 1;
    }

    header.app-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 14px;
    }

    .logo-circle {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      padding: 2px;
      background: conic-gradient(from 160deg, #22c55e, #2563eb, #a855f7, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 15px 40px rgba(37,99,235,0.5);
      flex-shrink: 0;
      overflow: hidden;
    }

    .logo-circle-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 20%, #1f2937, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      font-weight: 700;
      font-size: 0.9rem;
      text-align: center;
      padding: 4px;
    }

    /* Thay b·∫±ng logo tr∆∞·ªùng th·∫≠t n·∫øu mu·ªën */
    .logo-circle-inner img {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      object-fit: cover;
      display: none; /* B·∫≠t l√™n khi c√≥ logo th·∫≠t */
    }

    .app-title-block {
      flex: 1;
      min-width: 0;
    }

    .app-kicker {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #93c5fd;
    }

    .app-title {
      margin: 2px 0 4px;
      font-size: 1.2rem;
      font-weight: 650;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: baseline;
    }

    .app-title span.en {
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 500;
    }

    .app-subtitle {
      font-size: 0.86rem;
      color: var(--muted);
    }

    nav.app-nav {
      display: flex;
      gap: 6px;
      margin: 10px 0 12px;
      flex-wrap: wrap;
    }

    nav.app-nav button {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.9);
      color: #d1d5db;
      padding: 7px 10px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      backdrop-filter: blur(14px);
      transition: all .18s ease-out;
    }

    nav.app-nav button span.icon {
      font-size: 0.9rem;
    }

    nav.app-nav button.active {
      background: radial-gradient(circle at top left, #22c55e, #2563eb);
      color: #f9fafb;
      border-color: transparent;
      box-shadow: 0 12px 30px rgba(37,99,235,0.65);
    }

    nav.app-nav button:hover:not(.active) {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    main.app-main {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.35);
      background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(15,23,42,0.98));
      padding: 16px 16px 14px;
      min-height: 320px;
      max-height: calc(100vh - 170px);
      overflow: auto;
    }

    section.page {
      display: none;
      animation: fadeIn .2s ease-out;
    }

    section.page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      margin: 0 0 4px;
      font-size: 1.02rem;
    }
    .section-desc {
      margin: 0 0 12px;
      font-size: 0.83rem;
      color: var(--muted);
    }

    form {
      margin-top: 4px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 10px 12px;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: minmax(0,1fr);
      }
      .shell {
        padding: 16px 14px 18px;
        border-radius: 22px;
      }
      main.app-main {
        max-height: none;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 8px;
    }

    .field label {
      font-size: 0.8rem;
      color: #cbd5f5;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .field label span.en {
      font-size: 0.74rem;
      color: #9ca3af;
      font-weight: 400;
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.88);
      padding: 6px 9px;
      color: #e5e7eb;
      font-size: 0.8rem;
      outline: none;
      width: 100%;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: #6b7280;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.5);
    }

    .field textarea {
      resize: vertical;
      min-height: 48px;
      max-height: 120px;
    }

    .hint {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .note-small {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.82rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      background-image: linear-gradient(120deg,var(--accent-grad-1),var(--accent-grad-2));
      color: #f9fafb;
      cursor: pointer;
      box-shadow: 0 16px 40px rgba(56,189,248,0.55);
      margin-top: 6px;
    }
    .btn-primary .icon {
      font-size: 0.92rem;
    }
    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .status-msg {
      margin-top: 8px;
      font-size: 0.78rem;
    }
    .status-empty { color: var(--muted); }
    .status-error { color: #fca5a5; }
    .status-ok    { color: #4ade80; }

    .exam-student-card{
      margin-bottom: 16px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(148,163,184,0.6);
      font-size: 0.8rem;
    }
    .exam-student-card h3{
      margin: 0 0 6px;
      font-size: 0.9rem;
    }
    .exam-student-card p{
      margin: 2px 0;
    }

    .exam-time-box{
      margin: 12px 0 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(30,64,175,0.25);
      border: 1px solid rgba(129,140,248,0.7);
      font-size: 0.8rem;
    }
    .exam-time-box b{
      color: #bfdbfe;
    }
    .exam-time-box .time-main{
      font-weight: 600;
      color: #e5e7eb;
    }

    .question-card {
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 8px 10px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.9);
      font-size: 0.78rem;
    }
    .question-card .q-code {
      font-size: 0.72rem;
      color: #9ca3af;
    }
    .question-card .q-text {
      margin: 4px 0;
    }
    .question-card ul {
      padding-left: 18px;
      margin: 4px 0;
    }
    .question-card li span.key {
      font-weight: 600;
      color: #4ade80;
      margin-left: 4px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:0.7rem;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(31,41,55,0.95);
      border:1px solid rgba(148,163,184,0.7);
      color:#e5e7eb;
    }

  </style>
</head>
<body>
  <div class="shell">
    <div class="shell-inner">
      <header class="app-header">
        <div class="logo-circle">
          <div class="logo-circle-inner">
            <!-- N·∫øu c√≥ LOGO PNG/JPG c·ªßa Tr∆∞·ªùng, b·∫≠t d√≤ng d∆∞·ªõi v√† t·∫Øt ch·ªØ DTAI -->
            <!-- <img src="LINK_LOGO_TRUONG.png" alt="Logo"> -->
            <span>DTAI<br>Online</span>
          </div>
        </div>
        <div class="app-title-block">
          <div class="app-kicker">DTAI ‚Äì Digital Testing & Assessment Initiative</div>
          <div class="app-title">
            <span>H·ªá th·ªëng ki·ªÉm tra Online</span>
            <span class="en">/ Online Assessment System</span>
          </div>
          <div class="app-subtitle">
            Tr∆∞·ªùng THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu ‚Äì Song ng·ªØ Vi·ªát‚ÄìAnh / Bilingual VI‚ÄìEN
          </div>
        </div>
      </header>

      <nav class="app-nav">
        <button class="active" onclick="show('register', this)"><span class="icon">üìù</span><span>ƒêƒÉng k√Ω / Register</span></button>
        <button onclick="show('login', this)"><span class="icon">üîê</span><span>ƒêƒÉng nh·∫≠p / Login</span></button>
        <button onclick="show('exam', this)"><span class="icon">üß™</span><span>V√†o thi / Take exam</span></button>
        <button onclick="show('bank', this)"><span class="icon">üìö</span><span>Ng√¢n h√†ng c√¢u h·ªèi / Question bank</span></button>
      </nav>

      <main class="app-main">
        <!-- 1. ƒêƒÇNG K√ù / REGISTRATION -->
        <section id="register" class="page active">
          <h2 class="section-title">ƒêƒÉng k√Ω th√≠ sinh / Candidate registration</h2>
          <p class="section-desc">
            ƒêi·ªÅn th√¥ng tin ƒë·∫ßy ƒë·ªß, ch√≠nh x√°c. Sau khi ƒëƒÉng k√Ω, h·ªá th·ªëng s·∫Ω g·ª≠i m·∫≠t kh·∫©u truy c·∫≠p v·ªÅ email c·ªßa b·∫°n. /
            Please fill in accurate information. A personal password will be sent to your email after registration.
          </p>

          <!-- POST th·∫≥ng v√†o Apps Script -->
          <form id="regForm" method="post" target="_blank">
            <div class="grid-2">
              <div class="field">
                <label for="hoten">
                  <span>H·ªç v√† t√™n</span>
                  <span class="en">Full name</span>
                </label>
                <input id="hoten" name="hoten" placeholder="Nguy·ªÖn VƒÉn A..." required />
                <div class="hint">Ghi IN HOA s·∫Ω ƒë∆∞·ª£c h·ªá th·ªëng t·ª± x·ª≠ l√Ω / System will convert to UPPERCASE.</div>
              </div>

              <div class="field">
                <label for="ngaysinh">
                  <span>Ng√†y sinh</span>
                  <span class="en">Date of birth</span>
                </label>
                <input id="ngaysinh" name="ngaysinh" inputmode="numeric" placeholder="dd/mm/yyyy" />
                <div class="hint">Nh·∫≠p tr·ª±c ti·∫øp: 01/09/2008 (d·ªÖ nh·∫≠p tr√™n ƒëi·ªán tho·∫°i) / Type directly: 01/09/2008.</div>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="gioitinh">
                  <span>Gi·ªõi t√≠nh</span><span class="en">Gender</span>
                </label>
                <select id="gioitinh" name="gioitinh">
                  <option value="">-- Ch·ªçn / Select --</option>
                  <option value="Nam">Nam / Male</option>
                  <option value="N·ªØ">N·ªØ / Female</option>
                  <option value="Kh√°c">Kh√°c / Other</option>
                </select>
              </div>

              <div class="field">
                <label for="khoi">
                  <span>Kh·ªëi</span><span class="en">Grade</span>
                </label>
                <select id="khoi" name="khoi">
                  <option value="">-- Ch·ªçn / Select --</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="dantoc">
                  <span>D√¢n t·ªôc</span><span class="en">Ethnicity</span>
                </label>
                <select id="dantoc" name="dantoc">
                  <option value="">-- Ch·ªçn / Select --</option>
                  <option value="Kinh">Kinh</option>
                  <option value="M'N√¥ng">M'N√¥ng</option>
                  <option value="√äƒë√™">√äƒë√™</option>
                  <option value="Chu Ru">Chu Ru</option>
                  <option value="Kh√°c">Kh√°c / Other</option>
                </select>
              </div>

              <div class="field">
                <label for="truong">
                  <span>Tr∆∞·ªùng</span><span class="en">School</span>
                </label>
                <select id="truong" name="truong">
                  <option value="">-- Ch·ªçn / Select --</option>
                  <option value="THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu">THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
                  <option value="THPT Ph·∫°m VƒÉn ƒê·ªìng">THPT Ph·∫°m VƒÉn ƒê·ªìng</option>
                  <option value="THCS & THPT kh√°c">Tr∆∞·ªùng kh√°c / Other school</option>
                </select>
                <div class="hint">N·∫øu kh√¥ng c√≥ trong danh s√°ch, ghi r√µ ·ªü √¥ Ghi ch√∫. / If not in the list, use Notes.</div>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="xa">
                  <span>X√£/Ph∆∞·ªùng</span><span class="en">Ward/Commune</span>
                </label>
                <input id="xa" name="xa" placeholder="Qu·∫£ng T√≠n..." />
              </div>

              <div class="field">
                <label for="tinh">
                  <span>T·ªânh/TP</span><span class="en">Province/City</span>
                </label>
                <select id="tinh" name="tinh">
                  <option value="">-- Ch·ªçn / Select --</option>
                  <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                  <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
                  <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
                  <option value="Kh√°c">Kh√°c / Other</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="malop">
                  <span>L·ªõp</span><span class="en">Class</span>
                </label>
                <input id="malop" name="malop" placeholder="12A1, 11B2..." />
                <div class="hint">H·ªá th·ªëng s·∫Ω t·ª± chuy·ªÉn sang IN HOA. / System will convert to UPPERCASE.</div>
              </div>

              <div class="field">
                <label for="cccd">
                  <span>CCCD</span><span class="en">Citizen ID</span>
                </label>
                <input id="cccd" name="cccd" inputmode="numeric" placeholder="Ch·ªâ nh·∫≠p s·ªë / Digits only" required />
                <div class="hint">D√πng CCCD n√†y ƒë·ªÉ ƒëƒÉng nh·∫≠p h·ªá th·ªëng. / Use this CCCD to login.</div>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="email">
                  <span>Email</span><span class="en">Email</span>
                </label>
                <input id="email" name="email" type="email" placeholder="yourname@gmail.com" required />
                <div class="hint">H·ªá th·ªëng g·ª≠i m·∫≠t kh·∫©u v·ªÅ email n√†y. / Password will be sent to this email.</div>
              </div>

              <div class="field">
                <label for="ghichu">
                  <span>Ghi ch√∫</span><span class="en">Notes</span>
                </label>
                <textarea id="ghichu" name="ghichu" placeholder="Ghi ch√∫ th√™m n·∫øu c·∫ßn / Any extra notes"></textarea>
              </div>
            </div>

            <button type="submit" class="btn-primary">
              <span class="icon">üöÄ</span>
              <span>G·ª≠i ƒëƒÉng k√Ω / Submit registration</span>
            </button>
            <div class="note-small">
              Sau khi b·∫•m G·ª≠i, h·ªá th·ªëng Apps Script s·∫Ω m·ªü trang th√¥ng b√°o v√† g·ª≠i email x√°c nh·∫≠n. /
              After submitting, Apps Script will show a confirmation page and send an email.
            </div>
          </form>
        </section>

        <!-- 2. ƒêƒÇNG NH·∫¨P / LOGIN -->
        <section id="login" class="page">
          <h2 class="section-title">ƒêƒÉng nh·∫≠p h·ªá th·ªëng / Login</h2>
          <p class="section-desc">
            S·ª≠ d·ª•ng CCCD v√† m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i qua email sau khi ƒëƒÉng k√Ω. /
            Use your CCCD and password sent to your email after registration.
          </p>

          <form id="loginForm">
            <div class="grid-2">
              <div class="field">
                <label for="login_cccd">
                  <span>CCCD</span><span class="en">Citizen ID</span>
                </label>
                <input id="login_cccd" name="cccd" inputmode="numeric" placeholder="Ch·ªâ nh·∫≠p s·ªë / Digits only" required />
                <div class="hint">Gi·ªëng CCCD ƒë√£ d√πng khi ƒëƒÉng k√Ω. / Same CCCD as in registration.</div>
              </div>
              <div class="field">
                <label for="login_pass">
                  <span>M·∫≠t kh·∫©u</span><span class="en">Password</span>
                </label>
                <input id="login_pass" name="pass" type="password" placeholder="M·∫≠t kh·∫©u 6 k√Ω t·ª± / 6-char password" required />
                <div class="hint">Do h·ªá th·ªëng sinh t·ª± ƒë·ªông v√† g·ª≠i email. / Generated automatically and emailed.</div>
              </div>
            </div>

            <button type="submit" class="btn-primary">
              <span class="icon">üîê</span>
              <span>ƒêƒÉng nh·∫≠p / Login</span>
            </button>
            <div class="note-small">
              Qu√™n m·∫≠t kh·∫©u? Li√™n h·ªá gi√°o vi√™n ph·ª• tr√°ch ƒë·ªÉ ƒë∆∞·ª£c c·∫•p l·∫°i. /
              Forgot password? Contact your teacher to reset.
            </div>
          </form>

          <div id="loginStatus" class="status-msg status-empty"></div>
        </section>

        <!-- 3. V√ÄO THI / TAKE EXAM -->
        <section id="exam" class="page">
          <h2 class="section-title">V√†o thi / Take exam</h2>
          <p class="section-desc">
            H·ªçc sinh c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc, h·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã th√¥ng tin v√† danh s√°ch ca thi ƒëang m·ªü. /
            Students must login first, system will show their info and active exam sessions.
          </p>

          <div id="examNeedsLogin" class="note-small">
            B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng v√†o tab <b>ƒêƒÉng nh·∫≠p / Login</b> ƒë·ªÉ ti·∫øp t·ª•c. /
            You are not logged in yet. Please go to <b>Login</b> tab first.
          </div>

          <div id="examPanel" style="display:none;">
            <div class="exam-student-card">
              <h3>Th√¥ng tin th√≠ sinh / Candidate info</h3>
              <p><b>H·ªç v√† t√™n / Name:</b> <span id="examStudentName"></span></p>
              <p><b>CCCD:</b> <span id="examStudentCccd"></span></p>
              <p><b>Email:</b> <span id="examStudentEmail"></span></p>
              <p><b>L·ªõp / Class:</b> <span id="examStudentClass"></span></p>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="subjectSelect">
                  <span>M√¥n ki·ªÉm tra</span><span class="en">Subject</span>
                </label>
                <select id="subjectSelect">
                  <option value="">-- Ch·ªçn m√¥n / Select subject --</option>
                  <option>To√°n</option>
                  <option>L√Ω</option>
                  <option>H√≥a</option>
                  <option>Sinh</option>
                  <option>Tin</option>
                  <option>VƒÉn</option>
                  <option>S·ª≠</option>
                  <option>ƒê·ªãa</option>
                  <option>Ngo·∫°i ng·ªØ</option>
                  <option>GDKTPL</option>
                  <option>CNN</option>
                  <option>CNTrTr</option>
                  <option>Th·ªÉ d·ª•c</option>
                  <option>Qu·ªëc ph√≤ng an ninh</option>
                </select>
                <div class="hint">M√¥n d√πng cho th·ªëng k√™, b√°o c√°o SK. / Used for reporting.</div>
              </div>

              <div class="field">
                <label for="examSelect">
                  <span>M√£ ca thi</span><span class="en">Exam session</span>
                </label>
                <select id="examSelect">
                  <option value="">-- Ch·ªçn ca thi / Select exam --</option>
                </select>
                <div class="hint">
                  D·ªØ li·ªáu t·ª´ sheet <b>CauHinhThi</b> (MaKyThi, HinhThuc TKTx/TKDk/KTCK...). /
                  Data is from <b>CauHinhThi</b> sheet.
                </div>
              </div>
            </div>

            <div class="exam-time-box">
              <div><b>H√¨nh th·ª©c / Type:</b> <span id="examType">‚Äì</span></div>
              <div><b>Th·ªùi gian / Time:</b> <span id="examTimeRange" class="time-main">‚Äì</span></div>
              <div><b>C√≤n l·∫°i / Remaining:</b> <span id="examCountdown">‚Äì</span></div>
              <div id="examWarning" class="note-small"></div>
            </div>

            <button class="btn-primary" type="button" onclick="startExam()">
              <span class="icon">üß™</span>
              <span>V√†o l√†m b√†i / Start exam</span>
            </button>
          </div>
        </section>

        <!-- 4. NG√ÇN H√ÄNG C√ÇU H·ªéI / QUESTION BANK PREVIEW -->
        <section id="bank" class="page">
          <h2 class="section-title">Ng√¢n h√†ng c√¢u h·ªèi / Question bank</h2>
          <p class="section-desc">
            D·ªØ li·ªáu ƒë∆∞·ª£c import t·ª´ file Word ‚Üí Google Docs ‚Üí b·∫£ng QuestionBank trong Google Sheet. /
            Data is imported from Word ‚Üí Google Docs ‚Üí QuestionBank sheet.
          </p>

          <div class="grid-2">
            <div class="field">
              <label for="bankType">
                <span>Lo·∫°i c√¢u h·ªèi</span><span class="en">Question type</span>
              </label>
              <select id="bankType">
                <option value="">(T·∫•t c·∫£ / All)</option>
                <option value="SC">SC ‚Äì M·ªôt ƒë√°p √°n ƒë√∫ng / Single choice</option>
                <option value="MC">MC ‚Äì Nhi·ªÅu ƒë√°p √°n ƒë√∫ng / Multiple choice</option>
                <option value="TF1">TF1 ‚Äì ƒê√∫ng/Sai, 1 l·ª±a ch·ªçn</option>
                <option value="TFM">TFM ‚Äì Nhi·ªÅu m·ªánh ƒë·ªÅ ƒê/S</option>
              </select>
            </div>
            <div class="field">
              <label for="bankLimit">
                <span>S·ªë c√¢u hi·ªÉn th·ªã</span><span class="en">Number of questions</span>
              </label>
              <input id="bankLimit" type="number" min="1" max="100" value="10" />
            </div>
          </div>

          <button type="button" class="btn-primary" onclick="loadBankPreview()">
            <span class="icon">üì•</span>
            <span>T·∫£i xem nhanh / Load preview</span>
          </button>

          <div id="bankStatus" class="status-msg status-empty"></div>
          <div id="bankList" style="margin-top:8px;"></div>

          <div class="note-small">
            C·∫•u tr√∫c Word/Docs: m·ªói h√†ng l√† 1 c√¢u, c√°c c·ªôt Code, QuestionVI/EN, Type (SC/MC/TF1/TFM),
            A/B/C/D_VI/EN + Key, ExplanationVI/EN. /  
            Word/Docs structure: each row is a question with Code, QuestionVI/EN, Type, A/B/C/D + Key, Explanation.
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // üëâ CH·ªàNH L·∫†I WEB_APP_URL TH√ÄNH LINK DEPLOY APPS SCRIPT C·ª¶A TH·∫¶Y
    const WEB_APP_URL = "PASTE_WEB_APP_URL_HERE";

    function show(pageId, btn) {
      document.querySelectorAll("section.page").forEach(sec => {
        sec.classList.toggle("active", sec.id === pageId);
      });
      document.querySelectorAll("nav.app-nav button").forEach(b => {
        b.classList.toggle("active", b === btn);
      });
    }

    // JSONP helper
    function callJsonp(url, cbName) {
      return new Promise((resolve, reject) => {
        const callbackName = cbName || ("cb_" + Math.random().toString(36).slice(2));
        const script = document.createElement("script");
        const sep = url.includes("?") ? "&" : "?";
        const finalUrl = url + sep + "callback=" + encodeURIComponent(callbackName);

        window[callbackName] = (data) => {
          resolve(data);
          cleanup();
        };

        function cleanup() {
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.src = finalUrl;
        script.onerror = () => {
          cleanup();
          reject(new Error("JSONP error"));
        };
        document.body.appendChild(script);
      });
    }

    // -------- GLOBAL STATE --------
    let currentStudent = null;
    let examList = [];
    let currentExam = null;
    let countdownTimer = null;

    function setLoggedInStudent(st) {
      currentStudent = st || null;
      const panel = document.getElementById("examPanel");
      const msg   = document.getElementById("examNeedsLogin");

      if (currentStudent) {
        if (panel) panel.style.display = "block";
        if (msg)   msg.style.display = "none";

        document.getElementById("examStudentName").textContent  = currentStudent.name || "";
        document.getElementById("examStudentCccd").textContent  = currentStudent.cccd || "";
        document.getElementById("examStudentEmail").textContent = currentStudent.email || "";
        document.getElementById("examStudentClass").textContent = currentStudent.className || "";

        // T·∫£i danh s√°ch ca thi
        loadExamList();

      } else {
        if (panel) panel.style.display = "none";
        if (msg)   msg.style.display = "block";
      }
    }

    // -------- LOGIN --------
    function buildAuthUrl() {
      let cccd = document.getElementById("login_cccd").value.trim();
      let pass = document.getElementById("login_pass").value.trim();
      cccd = cccd.replace(/\D/g, "");
      const p = new URLSearchParams();
      if (cccd) p.append("cccd", cccd);
      if (pass) p.append("pass", pass);
      p.append("mode", "auth");
      return WEB_APP_URL + "?" + p.toString();
    }

    function renderLoginResult(data) {
      const statusEl = document.getElementById("loginStatus");
      if (!data) {
        statusEl.textContent = "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ m√°y ch·ªß. / No response from server.";
        statusEl.className = "status-msg status-error";
        return;
      }

      if (data.ok) {
        const st = data.student || {};
        setLoggedInStudent(st);
        statusEl.textContent =
          "ƒêƒÉng nh·∫≠p th√†nh c√¥ng / Login success: " +
          (st.name || "") +
          (st.className ? " ‚Äì L·ªõp / Class " + st.className : "") +
          ". Chuy·ªÉn sang tab 'V√†o thi' ƒë·ªÉ ti·∫øp t·ª•c. / Go to 'Take exam'.";
        statusEl.className = "status-msg status-ok";

        // Chuy·ªÉn lu√¥n sang tab V√†o thi
        const btnExam = Array.from(document.querySelectorAll("nav.app-nav button"))
          .find(b => b.textContent.includes("V√†o thi"));
        if (btnExam) show("exam", btnExam);

      } else {
        statusEl.textContent = data.message || "Sai CCCD ho·∫∑c m·∫≠t kh·∫©u. / Invalid CCCD or password.";
        statusEl.className = "status-msg status-error";
        setLoggedInStudent(null);
      }
    }

    document.getElementById("loginForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const statusEl = document.getElementById("loginStatus");
      statusEl.textContent = "ƒêang ki·ªÉm tra th√¥ng tin‚Ä¶ / Checking credentials‚Ä¶";
      statusEl.className = "status-msg status-empty";

      try {
        const url = buildAuthUrl();
        const data = await callJsonp(url, "authCallback");
        renderLoginResult(data);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "C√≥ l·ªói khi ƒëƒÉng nh·∫≠p. Ki·ªÉm tra Code.gs ho·∫∑c m·∫°ng. / Login error.";
        statusEl.className = "status-msg status-error";
      }
    });

    // -------- EXAM LIST & COUNTDOWN --------
    function loadExamList() {
      callJsonp(WEB_APP_URL + "?mode=examList", "examListCallback")
        .then(data => {
          examList = (data && data.exams) ? data.exams : [];
          const sel = document.getElementById("examSelect");
          if (!sel) return;
          sel.innerHTML = '<option value="">-- Ch·ªçn ca thi / Select exam --</option>';

          examList.forEach(ex => {
            const opt = document.createElement("option");
            const typeLabel = ex.type ? ("[" + ex.type + "] ") : "";
            opt.value = ex.id;
            opt.textContent = ex.id + " ‚Äì " + typeLabel + (ex.title || "");
            if (ex.active && !sel.value) opt.selected = true;
            sel.appendChild(opt);
          });

          if (sel.value) {
            onExamSelected();
          }
        })
        .catch(err => {
          console.error(err);
          const sel = document.getElementById("examSelect");
          if (sel) {
            sel.innerHTML = '<option value="">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ca thi / Cannot load exam list</option>';
          }
        });
    }

    function onExamSelected() {
      const sel = document.getElementById("examSelect");
      const timeRangeEl = document.getElementById("examTimeRange");
      const countdownEl = document.getElementById("examCountdown");
      const typeEl = document.getElementById("examType");
      const warnEl = document.getElementById("examWarning");

      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }

      const id = sel.value;
      currentExam = examList.find(ex => ex.id === id) || null;
      if (!currentExam) {
        timeRangeEl.textContent = "‚Äì";
        countdownEl.textContent = "‚Äì";
        typeEl.textContent = "‚Äì";
        warnEl.textContent = "";
        return;
      }

      typeEl.textContent = currentExam.type || "Kh√¥ng r√µ / Unknown";
      const start = currentExam.startMs ? new Date(currentExam.startMs) : null;
      const end   = currentExam.endMs   ? new Date(currentExam.endMs)   : null;

      let rangeText = "";
      if (start && end) {
        rangeText = start.toLocaleString("vi-VN") + " ‚Üí " + end.toLocaleString("vi-VN");
      } else if (end) {
        rangeText = "Tr∆∞·ªõc / Before " + end.toLocaleString("vi-VN");
      } else if (start) {
        rangeText = "Sau / After " + start.toLocaleString("vi-VN");
      } else {
        rangeText = "Ch∆∞a c·∫•u h√¨nh th·ªùi gian / No time configured";
      }
      timeRangeEl.textContent = rangeText;

      function updateCountdown() {
        if (!end) {
          countdownEl.textContent = "Kh√¥ng c·∫•u h√¨nh gi·ªù k·∫øt th√∫c / No end time.";
          warnEl.textContent = "";
          return;
        }
        const now = new Date();
        const diff = end.getTime() - now.getTime();
        if (diff <= 0) {
          countdownEl.textContent = "ƒê√É H·∫æT GI·ªú / TIME IS OVER";
          warnEl.textContent = "H·ªá th·ªëng kh√¥ng cho v√†o l√†m b√†i n·ªØa. / You cannot start this exam anymore.";
          clearInterval(countdownTimer);
          countdownTimer = null;
          return;
        }
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        countdownEl.textContent = minutes + " ph√∫t / minutes " +
          (seconds < 10 ? "0" : "") + seconds + " gi√¢y / seconds";
        warnEl.textContent =
          "ƒê·∫øn khi h·∫øt gi·ªù, h·ªçc sinh ph·∫£i b·∫•m G·ª¨I tr√™n Google Form. / " +
          "Before time is over, students must SUBMIT in Google Form.";
      }

      if (end) {
        updateCountdown();
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        countdownEl.textContent = "Kh√¥ng c·∫•u h√¨nh gi·ªù k·∫øt th√∫c / No end time.";
        warnEl.textContent = "";
      }
    }

    document.getElementById("examSelect").addEventListener("change", onExamSelected);

    function startExam() {
      if (!currentStudent) {
        alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc. / Please login first.");
        return;
      }
      if (!currentExam) {
        alert("Vui l√≤ng ch·ªçn M√£ ca thi. / Please select an exam session.");
        return;
      }

      const end   = currentExam.endMs ? new Date(currentExam.endMs) : null;
      const start = currentExam.startMs ? new Date(currentExam.startMs) : null;
      const now   = new Date();

      if (start && now < start) {
        alert("Ch∆∞a ƒë·∫øn gi·ªù b·∫Øt ƒë·∫ßu ca thi n√†y. / Exam has not started yet.\n" +
              "B·∫Øt ƒë·∫ßu / Start: " + start.toLocaleString("vi-VN"));
        return;
      }
      if (end && now > end) {
        alert("Ca thi ƒë√£ k·∫øt th√∫c, kh√¥ng th·ªÉ v√†o n·ªØa. / Exam is already over.");
        return;
      }

      // ·ªû ƒë√¢y c√≥ th·ªÉ g·∫Øn th√™m tham s·ªë query cho Google Form n·∫øu mu·ªën (t√™n, l·ªõp...).
      window.open(currentExam.link, "_blank");
      alert("H·ªá th·ªëng ƒë√£ m·ªü b√†i thi trong tab m·ªõi.\nNh·ªõ b·∫•m G·ª¨I trong Google Form tr∆∞·ªõc khi h·∫øt gi·ªù. / " +
            "Exam opened in new tab. Remember to SUBMIT the form in time.");
    }

    // -------- QUESTION BANK PREVIEW --------
    function renderQuestion(q) {
      const div = document.createElement("div");
      div.className = "question-card";

      const typeLabel = q.type || "";
      div.innerHTML = `
        <div class="q-code">
          <span class="pill">${typeLabel}</span>
          <span style="margin-left:6px;">M√£ / Code: ${q.code || ""}</span>
        </div>
        <div class="q-text">
          <b>VI:</b> ${q.qVI || ""}<br>
          <b>EN:</b> ${q.qEN || ""}</div>
      `;

      const ul = document.createElement("ul");
      ["A","B","C","D"].forEach(letter => {
        const opt = q[letter];
        if (!opt) return;
        const li = document.createElement("li");
        const isKey = String(opt.key || "").trim() === "1";
        li.textContent = letter + ") " + (opt.vi || "");
        if (opt.en) {
          li.innerHTML += `<br><span style="opacity:.8;font-size:.72rem;">EN: ${opt.en}</span>`;
        }
        if (isKey) {
          const span = document.createElement("span");
          span.className = "key";
          span.textContent = "‚úî";
          li.appendChild(span);
        }
        ul.appendChild(li);
      });

      div.appendChild(ul);

      if (q.expVI || q.expEN) {
        const exp = document.createElement("div");
        exp.style.marginTop = "4px";
        exp.innerHTML = `
          <b>Gi·∫£i th√≠ch / Explanation:</b><br>
          <span>VI: ${q.expVI || ""}</span><br>
          <span>EN: ${q.expEN || ""}</span>
        `;
        div.appendChild(exp);
      }

      return div;
    }

    async function loadBankPreview() {
      const statusEl = document.getElementById("bankStatus");
      const listEl   = document.getElementById("bankList");
      listEl.innerHTML = "";
      statusEl.textContent = "ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶ / Loading questions‚Ä¶";
      statusEl.className = "status-msg status-empty";

      const type = document.getElementById("bankType").value;
      const limit = document.getElementById("bankLimit").value || "10";

      const params = new URLSearchParams();
      params.append("mode", "bank");
      if (type)  params.append("filterType", type);
      if (limit) params.append("limit", limit);

      try {
        const url = WEB_APP_URL + "?" + params.toString();
        const data = await callJsonp(url, "bankCallback");

        if (!data || !data.ok) {
          statusEl.textContent = (data && data.message) || "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. / Cannot load data.";
          statusEl.className = "status-msg status-error";
          return;
        }

        const questions = data.questions || [];
        if (!questions.length) {
          statusEl.textContent = "Kh√¥ng c√≥ c√¢u h·ªèi n√†o ph√π h·ª£p. / No questions found.";
          statusEl.className = "status-msg status-empty";
          return;
        }

        statusEl.textContent = "ƒê√£ t·∫£i " + questions.length +
          " c√¢u h·ªèi. / Loaded " + questions.length + " questions.";
        statusEl.className = "status-msg status-ok";

        questions.forEach(q => {
          listEl.appendChild(renderQuestion(q));
        });

      } catch (err) {
        console.error(err);
        statusEl.textContent = "L·ªói khi t·∫£i ng√¢n h√†ng c√¢u h·ªèi. / Error loading question bank.";
        statusEl.className = "status-msg status-error";
      }
    }

    // -------- G·∫ÆN ACTION FORM ƒêƒÇNG K√ù --------
    (function init() {
      const regForm = document.getElementById("regForm");
      if (regForm) {
        regForm.action = WEB_APP_URL;
      }
    })();
  </script>
</body>
</html>
