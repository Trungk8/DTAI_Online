<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#2563eb;
      --primary-soft:#dbeafe;
      --primary-strong:#1d4ed8;
      --danger:#dc2626;
      --danger-soft:#fee2e2;
      --muted:#6b7280;
      --bg-page:#eef2ff;
      --bg-card:#ffffff;
      --border-soft:#e5e7eb;
      --radius-lg:18px;
    }
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    body{
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e0edff,#f9fafb);
      min-height:100vh;
      padding:16px 10px 24px;
      color:#111827;
      font-size:16px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:16px;
    }
    header h1{
      margin:0;
      font-size:1.25rem;
      font-weight:700;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:#0f172a;
    }
    header p{
      margin:4px 0 0;
      font-size:.95rem;
      color:var(--muted);
    }
    .badge-top{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.78rem;
    }
    .badge-top span.dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#38bdf8,#0ea5e9);
      box-shadow:0 0 10px #38bdf8;
    }
    header .avatar-chip{
      min-width:80px;
      max-width:150px;
      background:#020617;
      color:#e5e7eb;
      border-radius:999px;
      padding:7px 11px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 14px 40px rgba(15,23,42,.55);
    }
    .avatar-circle{
      width:30px;height:30px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#38bdf8,#4f46e5);
      display:flex;align-items:center;justify-content:center;
      font-size:1.1rem;
    }
    .avatar-chip span.label{
      font-size:.78rem;
      line-height:1.2;
    }

    nav{
      margin-bottom:16px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    nav button{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:.9rem;
      font-weight:500;
      cursor:pointer;
      background:#ffffffb8;
      color:#374151;
      box-shadow:0 8px 22px rgba(15,23,42,.12);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    nav button.active{
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      color:#fff;
      box-shadow:0 12px 30px rgba(37,99,235,.55);
    }
    nav button span.icon{font-size:1rem;}

    main{display:block;}
    section.page{
      display:none;
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      padding:16px 16px 18px;
      box-shadow:0 16px 40px rgba(15,23,42,.18);
      border:1px solid var(--border-soft);
    }
    section.page.active{display:block;}

    .section-title{
      font-size:1.05rem;
      margin:0 0 4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .section-title span.badge-inline{
      font-size:.72rem;
      text-transform:uppercase;
      padding:2px 7px;
      border-radius:999px;
      background:var(--primary-soft);
      border:1px solid rgba(37,99,235,.5);
      color:var(--primary-strong);
    }
    .section-desc{
      margin:0 0 12px;
      font-size:.88rem;
      color:var(--muted);
    }
    .section-desc b{color:#111827;}

    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 16px;
    }
    @media(max-width:768px){
      .grid-2{grid-template-columns:1fr;}
      header{flex-direction:column;}
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-size:.95rem;
      font-weight:600;
      color:#111827;
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:wrap;
    }
    .required{
      color:var(--danger);
      font-weight:700;
    }
    input,select,textarea{
      border-radius:11px;
      border:1px solid #d1d5db;
      padding:11px 12px;
      font-size:1.02rem;
      outline:none;
      width:100%;
      background:#ffffff;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
    }
    textarea{min-height:70px;resize:vertical;}

    .dob-group{
      display:flex;
      gap:6px;
    }
    .dob-group select{flex:1;}

    .hint{
      font-size:.78rem;
      color:#9ca3af;
    }

    .alert{
      margin-top:12px;
      padding:9px 11px;
      border-radius:11px;
      font-size:.8rem;
      line-height:1.4;
    }
    .alert.info{
      background:rgba(37,99,235,.06);
      border:1px solid rgba(37,99,235,.4);
      color:#1d4ed8;
    }
    .alert.warn{
      background:rgba(234,179,8,.08);
      border:1px solid rgba(234,179,8,.7);
      color:#92400e;
    }
    .alert.error{
      background:rgba(248,113,113,.1);
      border:1px solid rgba(220,38,38,.7);
      color:#b91c1c;
    }

    .btn-row{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn-primary,.btn-ghost{
      border-radius:999px;
      border:none;
      padding:9px 16px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      letter-spacing:.02em;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      color:#fff;
      box-shadow:0 14px 40px rgba(37,99,235,.7);
    }
    .btn-ghost{
      background:#f9fafb;
      color:#111827;
      border:1px solid #d1d5db;
    }

    .pill-warning{
      font-size:.8rem;
      padding:5px 10px;
      border-radius:999px;
      background:rgba(234,179,8,.08);
      border:1px dashed rgba(234,179,8,.9);
      color:#92400e;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:6px;
    }

    .card{
      background:#0b1120;
      border-radius:16px;
      border:1px solid #1f2937;
      padding:14px 14px 16px;
      box-shadow:0 20px 50px rgba(15,23,42,.85);
      color:#e5e7eb;
      margin-top:4px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:10px;
    }
    .card-title{
      margin:0;
      font-size:.98rem;
    }
    .card-sub{
      margin:2px 0 0;
      font-size:.8rem;
      color:#9ca3af;
    }
    .tag{
      font-size:.7rem;
      border-radius:999px;
      padding:3px 8px;
      border:1px solid rgba(148,163,184,.7);
      color:#e5e7eb;
      background:rgba(15,23,42,.9);
    }
    .timer{
      font-variant-numeric:tabular-nums;
      font-size:1.1rem;
      font-weight:700;
      color:#fbbf24;
      text-align:right;
    }

    .dashboard-grid{
      display:grid;
      grid-template-columns:1.1fr 1.2fr;
      gap:10px;
      margin-top:8px;
    }
    @media(max-width:900px){
      .dashboard-grid{grid-template-columns:1fr;}
    }
    .stat-box{
      background:#020617;
      border-radius:16px;
      padding:10px 11px 12px;
      border:1px solid #1f2937;
      box-shadow:0 18px 45px rgba(15,23,42,.9);
      color:#e5e7eb;
    }
    .stat-box h3{
      margin:0 0 6px;
      font-size:.9rem;
    }
    .stat-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      font-size:.8rem;
    }
    .stat-row span.label{color:#9ca3af;}
    .stat-row span.value{font-weight:600;color:#e5e7eb;}

    .chart-card{
      background:#f9fafb;
      border-radius:16px;
      padding:10px 11px 12px;
      box-shadow:0 16px 40px rgba(15,23,42,.12) inset;
      display:flex;
      flex-direction:column;
      min-height:220px;
    }
    .chart-card h3{font-size:.9rem;margin:0 0 4px;}
    .chart-card p{font-size:.78rem;color:var(--muted);margin:0 0 8px;}
    .chart-wrapper{flex:1;min-height:170px;}

    /* Tra c·ª©u k·∫øt qu·∫£ */
    #results{margin-top:12px;font-size:.82rem;}
    .result-card{
      background:#020617;
      border-radius:12px;
      border:1px solid #1f2937;
      padding:9px 10px;
      margin-bottom:6px;
      color:#e5e7eb;
    }
    .result-card h4{margin:0 0 2px;font-size:.9rem;}
    .result-meta{
      display:flex;flex-wrap:wrap;gap:6px;
      font-size:.78rem;color:#9ca3af;
    }
    .status-msg{margin-top:8px;font-size:.82rem;}
    .status-error{color:#b91c1c;}
    .status-empty{color:#9ca3af;}

    /* Import ƒë·ªÅ t·ª´ Word */
    .card-light{
      background:#ffffff;
      border-radius:16px;
      padding:14px 14px 16px;
      border:1px solid #e5e7eb;
      box-shadow:0 14px 35px rgba(15,23,42,.12);
      color:#0f172a;
    }
    .card-light h3{margin:0 0 6px;font-size:.98rem;}
    .card-light p{margin:3px 0 8px;font-size:.85rem;color:#4b5563;}
    .card-light ol{margin:4px 0 8px 20px;font-size:.83rem;color:#4b5563;}
    .card-light code{
      background:#f3f4f6;
      padding:2px 4px;
      border-radius:4px;
      font-size:.8rem;
    }
    .import-note{
      font-size:.8rem;
      color:#6b7280;
      margin-top:6px;
    }

    /* Khung review b√†i l√†m */
    .review-card{
      margin-top:12px;
      background:#f9fafb;
      border-radius:16px;
      border:1px solid #e5e7eb;
      padding:12px 14px 14px;
      box-shadow:0 12px 30px rgba(15,23,42,.12);
    }
    .review-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:8px;
    }
    .review-header h3{
      margin:0;
      font-size:.95rem;
    }
    .review-tag{
      font-size:.72rem;
      padding:2px 7px;
      border-radius:999px;
      background:#e0f2fe;
      color:#0369a1;
      white-space:nowrap;
    }
    .review-body{
      font-size:.82rem;
      color:#374151;
    }
    .review-list{
      margin:8px 0 0;
      padding-left:16px;
    }
    .stu-info-line{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-size:.78rem;
      color:#cbd5f5;
      margin-bottom:6px;
    }

    /* Mobile tweaks */
    @media(max-width:480px){
      body{padding:10px 6px 18px;}
      section.page{padding:12px 10px 14px;}
      input,select,textarea{font-size:.95rem;padding:9px 10px;}
      .card,.card-light{padding:10px 10px 12px;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</h1>
      <p>ƒêƒÉng k√Ω ‚Äì V√†o thi ‚Äì Dashboard ‚Äì Tra c·ª©u k·∫øt qu·∫£ tr√™n c√πng m·ªôt trang.</p>
      <div class="badge-top"><span class="dot"></span><span>Phi√™n b·∫£n PREMIUM</span></div>
    </div>
    <div class="avatar-chip">
      <div class="avatar-circle">AI</div>
      <span class="label">DTAI Online<br/>NƒêC ‚Äì L√¢m ƒê·ªìng</span>
    </div>
  </header>

  <nav>
    <button class="active" onclick="show('reg', this)"><span class="icon">üìù</span>ƒêƒÉng k√Ω</button>
    <button onclick="show('login', this)"><span class="icon">üîê</span>ƒêƒÉng nh·∫≠p</button>
    <button onclick="show('exam', this)"><span class="icon">üß™</span>V√†o thi</button>
    <button onclick="show('dash', this)"><span class="icon">üìä</span>Dashboard</button>
    <button onclick="show('search', this)"><span class="icon">üîé</span>Tra c·ª©u</button>
    <button onclick="show('import', this)"><span class="icon">üì•</span>Import ƒë·ªÅ Word</button>
  </nav>

  <main>
    <!-- 1. ƒêƒÇNG K√ù -->
    <section id="reg" class="page active">
      <h2 class="section-title">
        ƒêƒÉng k√Ω tham gia h·ªá th·ªëng
        <span class="badge-inline">Student Registration</span>
      </h2>
      <p class="section-desc">
        Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b√™n d∆∞·ªõi. H·ªá th·ªëng t·ª± ki·ªÉm tra tr√πng <b>CCCD</b> ho·∫∑c <b>Email</b> v√† g·ª≠i m·∫≠t kh·∫©u ri√™ng qua email.
      </p>

      <form id="regForm"
            method="post"
            action="https://script.google.com/macros/s/AKfycbxbG-oxupd6949_d6uUlVmvYaJly8t5voJNWuwsAzwoar9BAgcmn9_AJP-kH1hB_vyGLA/exec">
        <div class="grid-2">
          <div class="field">
            <label for="hoten">H·ªç v√† t√™n (IN HOA) <span class="required">*</span></label>
            <input id="hoten" name="hoten" placeholder="VD: NGUY·ªÑN VƒÇN A" required />
            <div class="hint">C√≥ th·ªÉ nh·∫≠p th∆∞·ªùng, h·ªá th·ªëng s·∫Ω t·ª± chuy·ªÉn sang IN HOA khi l∆∞u.</div>
          </div>
          <div class="field">
            <label for="dob-day">Ng√†y sinh <span class="required">*</span></label>
            <div class="dob-group">
              <select id="dob-day" aria-label="Ng√†y sinh - ng√†y"></select>
              <select id="dob-month" aria-label="Ng√†y sinh - th√°ng"></select>
              <select id="dob-year" aria-label="Ng√†y sinh - nƒÉm"></select>
              <input type="hidden" id="ngaysinh" name="ngaysinh" />
            </div>
            <div class="hint">Ch·ªçn l·∫ßn l∆∞·ª£t Ng√†y ‚Äì Th√°ng ‚Äì NƒÉm. H·ªá th·ªëng s·∫Ω t·ª± gh√©p th√†nh dd/mm/yyyy.</div>
          </div>
          <div class="field">
            <label for="gioitinh">Gi·ªõi t√≠nh <span class="required">*</span></label>
            <select id="gioitinh" name="gioitinh" required>
              <option value="">-- Ch·ªçn --</option>
              <option>Nam</option>
              <option>N·ªØ</option>
              <option>Kh√°c</option>
            </select>
          </div>
          <div class="field">
            <label for="dantoc">D√¢n t·ªôc</label>
            <select id="dantoc" name="dantoc">
              <option>Kinh</option>
              <option>C∆°-ho</option>
              <option>Ba-na</option>
              <option>Kh√°c</option>
            </select>
          </div>
          <div class="field">
            <label for="truong">Tr∆∞·ªùng <span class="required">*</span></label>
            <select id="truong" name="truong" required>
              <option value="">-- Ch·ªçn tr∆∞·ªùng --</option>
              <option>THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
              <option>THPT Ph·∫°m VƒÉn ƒê·ªìng</option>
              <option>THPT B·∫£o L·ªôc</option>
              <option>THPT ƒê·ª©c Tr·ªçng</option>
              <option>Tr∆∞·ªùng kh√°c (ghi ch√∫)</option>
            </select>
            <div class="hint">N·∫øu ch∆∞a c√≥ t√™n tr∆∞·ªùng, ch·ªçn ‚ÄúTr∆∞·ªùng kh√°c (ghi ch√∫)‚Äù v√† ghi r√µ ·ªü √¥ Ghi ch√∫.</div>
          </div>
          <div class="field">
            <label for="xa">X√£/Ph∆∞·ªùng</label>
            <input id="xa" name="xa" placeholder="VD: X√£ Ki·∫øn ƒê·ª©c" />
          </div>
          <div class="field">
            <label for="tinh">T·ªânh/TP</label>
            <select id="tinh" name="tinh">
              <option>L√¢m ƒê·ªìng</option>
              <option>ƒê·∫Øk L·∫Øk</option>
              <option>ƒê·∫Øk N√¥ng</option>
              <option>TP. H·ªì Ch√≠ Minh</option>
              <option>H√† N·ªôi</option>
              <option value="Kh√°c">T·ªânh/TP kh√°c</option>
            </select>
          </div>
          <div class="field">
            <label for="khoi">Kh·ªëi <span class="required">*</span></label>
            <select id="khoi" name="khoi" required>
              <option value="">-- Ch·ªçn kh·ªëi --</option>
              <option>10</option>
              <option>11</option>
              <option>12</option>
            </select>
          </div>
          <div class="field">
            <label for="malop">L·ªõp <span class="required">*</span></label>
            <input id="malop" name="malop" placeholder="VD: 12A1" required />
            <div class="hint">Nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng: 10A1, 11A2, 12A5,‚Ä¶</div>
          </div>
          <div class="field">
            <label for="cccd">CCCD <span class="required">*</span></label>
            <input id="cccd" name="cccd" inputmode="numeric" placeholder="Ch·ªâ nh·∫≠p s·ªë" required />
            <div class="hint">H·ªá th·ªëng l∆∞u CCCD d·∫°ng chu·ªói, d√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p & tra c·ª©u k·∫øt qu·∫£.</div>
          </div>
          <div class="field">
            <label for="email">Email <span class="required">*</span></label>
            <input id="email" name="email" type="email" placeholder="VD: ten@gmail.com" required />
            <div class="hint">D√πng ƒë·ªÉ nh·∫≠n email x√°c nh·∫≠n & m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p.</div>
          </div>
          <div class="field">
            <label for="ghichu">Ghi ch√∫ th√™m</label>
            <textarea id="ghichu" name="ghichu" placeholder="VD: Tr∆∞·ªùng kh√°c, ho√†n c·∫£nh ƒë·∫∑c bi·ªát, ..."></textarea>
          </div>
        </div>

        <div class="alert warn">
          ‚ö† <b>L∆∞u √Ω:</b> N√™n ƒëƒÉng k√Ω tr∆∞·ªõc gi·ªù thi √≠t nh·∫•t 15 ph√∫t ƒë·ªÉ k·ªãp nh·∫≠n email & m·∫≠t kh·∫©u.
        </div>

        <div class="btn-row">
          <button type="submit" class="btn-primary">
            G·ª≠i ƒëƒÉng k√Ω / Submit
          </button>
          <button type="reset" class="btn-ghost">
            X√≥a d·ªØ li·ªáu / Reset
          </button>
        </div>
      </form>
    </section>

    <!-- 2. ƒêƒÇNG NH·∫¨P -->
    <section id="login" class="page">
      <h2 class="section-title">ƒêƒÉng nh·∫≠p b·∫±ng CCCD + m·∫≠t kh·∫©u</h2>
      <p class="section-desc">
        M·ªói h·ªçc sinh s·ª≠ d·ª•ng <b>01 CCCD</b> v√† m·∫≠t kh·∫©u ri√™ng (ƒë∆∞·ª£c g·ª≠i qua email sau khi ƒëƒÉng k√Ω).
      </p>

      <div class="card">
        <div class="card-header">
          <div>
            <h3 class="card-title">Th√¥ng tin ƒëƒÉng nh·∫≠p</h3>
            <p class="card-sub">Nh·∫≠p ƒë√∫ng CCCD & m·∫≠t kh·∫©u ƒë·ªÉ v√†o khu v·ª±c l√†m b√†i / xem k·∫øt qu·∫£.</p>
          </div>
          <span class="tag">SECURE LOGIN</span>
        </div>

        <form id="loginForm">
          <div class="grid-2">
            <div class="field">
              <label for="login-id">CCCD ho·∫∑c Email *</label>
              <input id="login-id" name="login-id"
                     placeholder="Nh·∫≠p CCCD ho·∫∑c Email ƒë√£ ƒëƒÉng k√Ω" />
            </div>
            <div class="field">
              <label for="login-pass">M·∫≠t kh·∫©u *</label>
              <input id="login-pass" name="login-pass" type="password"
                     placeholder="M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i qua email" />
            </div>
          </div>
        
          <div class="pill-warning">
            ‚è± G·ª£i √Ω: ƒêƒÉng nh·∫≠p tr∆∞·ªõc gi·ªù thi √≠t nh·∫•t 5 ph√∫t ƒë·ªÉ ki·ªÉm tra k·∫øt n·ªëi &amp; th√¥ng tin c√° nh√¢n.
          </div>
        
          <div class="btn-row">
            <button type="submit" class="btn-primary">
              ƒêƒÉng nh·∫≠p / Login
            </button>
            <button type="button" class="btn-ghost"
                    onclick="alert('Li√™n h·ªá GVCN ho·∫∑c BGH ƒë·ªÉ c·∫•p l·∫°i m·∫≠t kh·∫©u.')">
              Qu√™n m·∫≠t kh·∫©u?
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- 3. V√ÄO THI -->
    <section id="exam" class="page">
      <h2 class="section-title">
        V√†o thi tr·ª±c tuy·∫øn
        <span class="badge-inline">Online Exam</span>
      </h2>
      <p class="section-desc">
        Sau khi ƒëƒÉng nh·∫≠p, h·ªá th·ªëng s·∫Ω t·ª± g·ª£i √Ω m√£ ca thi, th·ªùi gian ƒë·∫øm ng∆∞·ª£c & link ƒë·ªÅ d·ª±a v√†o c·∫•u h√¨nh trong sheet <b>CauHinhThi</b>.
      </p>

      <div class="card">
        <div class="card-header">
          <div>
            <h3 class="card-title">Th√¥ng tin ca thi / Exam slot</h3>
            <p class="card-sub">D√πng m√£ ca thi m√† th·∫ßy/c√¥ ƒë√£ c·∫•u h√¨nh s·∫µn trong Google Sheet.</p>
          </div>
          <div>
            <div class="timer" id="examTimer">--:--</div>
            <div style="font-size:.7rem;color:#9ca3af;text-align:right;">Th·ªùi gian c√≤n l·∫°i / Time left</div>
          </div>
        </div>

        <!-- Th√¥ng tin h·ªçc sinh ƒëang ƒëƒÉng nh·∫≠p -->
        <div class="stu-info-line">
          <span><b>H·ªç t√™n:</b> <span id="stuNameLabel">Ch∆∞a ƒëƒÉng nh·∫≠p</span></span>
          <span><b>CCCD:</b> <span id="stuCccdLabel">‚Äî</span></span>
          <span><b>L·ªõp:</b> <span id="stuClassLabel">‚Äî</span></span>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="exam-code">M√£ ca thi</label>
            <input id="exam-code" placeholder="VD: 11A3-TKTx-TOAN-CA1" />
          </div>
          <div class="field">
            <label for="examLink">Link ƒë·ªÅ (Google Form/Quiz)</label>
            <input id="examLink" placeholder="D√°n link ƒë·ªÅ n·∫øu mu·ªën m·ªü th·ªß c√¥ng" />
          </div>
        </div>

        <div class="alert info">
          ‚è∞ V√≠ d·ª• c·∫£nh b√°o: <b>‚Äúƒê·∫øn 08:45 h·ªá th·ªëng s·∫Ω kh√¥ng nh·∫≠n b√†i n·ªØa. H√£y b·∫•m G·ª¨I tr∆∞·ªõc th·ªùi ƒëi·ªÉm n√†y.‚Äù</b><br/>
          Th√¥ng ƒëi·ªáp n√†y c√≥ th·ªÉ t·ª± sinh d·ª±a v√†o th·ªùi gian k·∫øt th√∫c trong sheet <code>CauHinhThi</code>.
        </div>

        <div class="btn-row">
          <button type="button" id="btnStartExam" class="btn-primary" onclick="openExam()">
            V√†o thi / Start exam
          </button>
          <button type="button" class="btn-ghost" onclick="openSheet()">
            Xem c·∫•u h√¨nh ca thi (Sheet)
          </button>
        </div>
      </div>

      <!-- Khung xem l·∫°i b√†i l√†m c√° nh√¢n -->
      <div id="reviewBox" class="review-card" style="display:none;">
        <div class="review-header">
          <h3>üîç Xem l·∫°i b√†i l√†m g·∫ßn nh·∫•t</h3>
          <span class="review-tag">My latest attempts</span>
        </div>
        <div id="reviewContent" class="review-body">
          <p>ƒêƒÉng nh·∫≠p v√† v√†o tab V√†o thi ƒë·ªÉ xem l·∫°i ƒëi·ªÉm & b√†i l√†m g·∫ßn nh·∫•t.</p>
        </div>
      </div>
    </section>

    <!-- 4. DASHBOARD -->
    <section id="dash" class="page">
      <h2 class="section-title">
        Dashboard t·ªïng h·ª£p
        <span class="badge-inline">Overview</span>
      </h2>
      <p class="section-desc">
        Th·ªëng k√™ t·ª´ sheet <b>DangKy</b> v√† <b>DiemThi</b> (n·∫øu c·∫•u h√¨nh) ƒë·ªÉ BGH n·∫Øm nhanh t√¨nh h√¨nh.
      </p>

      <div class="dashboard-grid">
        <div class="stat-box">
          <h3>Th·ªëng k√™ ƒëƒÉng k√Ω / Registrations</h3>
          <div id="statTotal" class="stat-row">
            <span class="label">T·ªïng s·ªë ƒë√£ ƒëƒÉng k√Ω</span>
            <span class="value">‚Ä¶</span>
          </div>
          <div id="statKhoi" class="stat-row">
            <span class="label">Theo kh·ªëi (10/11/12)</span>
            <span class="value">‚Ä¶</span>
          </div>
          <div id="statGioiTinh" class="stat-row">
            <span class="label">Theo gi·ªõi t√≠nh</span>
            <span class="value">‚Ä¶</span>
          </div>
          <div id="statEthnic" class="stat-row">
            <span class="label">Theo d√¢n t·ªôc</span>
            <span class="value">‚Ä¶</span>
          </div>
          <div id="statSchool" class="stat-row">
            <span class="label">Theo tr∆∞·ªùng</span>
            <span class="value">‚Ä¶</span>
          </div>
        </div>

        <div class="chart-card">
          <h3>Bi·ªÉu ƒë·ªì ph√¢n b·ªë theo kh·ªëi / Grade distribution</h3>
          <p>Gi√∫p BGH n·∫Øm nhanh s·ªë l∆∞·ª£ng h·ªçc sinh ƒëƒÉng k√Ω theo t·ª´ng kh·ªëi l·ªõp.</p>
          <div class="chart-wrapper">
            <canvas id="chartKhoi"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- 5. TRA C·ª®U K·∫æT QU·∫¢ -->
    <section id="search" class="page">
      <h2 class="section-title">Tra c·ª©u k·∫øt qu·∫£ / Result lookup</h2>
      <p class="section-desc">
        Nh·∫≠p CCCD ho·∫∑c H·ªç t√™n (IN HOA) + L·ªõp ƒë·ªÉ xem l·∫°i ƒëi·ªÉm t·ª´ sheet <b>DiemThi</b>.
      </p>

      <form id="searchForm">
        <div class="grid-2">
          <div class="field">
            <label for="search-cccd">CCCD</label>
            <input id="search-cccd" placeholder="∆Øu ti√™n tra c·ª©u theo CCCD" inputmode="numeric" />
          </div>
          <div class="field">
            <label for="search-name">H·ªç t√™n (IN HOA)</label>
            <input id="search-name" placeholder="VD: NGUY·ªÑN VƒÇN A" />
          </div>
          <div class="field">
            <label for="search-class">L·ªõp</label>
            <input id="search-class" placeholder="VD: 12A1" />
          </div>
        </div>

        <div class="btn-row">
          <button type="submit" class="btn-primary">
            üîé Tra c·ª©u k·∫øt qu·∫£
          </button>
        </div>
      </form>
      <div id="status" class="status-msg status-empty"></div>
      <div id="results"></div>
    </section>

    <!-- 6. IMPORT ƒê·ªÄ T·ª™ WORD -->
    <section id="import" class="page">
      <h2 class="section-title">
        Import ƒë·ªÅ tr·∫Øc nghi·ªám t·ª´ Word
        <span class="badge-inline">Word ‚Üí Sheet NganHangDe</span>
      </h2>
      <p class="section-desc">
        D√πng cho gi√°o vi√™n / BGH. H·ªá th·ªëng ƒë·ªçc file Google Docs (chuy·ªÉn t·ª´ Word) theo ƒë√∫ng m·∫´u
        v√† ƒë·ªï c√¢u h·ªèi v√†o sheet <b>NganHangDe</b>.
      </p>

      <div class="card-light">
        <h3>H∆∞·ªõng d·∫´n 3 b∆∞·ªõc</h3>
        <ol>
          <li>So·∫°n ƒë·ªÅ trong Word theo m·∫´u: ‚ÄúC√¢u 1.‚Äù ‚Üí n·ªôi dung ‚Üí a./b./c./d. ‚Üí ‚Äúƒê√°p √°n ƒë√∫ng:‚Äù ‚Üí ‚Äúƒê√°p √°n sai:‚Äù.</li>
          <li>Upload Word l√™n Google Drive, sau ƒë√≥ <b>M·ªü b·∫±ng ‚Üí Google T√†i li·ªáu</b> (Google Docs).</li>
          <li>L·∫•y <b>ID</b> (ph·∫ßn gi·ªØa <code>/d/</code> v√† <code>/edit</code>) v√† d√°n v√†o √¥ b√™n d∆∞·ªõi, b·∫•m ‚ÄúImport ƒë·ªÅ‚Äù.</li>
        </ol>

        <form id="importForm">
          <div class="field">
            <label for="docId">ID file Google Docs <span class="required">*</span></label>
            <input id="docId" name="docId"
                   placeholder="V√≠ d·ª•: 1qDG8z15Ep5f3RLB9OxqtpyzFzrmYIiOe" required />
            <div class="import-note">
              V√≠ d·ª• link: https://docs.google.com/document/d/<b>1qDG8z15Ep5f3RLB9OxqtpyzFzrmYIiOe</b>/edit<br/>
              üëâ ID c·∫ßn d√°n ch√≠nh l√† ph·∫ßn in ƒë·∫≠m.
            </div>
          </div>

          <div class="btn-row" style="margin-top:10px;">
            <button type="submit" class="btn-primary">
              üì• Import ƒë·ªÅ t·ª´ Word
            </button>
            <button type="button" class="btn-ghost"
                    onclick="alert('Th·∫ßy/c√¥ c√≥ th·ªÉ d√πng file m·∫´u Mau_Import_De_Word_DTAI_Online.docx ƒë·ªÉ so·∫°n ƒë·ªÅ ƒë√∫ng c·∫•u tr√∫c.')">
              Xem m·∫´u Word chu·∫©n
            </button>
          </div>
        </form>

        <div id="importStatus" class="import-note" style="margin-top:8px;"></div>
      </div>
    </section>
  </main>
</div>

<script>
  // üëâ Nh·ªõ kh·ªõp v·ªõi URL Web App ƒë√£ Deploy
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzTxzUWmonjuqW2ja20Gi85zZlf18_BI1LFPBzHyDlyAYQNOaJLEoRtfX_0t1ZZVaVQ/exec";

  let CURRENT_STUDENT = null;
  let EXAM_LIST = [];
  let EXAM_TIMER = null;
  let EXAM_END_MS = null;

  function show(id, btn){
    document.querySelectorAll("section.page").forEach(sec=>{
      sec.classList.toggle("active", sec.id === id);
    });
    if(btn){
      document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    }
  }

  function openExam(){
    const btn = document.getElementById("btnStartExam");
    if (btn && btn.disabled) {
      alert("ƒê√£ h·∫øt gi·ªù l√†m b√†i. Vui l√≤ng li√™n h·ªá gi√°o vi√™n ph·ª• tr√°ch.");
      return;
    }
    const link = document.getElementById("examLink").value.trim();
    if(!link){
      alert("Th·∫ßy/c√¥ nh·∫≠p ho·∫∑c c·∫•u h√¨nh s·∫µn link Google Form/Quiz tr∆∞·ªõc khi v√†o thi.");
      return;
    }
    window.open(link,"_blank");
  }

  function openSheet(){
    alert("M·ªü sheet CauHinhThi tr√™n Google Sheets ƒë·ªÉ xem v√† ch·ªânh c·∫•u h√¨nh ca thi.");
  }

  // JSONP helper
  function callJsonp(url){
    return new Promise((resolve, reject)=>{
      const callbackName = "jsonp_cb_" + Date.now() + "_" + Math.floor(Math.random()*10000);
      window[callbackName] = function(data){
        resolve(data);
        delete window[callbackName];
        script.remove();
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + callbackName;
      script.onerror = (err)=>{
        delete window[callbackName];
        script.remove();
        reject(err);
      };
      document.body.appendChild(script);
    });
  }

  function setStudentHeader(stu){
    document.getElementById("stuNameLabel").textContent  = (stu && stu.name)      || "‚Äî";
    document.getElementById("stuCccdLabel").textContent  = (stu && stu.cccd)      || "‚Äî";
    document.getElementById("stuClassLabel").textContent = (stu && stu.className) || "‚Äî";
  }

  async function handleLogin(e){
    e.preventDefault();
    const idVal = document.getElementById("login-id").value.trim();
    const pass  = document.getElementById("login-pass").value.trim();
  
    if (!idVal || !pass) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß CCCD ho·∫∑c Email v√† m·∫≠t kh·∫©u.");
      return;
    }
  
    try {
      // N·∫øu c√≥ @ th√¨ coi l√† Email, ng∆∞·ª£c l·∫°i l√† CCCD
      const params = new URLSearchParams();
      params.set("mode", "auth");
      if (idVal.includes("@")) {
        params.set("email", idVal);
      } else {
        params.set("cccd", idVal);
      }
      params.set("pass", pass);
  
      const url = WEB_APP_URL + "?" + params.toString();
      const data = await callJsonp(url);
  
      if (!data) {
        alert("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu ƒëƒÉng nh·∫≠p t·ª´ Web App.");
        return;
      }
      if (!data.ok) {
        alert(data.message || "ƒêƒÉng nh·∫≠p kh√¥ng th√†nh c√¥ng. Vui l√≤ng ki·ªÉm tra l·∫°i CCCD/Email v√† m·∫≠t kh·∫©u.");
        return;
      }
  
      // L∆∞u th√¥ng tin h·ªçc sinh
      CURRENT_STUDENT = data.student;
      setStudentHeader(CURRENT_STUDENT);
  
      // Chuy·ªÉn sang tab V√†o thi
      const examTabBtn = Array.from(document.querySelectorAll("nav button"))
        .find(b => (b.textContent || "").includes("V√†o thi"));
      show("exam", examTabBtn || null);
  
      // Load examList & k·∫øt qu·∫£ c√° nh√¢n
      loadExamList();
      loadMyResults(CURRENT_STUDENT.cccd);
  
    } catch (err) {
      console.error("L·ªói ƒëƒÉng nh·∫≠p:", err);
      alert("C√≥ l·ªói khi ƒëƒÉng nh·∫≠p. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi m·∫°ng ho·∫∑c Web App URL.");
    }
  }


  async function loadExamList(){
    try{
      const data = await callJsonp(WEB_APP_URL + "?mode=examList");
      if(!data || !data.exams) return;
      EXAM_LIST = data.exams || [];

      if(!EXAM_LIST.length) return;

      // T√¨m ca thi ƒëang ch·∫°y (running) ho·∫∑c ca ƒë·∫ßu ti√™n
      let active = EXAM_LIST.find(e => e.active) || EXAM_LIST[0];

      const examCodeInput = document.getElementById("exam-code");
      const examLinkInput = document.getElementById("examLink");

      if(examCodeInput && active){
        examCodeInput.value = active.id || "";
      }
      if(examLinkInput && active){
        examLinkInput.value = active.link || "";
      }

      // Kh·ªüi ƒë·ªông ƒë·∫øm ng∆∞·ª£c n·∫øu c√≥ th·ªùi gian k·∫øt th√∫c
      if(active){
        if (typeof active.endMs === "number" && !isNaN(active.endMs)) {
          startExamCountdown(active.endMs);
        } else if (typeof active.remainMs === "number" && !isNaN(active.remainMs)) {
          startExamCountdown(Date.now() + active.remainMs);
        }
      }

    }catch(err){
      console.error("L·ªói load examList:", err);
    }
  }

  function applyExamConfigByCode(code){
    if(!code || !EXAM_LIST.length) return;
    const trimCode = code.toString().trim();
    const exam = EXAM_LIST.find(e => (e.id || "").toString().trim() === trimCode);
    if(!exam) return;

    const examLinkInput = document.getElementById("examLink");
    if(examLinkInput){
      examLinkInput.value = exam.link || "";
    }

    if (typeof exam.endMs === "number" && !isNaN(exam.endMs)) {
      startExamCountdown(exam.endMs);
    } else if (typeof exam.remainMs === "number" && !isNaN(exam.remainMs)) {
      startExamCountdown(Date.now() + exam.remainMs);
    }
  }

  function startExamCountdown(endMs){
    EXAM_END_MS = endMs;
    if(EXAM_TIMER){
      clearInterval(EXAM_TIMER);
      EXAM_TIMER = null;
    }
    updateExamTimer();
    EXAM_TIMER = setInterval(updateExamTimer, 1000);
  }

  function updateExamTimer(){
    const el = document.getElementById("examTimer");
    const btn = document.getElementById("btnStartExam");
    if(!el || !EXAM_END_MS){
      if(el) el.textContent = "--:--";
      if(btn) btn.disabled = false;
      return;
    }
    const diff = EXAM_END_MS - Date.now();
    if(diff <= 0){
      el.textContent = "00:00";
      if(EXAM_TIMER){
        clearInterval(EXAM_TIMER);
        EXAM_TIMER = null;
      }
      if(btn){
        btn.disabled = true;
        btn.textContent = "ƒê√É H·∫æT GI·ªú";
      }
      alert("‚è∞ ƒê√É H·∫æT GI·ªú L√ÄM B√ÄI.\nVui l√≤ng b·∫•m G·ª¨I tr√™n bi·ªÉu m·∫´u (n·∫øu ch∆∞a th·ª±c hi·ªán) ƒë·ªÉ h·ªá th·ªëng ghi nh·∫≠n.");
      return;
    }

    const totalSec = Math.floor(diff / 1000);
    const min = String(Math.floor(totalSec / 60)).padStart(2, "0");
    const sec = String(totalSec % 60).padStart(2, "0");
    el.textContent = min + ":" + sec;
    if(btn){
      btn.disabled = false;
      btn.textContent = "V√†o thi / Start exam";
    }
  }

  async function loadMyResults(cccd){
    if(!cccd) return;
    try{
      const url = WEB_APP_URL + "?mode=apiMyResults&cccd=" + encodeURIComponent(cccd);
      const data = await callJsonp(url);
      renderMyResults(data);
    }catch(err){
      console.error("L·ªói loadMyResults:", err);
      const box = document.getElementById("reviewContent");
      const wrap = document.getElementById("reviewBox");
      if(box && wrap){
        box.innerHTML = "<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c b√°o cho gi√°o vi√™n ph·ª• tr√°ch.</p>";
        wrap.style.display = "block";
      }
    }
  }

  function renderMyResults(data){
    const box = document.getElementById("reviewContent");
    const wrap = document.getElementById("reviewBox");
    if(!box || !wrap) return;

    if(!data || !data.ok){
      box.innerHTML = "<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
      wrap.style.display = "block";
      return;
    }

    if(!data.found){
      box.innerHTML = `
        <p>Ch∆∞a c√≥ b√†i l√†m n√†o ƒë∆∞·ª£c ghi nh·∫≠n cho CCCD: <b>${data.cccd || ""}</b>.</p>
        <p>Sau khi l√†m b√†i xong v√† h·ªá th·ªëng ghi v√†o sheet <code>DiemThi</code>, khung n√†y s·∫Ω hi·ªÉn th·ªã ƒëi·ªÉm & chi ti·∫øt.</p>
      `;
      wrap.style.display = "block";
      return;
    }

    const latest = data.latest || (data.results && data.results[0]) || {};
    let html = `
      <p><b>CCCD:</b> ${data.cccd || latest.cccd || ""}</p>
      <p><b>L·∫ßn l√†m g·∫ßn nh·∫•t:</b> ${latest.time || ""}</p>
      <p><b>ƒêi·ªÉm:</b> <span style="font-size:1.1rem;color:#2563eb;font-weight:600;">${latest.score ?? ""}</span></p>
      <p><b>L·ªõp:</b> ${latest.className || ""} ¬∑ <b>Tr∆∞·ªùng:</b> ${latest.school || ""}</p>
    `;

    if(latest.details){
      html += `<h4 style="margin:10px 0 4px;font-size:.85rem;">Chi ti·∫øt t·ª´ng c√¢u:</h4>`;
      html += `<ul class="review-list">`;
      Object.keys(latest.details).forEach(code=>{
        const it = latest.details[code] || {};
        html += `
          <li>
            <b>${code}</b>:
            Tr·∫£ l·ªùi <span style="color:#2563eb;">${it.answer ?? ""}</span>,
            ƒê√°p √°n ƒë√∫ng <span style="color:#16a34a;">${it.correct ?? ""}</span>
          </li>
        `;
      });
      html += `</ul>`;
    }

    if(data.results && data.results.length > 1){
      html += `<h4 style="margin:10px 0 4px;font-size:.85rem;">C√°c l·∫ßn l√†m kh√°c:</h4><ul class="review-list">`;
      data.results.slice(1).forEach(r=>{
        html += `<li>${r.time || ""} ‚Äì ƒêi·ªÉm: <b>${r.score ?? ""}</b></li>`;
      });
      html += `</ul>`;
    }

    box.innerHTML = html;
    wrap.style.display = "block";
  }

  async function loadDashboard(){
    try{
      const url = WEB_APP_URL + "?mode=stats";
      const data = await callJsonp(url);
      if(!data) return;

      document.querySelector("#statTotal .value").textContent = data.total || 0;

      if(data.byKhoi){
        const entries = Object.entries(data.byKhoi);
        document.querySelector("#statKhoi .value").textContent =
          entries.map(([k,v])=>k+": "+v).join(" ¬∑ ") || "‚Äî";
        const ctx = document.getElementById("chartKhoi");
        if(ctx){
          new Chart(ctx,{
            type:"bar",
            data:{
              labels:entries.map(e=>e[0]),
              datasets:[{
                label:"S·ªë HS",
                data:entries.map(e=>e[1])
              }]
            },
            options:{
              plugins:{legend:{display:false}},
              scales:{
                x:{ticks:{font:{size:11}}},
                y:{beginAtZero:true,ticks:{stepSize:1}}
              }
            }
          });
        }
      }
      if(data.byGender){
        document.querySelector("#statGioiTinh .value").textContent =
          Object.entries(data.byGender).map(([k,v])=>k+": "+v).join(" ¬∑ ") || "‚Äî";
      }
      if(data.byEthnicity){
        document.querySelector("#statEthnic .value").textContent =
          Object.entries(data.byEthnicity).map(([k,v])=>k+": "+v).join(" ¬∑ ") || "‚Äî";
      }
      if(data.bySchool){
        document.querySelector("#statSchool .value").textContent =
          Object.entries(data.bySchool).map(([k,v])=>k+": "+v).join(" ¬∑ ") || "‚Äî";
      }
    }catch(err){
      console.error("L·ªói load Dashboard:",err);
    }
  }

  function buildSearchUrl(){
    const cccd = document.getElementById("search-cccd").value.trim();
    const name = document.getElementById("search-name").value.trim().toUpperCase();
    const className = document.getElementById("search-class").value.trim().toUpperCase();
    const params = new URLSearchParams();
    params.set("mode","search");
    if(cccd) params.set("cccd", cccd);
    if(name) params.set("name", name);
    if(className) params.set("className", className);
    return WEB_APP_URL + "?" + params.toString();
  }

  function renderSearchResults(data){
    const statusEl = document.getElementById("status");
    const resultsEl= document.getElementById("results");
    resultsEl.innerHTML="";
    if(!data){
      statusEl.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ.";
      statusEl.className = "status-msg status-error";
      return;
    }
    if(!data.found){
      statusEl.textContent = data.message || "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.";
      statusEl.className = "status-msg status-empty";
      return;
    }
    statusEl.textContent = data.message || "";
    statusEl.className = "status-msg";
    (data.results || []).forEach(row=>{
      const div = document.createElement("div");
      div.className = "result-card";
      div.innerHTML = `
        <h4>${row.name || ""} ‚Äì ${row.className || ""}</h4>
        <div class="result-meta">
          <span>ƒêi·ªÉm: <b>${row.score ?? ""}</b></span>
          <span>CCCD: ${row.cccd || "‚Äî"}</span>
          <span>Gi·ªõi t√≠nh: ${row.gender || "‚Äî"}</span>
          <span>D√¢n t·ªôc: ${row.ethnic || "‚Äî"}</span>
          <span>Tr∆∞·ªùng: ${row.school || "‚Äî"}</span>
        </div>
      `;
      resultsEl.appendChild(div);
    });
  }

  // Kh·ªüi t·∫°o Ng√†y sinh cho mobile
  function setupNgaySinh(){
    const daySel = document.getElementById("dob-day");
    const monthSel = document.getElementById("dob-month");
    const yearSel = document.getElementById("dob-year");
    const hidden = document.getElementById("ngaysinh");
    if(!daySel || !monthSel || !yearSel || !hidden) return;

    daySel.innerHTML = '<option value="">Ng√†y</option>';
    for(let d=1; d<=31; d++){
      const opt = document.createElement("option");
      opt.value = String(d).padStart(2,"0");
      opt.textContent = d;
      daySel.appendChild(opt);
    }

    monthSel.innerHTML = '<option value="">Th√°ng</option>';
    for(let m=1; m<=12; m++){
      const opt = document.createElement("option");
      opt.value = String(m).padStart(2,"0");
      opt.textContent = m;
      monthSel.appendChild(opt);
    }

    yearSel.innerHTML = '<option value="">NƒÉm</option>';
    for(let y=2015; y>=1980; y--){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = y;
      yearSel.appendChild(opt);
    }

    function syncDob(){
      const d = daySel.value;
      const m = monthSel.value;
      const y = yearSel.value;
      hidden.value = (d && m && y) ? (d + "/" + m + "/" + y) : "";
    }
    daySel.addEventListener("change", syncDob);
    monthSel.addEventListener("change", syncDob);
    yearSel.addEventListener("change", syncDob);

    const regForm = document.getElementById("regForm");
    if(regForm){
      regForm.addEventListener("submit", function(){ syncDob(); }, {capture:true});
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    setupNgaySinh();
    loadDashboard();

    // Tra c·ª©u k·∫øt qu·∫£
    const searchForm = document.getElementById("searchForm");
    if(searchForm){
      searchForm.addEventListener("submit", async function(e){
        e.preventDefault();
        const statusEl = document.getElementById("status");
        const resultsEl= document.getElementById("results");
        resultsEl.innerHTML="";
        statusEl.textContent = "ƒêang tra c·ª©u, vui l√≤ng ch·ªù‚Ä¶";
        statusEl.className = "status-msg status-empty";
        try{
          const url = buildSearchUrl();
          const data = await callJsonp(url);
          renderSearchResults(data);
        }catch(err){
          console.error(err);
          statusEl.textContent = "C√≥ l·ªói khi tra c·ª©u. Th·∫ßy/c√¥ ki·ªÉm tra l·∫°i Code.gs ho·∫∑c k·∫øt n·ªëi m·∫°ng.";
          statusEl.className = "status-msg status-error";
        }
      });
    }

    // Import ƒë·ªÅ t·ª´ Word
    const importForm = document.getElementById("importForm");
    if(importForm){
      importForm.addEventListener("submit", async function(e){
        e.preventDefault();
        const docIdInput = document.getElementById("docId");
        const statusEl = document.getElementById("importStatus");
        const docId = (docIdInput.value || "").trim();

        if (!docId) {
          statusEl.textContent = "Vui l√≤ng nh·∫≠p ID file Google Docs.";
          statusEl.style.color = "#dc2626";
          return;
        }
        statusEl.textContent = "ƒêang import‚Ä¶ Vui l√≤ng ch·ªù 5‚Äì10 gi√¢y.";
        statusEl.style.color = "#6b7280";

        try {
          const url = WEB_APP_URL + "?mode=importDoc&docId=" + encodeURIComponent(docId);
          const data = await callJsonp(url);
          if (!data || data.ok === false) {
            statusEl.textContent = (data && data.message)
              ? data.message
              : "Import kh√¥ng th√†nh c√¥ng. Ki·ªÉm tra l·∫°i docId, m·∫´u ƒë·ªÅ ho·∫∑c Code.gs.";
            statusEl.style.color = "#dc2626";
            return;
          }
          statusEl.textContent = data.message || ("ƒê√£ import " + (data.imported || 0) + " c√¢u h·ªèi v√†o sheet NganHangDe.");
          statusEl.style.color = "#16a34a";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "C√≥ l·ªói khi g·ªçi importDoc. Ki·ªÉm tra l·∫°i Deploy Apps Script ho·∫∑c m·∫°ng.";
          statusEl.style.color = "#dc2626";
        }
      });
    }

    // ƒêƒÉng nh·∫≠p
    const loginForm = document.getElementById("loginForm");
    if(loginForm){
      loginForm.addEventListener("submit", handleLogin);
    }

    // Khi ƒë·ªïi M√£ ca thi, √°p l·∫°i c·∫•u h√¨nh t·ª´ examList (n·∫øu ƒë√£ load)
    const examCodeInput = document.getElementById("exam-code");
    if(examCodeInput){
      examCodeInput.addEventListener("change", function(){
        applyExamConfigByCode(this.value);
      });
    }
  });
</script>
</body>
</html>
