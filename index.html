<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --accent:#4f46e5;
      --danger:#dc2626;
      --bg:#f1f5f9;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e2e8f0;
      --radius:18px;
      --shadow:0 18px 45px rgba(15,23,42,.18);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#dbeafe,#fff);
      color:var(--text);
    }
    .wrap{
      max-width:1080px;
      margin:18px auto 32px;
      padding:0 16px 24px;
    }
    h1{
      font-size:1.6rem;
      margin:0 0 12px;
      text-align:center;
      font-weight:700;
      letter-spacing:.02em;
      color:#111827;
    }
    h1 span{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      color:#fff;
      font-size:.8rem;
      margin-left:8px;
    }
    nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      margin-bottom:14px;
    }
    nav button{
      border:none;
      padding:7px 14px;
      border-radius:999px;
      background:#e5edff;
      color:#1e3a8a;
      font-weight:600;
      font-size:.86rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    nav button.active{
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      color:#fff;
      box-shadow:0 10px 24px rgba(37,99,235,.45);
    }
    nav button span.icon{
      font-size:1rem;
    }

    .qr-block{
      margin:10px auto 16px;
      padding:10px 14px;
      max-width:420px;
      background:rgba(255,255,255,.8);
      border-radius:var(--radius);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      box-shadow:0 12px 30px rgba(15,23,42,.12);
      border:1px solid var(--border);
    }
    .qr-block p{
      margin:0;
      font-size:.9rem;
      color:var(--muted);
      text-align:center;
    }
    .qr-block img{
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.18);
      background:#fff;
      padding:12px;
    }

    .panel{
      display:none;
      background:var(--card);
      border-radius:var(--radius);
      padding:18px 16px 20px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      margin-top:10px;
    }
    .panel.active{display:block;}

    .panel h2{
      margin:0 0 8px;
      font-size:1.2rem;
    }
    .panel p.lead{
      margin:0 0 14px;
      font-size:.9rem;
      color:var(--muted);
    }

    form .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px 14px;
    }
    @media(min-width:720px){
      form .grid-2{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    label{
      font-size:.86rem;
      font-weight:600;
      color:#111827;
      display:block;
      margin-bottom:3px;
    }
    label span.en{
      font-weight:400;
      color:var(--muted);
      font-size:.78rem;
    }
    .field small{
      display:block;
      margin-top:3px;
      font-size:.76rem;
      color:var(--muted);
    }
    input[type="text"],
    input[type="email"],
    input[type="date"],
    select,
    textarea{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:.9rem;
      font-family:inherit;
      outline:none;
      background:#f9fafb;
      transition:border-color .15s,box-shadow .15s,background .15s;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      background:#fff;
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
    }
    textarea{min-height:60px;resize:vertical;}

    .btn-primary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 18px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      color:#fff;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      margin-top:6px;
      box-shadow:0 12px 30px rgba(37,99,235,.45);
    }
    .btn-primary[disabled]{
      opacity:.7;
      cursor:default;
      box-shadow:none;
    }

    .note{
      margin-top:6px;
      font-size:.78rem;
      color:var(--muted);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .stat-card{
      border-radius:14px;
      padding:10px 12px;
      background:#f9fafb;
      border:1px solid var(--border);
    }
    .stat-card h3{
      margin:0 0 6px;
      font-size:.88rem;
      font-weight:700;
    }
    .stat-card ul{
      list-style:none;
      padding:0;
      margin:0;
      max-height:180px;
      overflow:auto;
      font-size:.8rem;
    }
    .stat-card li{
      display:flex;
      justify-content:space-between;
      padding:2px 0;
    }
    .stat-card li span.label{
      color:var(--muted);
    }
    .chip{
      display:inline-block;
      min-width:32px;
      padding:2px 8px;
      border-radius:999px;
      background:#e0ecff;
      text-align:right;
      font-size:.75rem;
      font-variant-numeric:tabular-nums;
      color:#1d4ed8;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.82rem;
    }
    th,td{
      border-bottom:1px solid var(--border);
      padding:5px 6px;
      text-align:left;
    }
    th{
      background:#eff6ff;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody tr:nth-child(odd){background:#f9fafb;}
    .table-wrap{
      max-height:260px;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f9fafb;
      margin-top:8px;
    }

    .search-grid{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:8px;
    }
    @media(max-width:640px){
      .search-grid{grid-template-columns:1fr;}
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      background:#eff6ff;
      font-size:.75rem;
      color:#1d4ed8;
      margin-bottom:6px;
    }
    .tag span.icon{font-size:.9rem;}
    .result-card{
      margin-top:8px;
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      background:#f9fafb;
    }
    .result-card h3{
      margin:0 0 6px;
      font-size:.96rem;
    }
    .result-card p{margin:2px 0;font-size:.82rem;}
    .result-card span.label{color:var(--muted);}
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:.72rem;
      background:#dcfce7;
      color:#166534;
      font-weight:600;
    }
    .text-danger{color:var(--danger);}
  </style>
</head>
<body>
<div class="wrap">
  <h1>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online <span>DTAI Online</span></h1>

  <nav>
    <button onclick="showPanel('reg', this)" class="active"><span class="icon">üìù</span>ƒêƒÉng k√Ω</button>
    <button onclick="showPanel('login', this)"><span class="icon">üîë</span>ƒêƒÉng nh·∫≠p</button>
    <button onclick="showPanel('exam', this)"><span class="icon">üìö</span>V√†o thi</button>
    <button onclick="showPanel('review', this)"><span class="icon">üîç</span>Xem l·∫°i k·∫øt qu·∫£</button>
    <button onclick="showPanel('dashboardReg', this)"><span class="icon">üìä</span>Th·ªëng k√™ ƒëƒÉng k√Ω</button>
    <button onclick="showPanel('dashboardScore', this)"><span class="icon">üìà</span>Th·ªëng k√™ ƒëi·ªÉm</button>
  </nav>

  <div class="qr-block">
    <p>Qu√©t QR ƒë·ªÉ m·ªü trang ƒëƒÉng k√Ω tr√™n ƒëi·ªán tho·∫°i</p>
    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https%3A%2F%2Ftrungk8.github.io%2FDTAI_Online%2F"
      alt="QR Code ƒëƒÉng k√Ω"
    />
  </div>

  <!-- ƒêƒÇNG K√ù -->
  <section id="reg" class="panel active">
    <h2>ƒêƒÉng k√Ω tham gia ki·ªÉm tra</h2>
    <p class="lead">
      Vui l√≤ng nh·∫≠p th√¥ng tin ch√≠nh x√°c. H·ªç t√™n v√† L·ªõp s·∫Ω t·ª± chuy·ªÉn sang <b>CH·ªÆ IN HOA</b> ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu.
    </p>

    <!-- g·ª≠i th·∫≥ng t·ªõi Apps Script -->
    <form id="regForm"
          method="POST"
          target="hidden_iframe"
          action="https://script.google.com/macros/s/AKfycbxIRwnJhmX8lqY78QYpGiXXCYtWfCBrGVNZUoyJvhgJ0Ej6cYooLL-pVZPGJmOXKtY2/exec"
          onsubmit="handleSubmit()">

      <div class="grid grid-2">
        <div class="field">
          <label for="hoten">H·ªç v√† t√™n <span class="en">/ Full name</span></label>
          <input id="hoten" name="hoten" type="text" autocomplete="name" required
                 placeholder="VD: Nguy·ªÖn VƒÉn A" />
          <small>Nh·∫≠p ƒë√∫ng ch√≠nh t·∫£ ti·∫øng Vi·ªát, h·ªá th·ªëng s·∫Ω t·ª± chuy·ªÉn sang IN HOA.</small>
        </div>

        <div class="field">
          <label for="ngaysinh">Ng√†y sinh <span class="en">/ Date of birth</span></label>
          <input id="ngaysinh" name="ngaysinh" type="date" />
          <small>ƒê·ªãnh d·∫°ng: ng√†y/th√°ng/nƒÉm.</small>
        </div>

        <div class="field">
          <label for="gioitinh">Gi·ªõi t√≠nh <span class="en">/ Gender</span></label>
          <select id="gioitinh" name="gioitinh">
            <option value="">-- Ch·ªçn --</option>
            <option>Nam</option>
            <option>N·ªØ</option>
            <option>Kh√°c</option>
          </select>
          <small>Ch·ªçn gi·ªõi t√≠nh hi·ªán t·∫°i c·ªßa em.</small>
        </div>

        <div class="field">
          <label for="dantoc">D√¢n t·ªôc <span class="en">/ Ethnicity</span></label>
          <select id="dantoc" name="dantoc">
            <option value="">-- Ch·ªçn --</option>
            <option value="Kinh">Kinh</option>
            <option value="Chu Ru">Chu Ru</option>
            <option value="C∆° Ho">C∆° Ho</option>
            <option value="M·∫°">M·∫°</option>
            <option value="N√πng">N√πng</option>
            <option value="T√†y">T√†y</option>
            <option value="Kh√°c">Kh√°c</option>
          </select>
          <small>N·∫øu kh√¥ng c√≥ trong danh s√°ch, ch·ªçn <b>Kh√°c</b>.</small>
        </div>        
        
        <div class="field">
          <label for="khoi">Kh·ªëi <span class="en">/ Grade</span></label>
          <select id="khoi" name="khoi">
            <option value="">-- Ch·ªçn kh·ªëi --</option>
            <option value="10">Kh·ªëi 10</option>
            <option value="11">Kh·ªëi 11</option>
            <option value="12">Kh·ªëi 12</option>
          </select>
          <small>V√≠ d·ª•: em ƒëang h·ªçc l·ªõp 11A3 th√¨ ch·ªçn <b>Kh·ªëi 11</b>.</small>
        </div>

        <div class="field">
          <label for="malop">
            L·ªõp <span class="en">/ Class</span>
          </label>
          <input id="malop" name="malop" type="text"
                 list="lop_suggestions"
                 placeholder="VD: 12A1" />
          <datalist id="lop_suggestions">
            <option value="10A1"></option>
            <option value="10A2"></option>
            <option value="10A3"></option>
            <option value="11A1"></option>
            <option value="11A2"></option>
            <option value="12A1"></option>
            <option value="12A2"></option>
          </datalist>
          <small>C√≥ s·∫µn g·ª£i √Ω nh∆∞ng v·∫´n c√≥ th·ªÉ t·ª± nh·∫≠p. H·ªá th·ªëng s·∫Ω t·ª± IN HOA.</small>
        </div>


        <div class="field">
          <label for="truong">Tr∆∞·ªùng <span class="en">/ School</span></label>
          <select id="truong" name="truong">
            <option value="">-- Ch·ªçn tr∆∞·ªùng --</option>
            <option>THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
            <option>THPT Ph·∫°m VƒÉn ƒê·ªìng</option>
            <option>THPT ƒê·ª©c Tr·ªçng</option>
            <option>THPT L∆∞∆°ng Th·∫ø Vinh</option>
            <option value="khac">Kh√°c (ghi th√™m)</option>
          </select>
          <small>N·∫øu ch·ªçn ‚ÄúKh√°c‚Äù, ƒëi·ªÅn t√™n tr∆∞·ªùng t·∫°i √¥ ph√≠a d∆∞·ªõi.</small>
        </div>

        <div class="field">
          <label for="truong_khac">Tr∆∞·ªùng (kh√°c) <span class="en">/ Other school</span></label>
          <input id="truong_khac" name="truong_khac" type="text"
                 placeholder="VD: THPT ‚Ä¶" />
          <small>Kh√¥ng b·∫Øt bu·ªôc. Ch·ªâ ƒëi·ªÅn khi tr∆∞·ªùng kh√¥ng c√≥ trong danh s√°ch.</small>
        </div>

        <div class="field">
          <label for="xa">X√£/Ph∆∞·ªùng <span class="en">/ Ward</span></label>
          <input id="xa" name="xa" type="text"
                 placeholder="VD: X√£ Ninh Gia" />
          <small>Ghi r√µ X√£/Ph∆∞·ªùng ƒëang sinh s·ªëng.</small>
        </div>

        <div class="field">
          <label for="tinh">T·ªânh/TP <span class="en">/ Province</span></label>
          <select id="tinh" name="tinh">
            <option value="">-- Ch·ªçn --</option>
            <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
            <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
            <option value="H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
            <option value="H√† N·ªôi">H√† N·ªôi</option>
            <option value="Kh√°c">Kh√°c (ghi th√™m)</option>
          </select>
          <small>N·∫øu ch·ªçn ‚ÄúKh√°c‚Äù, ƒëi·ªÅn t√™n t·ªânh t·∫°i √¥ ph√≠a d∆∞·ªõi.</small>
        </div>

        <div class="field">
          <label for="tinh_khac">T·ªânh/TP (kh√°c) <span class="en">/ Other province</span></label>
          <input id="tinh_khac" name="tinh_khac" type="text"
                 placeholder="VD: B√¨nh Thu·∫≠n" />
          <small>Kh√¥ng b·∫Øt bu·ªôc.</small>
        </div>


        <div class="field">
          <label for="cccd">CCCD <span class="en">/ Citizen ID</span></label>
          <input id="cccd" name="cccd" type="text"
                 inputmode="numeric"
                 pattern="[0-9]{9,12}"
                 maxlength="12"
                 placeholder="Ch·ªâ nh·∫≠p s·ªë, VD: 123456789012" />
          <small>Ch·ªâ ch·ª©a k√Ω t·ª± s·ªë. D√πng ƒë·ªÉ ch·ªëng ƒëƒÉng k√Ω tr√πng.</small>
        </div>

        <div class="field">
          <label for="email">Email <span class="en">/ Email</span></label>
          <input id="email" name="email" type="email"
                 placeholder="VD: ten@gmail.com" />
          <small>Email nh·∫≠n th√¥ng b√°o ƒëƒÉng k√Ω v√† k·∫øt qu·∫£.</small>
        </div>

        <div class="field">
          <label for="ghichu">Ghi ch√∫ <span class="en">/ Note</span></label>
          <textarea id="ghichu" name="ghichu"
                    placeholder="VD: C√≥ nhu c·∫ßu thi th·ª≠ th√™m m√¥n..."></textarea>
          <small>Kh√¥ng b·∫Øt bu·ªôc.</small>
        </div>
      </div>

      <button id="btn-submit" class="btn-primary" type="submit">
        <span>‚úÖ G·ª≠i th√¥ng tin ƒëƒÉng k√Ω</span>
      </button>

      <div id="submitStatus" class="note"></div>
    </form>

    <iframe name="hidden_iframe" style="display:none"></iframe>
  </section>

  <!-- ƒêƒÇNG NH·∫¨P (placeholder) -->
  <section id="login" class="panel">
    <h2>ƒêƒÉng nh·∫≠p (ƒëang ph√°t tri·ªÉn)</h2>
    <p class="lead">
      Ph·∫ßn ƒëƒÉng nh·∫≠p t√†i kho·∫£n gi√°o vi√™n / qu·∫£n tr·ªã s·∫Ω b·ªï sung sau. Hi·ªán t·∫°i d√πng tr·ª±c ti·∫øp Dashboard & Google Sheet.
    </p>
  </section>

  <!-- V√ÄO THI -->
  <section id="exam" class="panel">
    <h2>V√†o thi</h2>
    <p class="lead">
      H·ªçc sinh b·∫•m n√∫t b√™n d∆∞·ªõi ƒë·ªÉ v√†o ƒë·ªÅ thi Google Form/Quiz t∆∞∆°ng ·ª©ng.
    </p>
    <div class="field">
      <label>ƒê·ªÅ thi ch√≠nh <span class="en">/ Main quiz link</span></label>
      <p class="note">
        Th·∫ßy/c√¥ thay ƒë∆∞·ªùng link Form thi th·∫≠t t·∫°i ƒë√¢y.
      </p>
      <a class="btn-primary" href="#" id="examLink" target="_blank">
        <span>üöÄ M·ªü ƒë·ªÅ thi</span>
      </a>
    </div>
  </section>

  <!-- XEM L·∫†I K·∫æT QU·∫¢ -->
  <section id="review" class="panel">
    <h2>Xem l·∫°i k·∫øt qu·∫£ b√†i thi</h2>
    <p class="lead">
      ∆Øu ti√™n tra c·ª©u b·∫±ng <b>CCCD</b>. N·∫øu kh√¥ng nh·ªõ CCCD, c√≥ th·ªÉ d√πng <b>H·ªç t√™n + L·ªõp</b>.
    </p>

    <div class="tag"><span class="icon">‚ÑπÔ∏è</span> D·ªØ li·ªáu l·∫•y t·ª´ sheet <b>DiemThi</b> tr√™n Google Sheet.</div>

    <div class="search-grid">
      <form id="searchForm" onsubmit="handleSearch(event)">
        <div class="field">
          <label for="s_cccd">CCCD</label>
          <input id="s_cccd" type="text" inputmode="numeric" maxlength="12"
                 placeholder="Nh·∫≠p ch√≠nh x√°c s·ªë CCCD (n·∫øu c√≥)" />
        </div>
        <div class="field">
          <label for="s_name">H·ªç t√™n (IN HOA)</label>
          <input id="s_name" type="text"
                 placeholder="VD: NGUY·ªÑN VƒÇN A" />
        </div>
        <div class="field">
          <label for="s_class">L·ªõp</label>
          <input id="s_class" type="text" placeholder="VD: 12A1" />
        </div>
        <button class="btn-primary" type="submit">
          <span>üîç Tra c·ª©u k·∫øt qu·∫£</span>
        </button>
        <p class="note">
          N·∫øu ƒë√£ nh·∫≠p CCCD th√¨ kh√¥ng b·∫Øt bu·ªôc H·ªç t√™n / L·ªõp.
        </p>
      </form>

      <div id="searchResultBox">
        <!-- k·∫øt qu·∫£ tra c·ª©u s·∫Ω g·∫Øn ·ªü ƒë√¢y -->
      </div>
    </div>
  </section>

  <!-- DASHBOARD ƒêƒÇNG K√ù -->
  <section id="dashboardReg" class="panel">
    <h2>Dashboard th·ªëng k√™ ƒëƒÉng k√Ω</h2>
    <p class="lead">
      Th·ªëng k√™ theo Kh·ªëi, L·ªõp, Gi·ªõi t√≠nh, D√¢n t·ªôc v√† Tr∆∞·ªùng t·ª´ sheet <b>DangKy</b>.
    </p>
    <button id="btn-load-stats" class="btn-primary" type="button" onclick="loadStats()">
      <span>üìä T·∫£i th·ªëng k√™</span>
    </button>
    <div class="note" id="statsStatus"></div>

    <div class="stats-grid" id="statsGrid" style="display:none;">
      <div class="stat-card">
        <h3>Theo kh·ªëi</h3>
        <ul id="statByKhoi"></ul>
      </div>
      <div class="stat-card">
        <h3>Theo l·ªõp</h3>
        <ul id="statByLop"></ul>
      </div>
      <div class="stat-card">
        <h3>Theo gi·ªõi t√≠nh</h3>
        <ul id="statByGender"></ul>
      </div>
      <div class="stat-card">
        <h3>Theo d√¢n t·ªôc</h3>
        <ul id="statByEthnic"></ul>
      </div>
      <div class="stat-card">
        <h3>Theo tr∆∞·ªùng</h3>
        <ul id="statBySchool"></ul>
      </div>
    </div>
  </section>

  <!-- DASHBOARD ƒêI·ªÇM -->
  <section id="dashboardScore" class="panel">
    <h2>Th·ªëng k√™ & danh s√°ch ƒëi·ªÉm</h2>
    <p class="lead">
      L·∫•y d·ªØ li·ªáu t·ª´ sheet <b>DiemThi</b> (t·ªëi ƒëa 1500 d√≤ng g·∫ßn nh·∫•t).
    </p>
    <button id="btn-load-scores" class="btn-primary" type="button" onclick="loadScores()">
      <span>üìà T·∫£i danh s√°ch ƒëi·ªÉm</span>
    </button>
    <div class="note" id="scoreStatus"></div>

    <div class="table-wrap" id="scoreTableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>Th·ªùi gian</th>
            <th>H·ªç t√™n</th>
            <th>L·ªõp</th>
            <th>ƒêi·ªÉm</th>
          </tr>
        </thead>
        <tbody id="scoreTableBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIRwnJhmX8lqY78QYpGiXXCYtWfCBrGVNZUoyJvhgJ0Ej6cYooLL-pVZPGJmOXKtY2/exec";

  function showPanel(id, btn){
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // T·ª± IN HOA cho h·ªç t√™n + l·ªõp
  document.addEventListener('DOMContentLoaded', () => {
    const hoten = document.getElementById('hoten');
    const malop = document.getElementById('malop');
    if(hoten){
      hoten.addEventListener('blur', () => {
        hoten.value = hoten.value.toLocaleUpperCase('vi-VN');
      });
    }
    if(malop){
      malop.addEventListener('blur', () => {
        malop.value = malop.value.toUpperCase();
      });
    }
  });

  function handleSubmit(){
    const btn = document.getElementById('btn-submit');
    const status = document.getElementById('submitStatus');
    btn.disabled = true;
    btn.innerHTML = "‚è≥ ƒêang g·ª≠i d·ªØ li·ªáu...";
    status.textContent = "ƒêang g·ª≠i th√¥ng tin l√™n h·ªá th·ªëng, vui l√≤ng ch·ªù trong gi√¢y l√°t...";
    setTimeout(() => {
      btn.disabled = false;
      btn.innerHTML = "<span>‚úÖ G·ª≠i th√¥ng tin ƒëƒÉng k√Ω</span>";
      status.textContent = "N·∫øu m√†n h√¨nh hi·ªÉn th·ªã th√¥ng b√°o 'ƒêƒÉng k√Ω th√†nh c√¥ng' th√¨ d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.";
    }, 2500);
  }

  // JSONP helper
  function jsonp(params, cb){
    const callbackName = "cb_" + Math.random().toString(36).slice(2);
    window[callbackName] = function(data){
      cb(data);
      delete window[callbackName];
      script.remove();
    };
    const qs = new URLSearchParams(Object.assign({}, params, {callback:callbackName})).toString();
    const script = document.createElement('script');
    script.src = SCRIPT_URL + "?" + qs;
    document.body.appendChild(script);
  }

  // ===== DASHBOARD ƒêƒÇNG K√ù =====
  function loadStats(){
    const status = document.getElementById('statsStatus');
    const btn = document.getElementById('btn-load-stats');
    btn.disabled = true;
    status.textContent = "ƒêang t·∫£i th·ªëng k√™ t·ª´ Google Sheet...";
    jsonp({mode:"stats"}, data => {
      btn.disabled = false;
      if(!data || !data.total){
        status.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu ƒëƒÉng k√Ω ho·∫∑c c·∫•u h√¨nh ch∆∞a ƒë√∫ng.";
        document.getElementById('statsGrid').style.display = "none";
        return;
      }
      status.textContent = "T·ªïng s·ªë h·ªçc sinh ƒë√£ ƒëƒÉng k√Ω: " + data.total + " em.";
      renderStatList('statByKhoi', data.byKhoi);
      renderStatList('statByLop', data.byLop);
      renderStatList('statByGender', data.byGender);
      renderStatList('statByEthnic', data.byEthnicity);
      renderStatList('statBySchool', data.bySchool);
      document.getElementById('statsGrid').style.display = "grid";
    });
  }

  function renderStatList(id, obj){
    const ul = document.getElementById(id);
    ul.innerHTML = "";
    if(!obj) return;
    Object.keys(obj).sort().forEach(key => {
      const li = document.createElement('li');
      const label = document.createElement('span');
      label.className = "label";
      label.textContent = key;
      const chip = document.createElement('span');
      chip.className = "chip";
      chip.textContent = obj[key];
      li.appendChild(label);
      li.appendChild(chip);
      ul.appendChild(li);
    });
  }

  // ===== DASHBOARD ƒêI·ªÇM =====
  function loadScores(){
    const status = document.getElementById('scoreStatus');
    const btn = document.getElementById('btn-load-scores');
    btn.disabled = true;
    status.textContent = "ƒêang t·∫£i d·ªØ li·ªáu ƒëi·ªÉm t·ª´ Google Sheet...";
    jsonp({mode:"results"}, data => {
      btn.disabled = false;
      if(!data || !data.rows || !data.rows.length){
        status.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm ho·∫∑c c·∫•u h√¨nh RESULT_* ch∆∞a ƒë√∫ng.";
        document.getElementById('scoreTableWrap').style.display = "none";
        return;
      }
      status.textContent = "ƒê√£ t·∫£i " + data.rows.length + " d√≤ng ƒëi·ªÉm g·∫ßn nh·∫•t.";
      const tbody = document.getElementById('scoreTableBody');
      tbody.innerHTML = "";
      data.rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML =
          "<td>" + (r.time || "") + "</td>" +
          "<td>" + (r.name || "") + "</td>" +
          "<td>" + (r.class || "") + "</td>" +
          "<td>" + (r.score || "") + "</td>";
        tbody.appendChild(tr);
      });
      document.getElementById('scoreTableWrap').style.display = "block";
    });
  }

  // ===== TRA C·ª®U K·∫æT QU·∫¢ =====
  function handleSearch(e){
    e.preventDefault();
    const cccd = document.getElementById('s_cccd').value.trim();
    let name = document.getElementById('s_name').value.trim();
    let clazz = document.getElementById('s_class').value.trim();
    if(!cccd && !name){
      alert("Vui l√≤ng nh·∫≠p CCCD ho·∫∑c H·ªç t√™n.");
      return;
    }
    name = name.toLocaleUpperCase('vi-VN');
    clazz = clazz.toUpperCase();
    const box = document.getElementById('searchResultBox');
    box.innerHTML = "<p class='note'>ƒêang tra c·ª©u d·ªØ li·ªáu, vui l√≤ng ch·ªù...</p>";

    // G·ªçi JSONP mode=search (c·∫ßn ƒëo·∫°n x·ª≠ l√Ω t∆∞∆°ng ·ª©ng trong doGet c·ªßa Code.gs)
    jsonp({mode:"search", cccd:cccd, name:name, className:clazz}, data => {
      if(!data || !data.found){
        const msg = data && data.message ? data.message : "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.";
        box.innerHTML = "<p class='text-danger' style='font-size:.86rem;'>‚ö† " + msg + "</p>";
        return;
      }
      const results = data.results || [];
      if(!results.length){
        box.innerHTML = "<p class='text-danger' style='font-size:.86rem;'>‚ö† Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</p>";
        return;
      }
      const first = results[0];
      const div = document.createElement('div');
      div.className = "result-card";
      div.innerHTML =
        "<h3>K·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c</h3>" +
        "<p><span class='label'>H·ªç t√™n: </span><b>" + (first.name || "") + "</b></p>" +
        "<p><span class='label'>L·ªõp: </span><b>" + (first.className || "") + "</b></p>" +
        "<p><span class='label'>ƒêi·ªÉm: </span><span class='badge'>" + (first.score || "") + "</span></p>" +
        "<p><span class='label'>CCCD: </span>" + (first.cccd || "‚Äî") + "</p>" +
        "<p><span class='label'>Gi·ªõi t√≠nh: </span>" + (first.gender || "‚Äî") +
        " ‚Ä¢ <span class='label'>D√¢n t·ªôc: </span>" + (first.ethnic || "‚Äî") + "</p>" +
        "<p><span class='label'>Tr∆∞·ªùng: </span>" + (first.school || "‚Äî") + "</p>" +
        "<p class='note'>" + (data.message || "") + "</p>";
      box.innerHTML = "";
      box.appendChild(div);
    });
  }
</script>
</body>
</html>
