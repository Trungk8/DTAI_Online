<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js cho Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#2563eb;
      --primary-soft:#dbeafe;
      --bg:#f3f4f6;
      --card:#ffffff;
      --muted:#6b7280;
      --shadow-lg:0 18px 45px rgba(15,23,42,.14);
      --radius-lg:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e0edff,#f9fafb);
      min-height:100vh;
      padding:16px 10px 24px;
      color:#111827;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:14px;
    }
    header h1{font-size:1.35rem;margin-bottom:4px;}
    header p{font-size:.9rem;color:var(--muted);}
    .badge-top{
      padding:3px 9px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      font-size:.75rem;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge-top span.dot{
      width:6px;height:6px;border-radius:999px;background:#1d4ed8;
    }

    nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:14px;
    }
    nav button{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:.86rem;
      font-weight:500;
      cursor:pointer;
      background:#ffffffb8;
      color:#374151;
      box-shadow:0 8px 22px rgba(15,23,42,.12);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    nav button.active{
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      color:#fff;
      box-shadow:0 12px 30px rgba(37,99,235,.55);
    }
    nav button span.icon{font-size:1rem;}

    main{
      display:block;
    }
    section.page{
      display:none;
      background:var(--card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-lg);
      padding:16px 14px 14px;
    }
    section.page.active{display:block;}

    h2.section-title{
      font-size:1.05rem;
      margin-bottom:6px;
    }
    p.section-desc{
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:12px;
    }

    /* --- Form ƒêƒÇNG K√ù --- */
    .grid-2{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:10px 14px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-size:.8rem;
      font-weight:500;
      color:#374151;
    }
    input,select,textarea{
      border-radius:10px;
      border:1px solid #d1d5db;
      padding:8px 9px;
      font-size:.9rem;
      outline:none;
      width:100%;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
    }
    textarea{min-height:60px;resize:vertical;}
    .hint{
      font-size:.75rem;
      color:var(--muted);
    }
    .btn-primary{
      margin-top:10px;
      border:none;
      border-radius:999px;
      padding:9px 18px;
      font-size:.9rem;
      font-weight:600;
      color:#fff;
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      box-shadow:0 12px 26px rgba(37,99,235,.55);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary span.icon{font-size:1rem;}
    .note-small{
      margin-top:6px;
      font-size:.78rem;
      color:var(--muted);
    }

    .qr-box{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .qr-box img{
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.2);
      background:#fff;
      padding:12px;
      max-width:220px;
      width:100%;
    }

    /* --- Dashboard trong index --- */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;
      margin-bottom:12px;
    }
    .card-mini{
      background:#f9fafb;
      border-radius:14px;
      padding:10px 11px;
      box-shadow:0 10px 28px rgba(15,23,42,.08) inset;
    }
    .card-mini h3{
      font-size:.8rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
      margin-bottom:4px;
    }
    .card-mini .value{
      font-size:1.4rem;
      font-weight:700;
    }
    .card-mini .sub{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }
    .grid-charts{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:12px;
    }
    .chart-card{
      background:#f9fafb;
      border-radius:16px;
      padding:10px 10px 12px;
      box-shadow:0 16px 40px rgba(15,23,42,.12) inset;
      display:flex;
      flex-direction:column;
      min-height:210px;
    }
    .chart-card h3{
      font-size:.9rem;margin-bottom:3px;
    }
    .chart-card p{
      font-size:.78rem;color:var(--muted);margin-bottom:8px;
    }
    .chart-wrapper{flex:1;min-height:160px;}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 7px;
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary);
      font-size:.75rem;
      margin-top:3px;
    }
    .badge span.dot{
      width:7px;height:7px;border-radius:999px;background:var(--primary);
    }

    /* --- Xem k·∫øt qu·∫£ --- */
    .results{
      margin-top:8px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:10px;
    }
    .result-card{
      background:#f9fafb;
      border-radius:16px;
      padding:10px 11px;
      box-shadow:0 16px 42px rgba(15,23,42,.14) inset;
      position:relative;
      overflow:hidden;
    }
    .result-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(37,99,235,.06),transparent);
      pointer-events:none;
    }
    .result-name{
      font-size:1rem;
      font-weight:700;
      text-transform:uppercase;
      margin-bottom:3px;
    }
    .pill-score{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:#ecfdf3;
      color:#166534;
      font-size:.78rem;
      margin-bottom:4px;
    }
    .pill-score span.score{
      font-size:1.3rem;
      font-weight:700;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:3px 8px;
      margin-top:4px;
      font-size:.76rem;
      color:var(--muted);
    }
    .badge-meta{
      padding:2px 7px;
      border-radius:999px;
      background:#e5e7eb;
    }
    .status-msg{
      margin-top:8px;
      font-size:.82rem;
    }
    .status-empty{color:var(--muted);}
    .status-error{color:#b91c1c;}

    @media(max-width:640px){
      header{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>SK ‚Äì H·ªá th·ªëng Ki·ªÉm tra Online</h1>
      <p>ƒêƒÉng k√Ω ‚Äì L√†m b√†i ‚Äì Xem Dashboard ‚Äì Tra c·ª©u k·∫øt qu·∫£ tr√™n c√πng m·ªôt trang.</p>
      <div class="badge-top"><span class="dot"></span><span>Phi√™n b·∫£n PREMIUM</span></div>
    </div>
  </header>

  <nav>
    <button class="active" onclick="show('reg', this)"><span class="icon">üìù</span>ƒêƒÉng k√Ω</button>
    <button onclick="show('login', this)"><span class="icon">üîê</span>ƒêƒÉng nh·∫≠p</button>
    <button onclick="show('exam', this)"><span class="icon">üß™</span>V√†o thi</button>
    <button onclick="show('review', this)"><span class="icon">üìÑ</span>Xem l·∫°i</button>
    <button onclick="show('dash', this)"><span class="icon">üìä</span>Dashboard</button>
    <button onclick="show('lookup', this)"><span class="icon">üîé</span>Xem k·∫øt qu·∫£</button>
  </nav>

  <main>
    <!-- 1. ƒêƒÇNG K√ù -->
    <section id="reg" class="page active">
      <h2 class="section-title">ƒêƒÉng k√Ω tham gia h·ªá th·ªëng</h2>
      <p class="section-desc">Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b√™n d∆∞·ªõi. H·ªá th·ªëng ki·ªÉm tra tr√πng <b>CCCD</b> ho·∫∑c <b>Email</b> tr∆∞·ªõc khi l∆∞u.</p>

      <!-- üëâ THAY URL WEB APP T·∫†I ƒê√ÇY -->
      <form id="regForm"
            method="post"
            action="https://script.google.com/macros/s/AKfycbxIRwnJhmX8lqY78QYpGiXXCYtWfCBrGVNZUoyJvhgJ0Ej6cYooLL-pVZPGJmOXKtY2/exec">
        <div class="grid-2">
          <div class="field">
            <label for="hoten">H·ªç v√† t√™n (IN HOA)</label>
            <input id="hoten" name="hoten" placeholder="VD: NGUY·ªÑN VƒÇN A" required />
            <div class="hint">Nh·∫≠p th∆∞·ªùng c≈©ng ƒë∆∞·ª£c, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªïi th√†nh IN HOA khi l∆∞u.</div>
          </div>
          <div class="field">
            <label for="ngaysinh">Ng√†y sinh</label>
            <input id="ngaysinh" name="ngaysinh" type="date" />
          </div>
          <div class="field">
            <label for="gioitinh">Gi·ªõi t√≠nh</label>
            <select id="gioitinh" name="gioitinh">
              <option value="">-- Ch·ªçn --</option>
              <option>Nam</option>
              <option>N·ªØ</option>
              <option>Kh√°c</option>
            </select>
          </div>
          <div class="field">
            <label for="dantoc">D√¢n t·ªôc</label>
            <select id="dantoc" name="dantoc">
              <option value="">Kinh</option>
              <option>√ä-ƒë√™</option>
              <option>M'N√¥ng</option>
              <option>C∆°-ho</option>
              <option>Ba-na</option>
              <option>Kh√°c</option>
            </select>
          </div>
          <div class="field">
            <label for="truong">Tr∆∞·ªùng</label>
            <select id="truong" name="truong">
              <option>THPT Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
              <option>THPT Ph·∫°m VƒÉn ƒê·ªìng</option>
              <option>THPT B·∫£o L·ªôc</option>
              <option>THPT ƒê·ª©c Tr·ªçng</option>
              <option>Tr∆∞·ªùng kh√°c (ghi ch√∫)</option>
            </select>
            <div class="hint">N·∫øu tr∆∞·ªùng ch∆∞a c√≥ trong danh s√°ch, ch·ªçn ‚ÄúTr∆∞·ªùng kh√°c‚Äù v√† ghi r√µ ·ªü Ghi ch√∫.</div>
          </div>
          <div class="field">
            <label for="xa">X√£/Ph∆∞·ªùng</label>
            <input id="xa" name="xa" placeholder="VD: X√£ Ki·∫øn ƒê·ª©c" />
          </div>
          <div class="field">
            <label for="tinh">T·ªânh/TP</label>
            <select id="tinh" name="tinh">
              <option>L√¢m ƒê·ªìng</option>
              <option>ƒê·∫Øk L·∫Øk</option>
              <option>ƒê·∫Øk N√¥ng</option>
              <option>TP. H·ªì Ch√≠ Minh</option>
              <option>H√† N·ªôi</option>
              <option value="Kh√°c">T·ªânh/TP kh√°c</option>
            </select>
          </div>
          <div class="field">
            <label for="khoi">Kh·ªëi</label>
            <select id="khoi" name="khoi" required>
              <option value="">-- Ch·ªçn kh·ªëi --</option>
              <option>10</option>
              <option>11</option>
              <option>12</option>
            </select>
          </div>
          <div class="field">
            <label for="malop">L·ªõp</label>
            <input id="malop" name="malop" placeholder="VD: 12A1" />
            <div class="hint">Nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng: 10A1, 11A2, 12A5,‚Ä¶</div>
          </div>
          <div class="field">
            <label for="cccd">CCCD</label>
            <input id="cccd" name="cccd" inputmode="numeric" placeholder="Ch·ªâ nh·∫≠p s·ªë" />
            <div class="hint">H·ªá th·ªëng l∆∞u CCCD d·∫°ng k√Ω t·ª± s·ªë (chu·ªói), kh√¥ng t√≠nh to√°n tr√™n tr∆∞·ªùng n√†y.</div>
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="VD: ten@gmail.com" />
            <div class="hint">D√πng ƒë·ªÉ h·ªá th·ªëng g·ª≠i x√°c nh·∫≠n ƒëƒÉng k√Ω & th√¥ng tin ph√≤ng thi.</div>
          </div>
          <div class="field">
            <label for="ghichu">Ghi ch√∫ th√™m</label>
            <textarea id="ghichu" name="ghichu" placeholder="VD: Tr∆∞·ªùng kh√°c, ho√†n c·∫£nh ƒë·∫∑c bi·ªát, ..."></textarea>
          </div>
        </div>

        <button type="submit" class="btn-primary">
          <span class="icon">‚úÖ</span><span>G·ª≠i ƒëƒÉng k√Ω</span>
        </button>
        <div class="note-small">Sau khi g·ª≠i, h·ªá th·ªëng s·∫Ω hi·ªán th√¥ng b√°o Th√†nh c√¥ng / Tr√πng th√¥ng tin v√† g·ª≠i email cho h·ªçc sinh (n·∫øu c√≥).</div>
      </form>

      <div class="qr-box">
        <div class="hint">Qu√©t QR ƒë·ªÉ m·ªü trang ƒëƒÉng k√Ω tr√™n ƒëi·ªán tho·∫°i:</div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https%3A%2F%2Ftrungk8.github.io%2FDTAI_Online%2F"
             alt="QR Code ƒëƒÉng k√Ω"/>
      </div>
    </section>

    <!-- 2. ƒêƒÇNG NH·∫¨P (placeholder) -->
    <section id="login" class="page">
      <h2 class="section-title">ƒêƒÉng nh·∫≠p</h2>
      <p class="section-desc">Ph·∫ßn n√†y th·∫ßy c√≥ th·ªÉ d√πng cho gi√°o vi√™n / admin n·∫øu c·∫ßn (hi·ªán ƒë·ªÉ minh h·ªça, ch∆∞a g·∫Øn backend).</p>
      <div class="grid-2">
        <div class="field">
          <label>T√†i kho·∫£n</label>
          <input placeholder="T√†i kho·∫£n gi√°o vi√™n / qu·∫£n tr·ªã" />
        </div>
        <div class="field">
          <label>M·∫≠t kh·∫©u</label>
          <input type="password" placeholder="M·∫≠t kh·∫©u" />
        </div>
      </div>
      <button class="btn-primary" type="button" onclick="alert('Demo giao di·ªán ‚Äì ch∆∞a k·∫øt n·ªëi h·ªá th·ªëng ƒëƒÉng nh·∫≠p.')">
        <span class="icon">üîê</span><span>ƒêƒÉng nh·∫≠p (demo)</span>
      </button>
    </section>

    <!-- 3. V√ÄO THI (placeholder li√™n k·∫øt Google Form/Quiz) -->
    <section id="exam" class="page">
      <h2 class="section-title">V√†o thi</h2>
      <p class="section-desc">Th·∫ßy d√°n li√™n k·∫øt Google Form/Quiz v√†o ƒë√¢y ƒë·ªÉ h·ªçc sinh b·∫•m v√†o l√†m b√†i.</p>
      <div class="field">
        <label>Li√™n k·∫øt b√†i ki·ªÉm tra</label>
        <input id="examLink" placeholder="https://docs.google.com/forms/..." value="" />
        <div class="hint">Khi tri·ªÉn khai th·∫≠t, th·∫ßy c√≥ th·ªÉ c·ªë ƒë·ªãnh link n√†y ho·∫∑c thay ƒë·ªïi theo t·ª´ng ƒë·ª£t ki·ªÉm tra.</div>
      </div>
      <button class="btn-primary" type="button" onclick="openExam()">
        <span class="icon">üß™</span><span>M·ªü b√†i ki·ªÉm tra</span>
      </button>
    </section>

    <!-- 4. Xem l·∫°i (placeholder danh s√°ch ƒëi·ªÉm d·∫°ng th√¥ / link) -->
    <section id="review" class="page">
      <h2 class="section-title">Xem l·∫°i</h2>
      <p class="section-desc">Ph·∫ßn n√†y th·∫ßy c√≥ th·ªÉ ƒë·∫∑t link xem nhanh Google Sheet ƒëi·ªÉm ho·∫∑c h∆∞·ªõng d·∫´n chi ti·∫øt cho gi√°o vi√™n.</p>
      <div class="field">
        <label>Li√™n k·∫øt sheet ƒëi·ªÉm (DiemThi)</label>
        <input id="sheetLink" placeholder="https://docs.google.com/spreadsheets/..." value="" />
      </div>
      <button class="btn-primary" type="button" onclick="openSheet()">
        <span class="icon">üìÑ</span><span>M·ªü sheet ƒëi·ªÉm</span>
      </button>
    </section>

    <!-- 5. DASHBOARD ‚Äì d√πng JSONP mode=stats -->
    <section id="dash" class="page">
      <h2 class="section-title">Dashboard th·ªëng k√™</h2>
      <p class="section-desc">Th·ªëng k√™ s·ªë l∆∞·ª£ng b√†i thi theo Kh·ªëi, L·ªõp, Gi·ªõi t√≠nh, D√¢n t·ªôc, Tr∆∞·ªùng ‚Äì d·ªØ li·ªáu l·∫•y tr·ª±c ti·∫øp t·ª´ sheet ƒëi·ªÉm.</p>

      <div class="cards">
        <div class="card-mini">
          <h3>T·ªïng s·ªë b√†i thi</h3>
          <div class="value" id="dashTotal">‚Äì</div>
          <div class="sub" id="dashTotalNote">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</div>
        </div>
        <div class="card-mini">
          <h3>S·ªë kh·ªëi</h3>
          <div class="value" id="dashGrade">‚Äì</div>
          <div class="sub">Kh·ªëi c√≥ √≠t nh·∫•t 1 h·ªçc sinh.</div>
        </div>
        <div class="card-mini">
          <h3>S·ªë l·ªõp</h3>
          <div class="value" id="dashClass">‚Äì</div>
          <div class="sub">T·ªïng s·ªë l·ªõp xu·∫•t hi·ªán.</div>
        </div>
        <div class="card-mini">
          <h3>S·ªë tr∆∞·ªùng</h3>
          <div class="value" id="dashSchool">‚Äì</div>
          <div class="sub">Tr∆∞·ªùng c√≥ h·ªçc sinh tham gia.</div>
        </div>
      </div>

      <div class="grid-charts">
        <div class="chart-card">
          <h3>Ph√¢n b·ªë theo Kh·ªëi</h3>
          <p>S·ªë b√†i thi theo kh·ªëi 10 / 11 / 12.</p>
          <div class="chart-wrapper"><canvas id="chartGrade"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>Top l·ªõp</h3>
          <p>Nh·ªØng l·ªõp c√≥ nhi·ªÅu l∆∞·ª£t l√†m b√†i nh·∫•t.</p>
          <div class="chart-wrapper"><canvas id="chartClass"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>Gi·ªõi t√≠nh</h3>
          <p>T·ª∑ l·ªá Nam / N·ªØ / Kh√°c.</p>
          <div class="chart-wrapper"><canvas id="chartGender"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>D√¢n t·ªôc / Tr∆∞·ªùng</h3>
          <p>Top d√¢n t·ªôc v√† tr∆∞·ªùng c√≥ nhi·ªÅu l∆∞·ª£t l√†m b√†i.</p>
          <div class="badge"><span class="dot"></span><span>Ch·ªâ hi·ªÉn th·ªã Top 6 m·ª•c.</span></div>
          <div class="chart-wrapper" style="margin-top:6px;"><canvas id="chartEthnicSchool"></canvas></div>
        </div>
      </div>
    </section>

    <!-- 6. XEM K·∫æT QU·∫¢ ‚Äì d√πng JSONP mode=search -->
    <section id="lookup" class="page">
      <h2 class="section-title">Xem l·∫°i k·∫øt qu·∫£ b√†i thi</h2>
      <p class="section-desc">Nh·∫≠p <b>CCCD</b> ho·∫∑c <b>H·ªç t√™n (IN HOA)</b> + <b>L·ªõp</b> ƒë·ªÉ tra c·ª©u k·∫øt qu·∫£ t·ª´ sheet ƒëi·ªÉm DiemThi.</p>

      <form id="searchForm">
        <div class="grid-2">
          <div class="field">
            <label for="s_cccd">CCCD (∆∞u ti√™n)</label>
            <input id="s_cccd" name="cccd" inputmode="numeric" placeholder="Ch·ªâ nh·∫≠p s·ªë, VD: 0790xxxxxxx" />
            <div class="hint">N·∫øu nh·∫≠p CCCD, h·ªá th·ªëng s·∫Ω t√¨m ch√≠nh x√°c theo CCCD tr∆∞·ªõc.</div>
          </div>
          <div class="field">
            <label for="s_name">H·ªç t√™n (IN HOA)</label>
            <input id="s_name" name="name" placeholder="VD: NGUY·ªÑN VƒÇN A" />
            <div class="hint">Nh·∫≠p th∆∞·ªùng c≈©ng ƒë∆∞·ª£c, h·ªá th·ªëng t·ª± chuy·ªÉn sang IN HOA khi g·ª≠i.</div>
          </div>
          <div class="field">
            <label for="s_class">L·ªõp</label>
            <input id="s_class" name="className" placeholder="VD: 12A1" />
            <div class="hint">C√≥ th·ªÉ b·ªè tr·ªëng L·ªõp (s·∫Ω t√¨m theo H·ªç t√™n tr√™n to√†n b·ªô kh·ªëi).</div>
          </div>
        </div>
        <button type="submit" class="btn-primary">
          <span class="icon">üîé</span><span>Tra c·ª©u k·∫øt qu·∫£</span>
        </button>
      </form>
      <div id="status" class="status-msg status-empty"></div>
      <div id="results" class="results"></div>
    </section>
  </main>
</div>

<script>
  // üëâ NH·ªö C·∫¨P NH·∫¨T C√ôNG M·ªòT URL V·ªöI action C·ª¶A FORM
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIRwnJhmX8lqY78QYpGiXXCYtWfCBrGVNZUoyJvhgJ0Ej6cYooLL-pVZPGJmOXKtY2/exec";

  function show(id, btn){
    document.querySelectorAll("section.page").forEach(sec=>{
      sec.classList.toggle("active", sec.id === id);
    });
    if(btn){
      document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    }
  }

  function openExam(){
    const link = document.getElementById("examLink").value.trim();
    if(!link){ alert("Th·∫ßy/ch·ªã nh·∫≠p link Google Form/Quiz tr∆∞·ªõc ƒë√£ nh√©."); return; }
    window.open(link,"_blank");
  }
  function openSheet(){
    const link = document.getElementById("sheetLink").value.trim();
    if(!link){ alert("Nh·∫≠p link Google Sheet ƒëi·ªÉm DiemThi tr∆∞·ªõc ƒë√£."); return; }
    window.open(link,"_blank");
  }

  // --------- JSONP helper ---------
  function callJsonp(url, callbackName){
    return new Promise(resolve=>{
      window[callbackName] = function(data){ resolve(data); };
      const s = document.createElement("script");
      s.src = url + (url.indexOf("?")>=0 ? "&" : "?") + "callback=" + callbackName;
      document.body.appendChild(s);
    });
  }

  // ---------- DASHBOARD ----------
  let chartGrade, chartClass, chartGender, chartEthnicSchool;

  function topEntries(obj, limit){
    const arr = Object.entries(obj || {});
    arr.sort((a,b)=> (b[1].count||0)-(a[1].count||0));
    return arr.slice(0,limit);
  }

  async function loadDashboard(){
    try{
      const data = await callJsonp(WEB_APP_URL + "?mode=stats","statsCallback");
      if(!data){ throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu."); }

      const total = data.total || data.rows || 0;
      document.getElementById("dashTotal").textContent = total;
      document.getElementById("dashTotalNote").textContent = "T·ªïng s·ªë b·∫£n ghi trong sheet ƒëi·ªÉm.";

      const grades  = data.byKhoi    || data.byGrade   || {};
      const classes = data.byLop     || data.byClass   || {};
      const genders = data.byGender || {};
      const ethnics = data.byEthnicity || data.byEthnic || {};
      const schools = data.bySchool || {};

      document.getElementById("dashGrade").textContent  = Object.keys(grades).length;
      document.getElementById("dashClass").textContent  = Object.keys(classes).length;
      document.getElementById("dashSchool").textContent = Object.keys(schools).length;

      // Kh·ªëi
      const gLabels = Object.keys(grades);
      const gValues = gLabels.map(k=>grades[k].count||0);
      drawBar("chartGrade","S·ªë b√†i theo kh·ªëi",gLabels,gValues,c=>chartGrade=c);

      // L·ªõp (top 10)
      const topClass = topEntries(classes,10);
      drawBar("chartClass","Top l·ªõp", topClass.map(x=>x[0]), topClass.map(x=>x[1].count||0), c=>chartClass=c);

      // Gi·ªõi t√≠nh
      const genLabels = Object.keys(genders);
      const genValues = genLabels.map(k=>genders[k].count||genders[k]||0);
      drawPie("chartGender",genLabels,genValues,c=>chartGender=c);

      // D√¢n t·ªôc + Tr∆∞·ªùng (top 6)
      const topEth = topEntries(ethnics,6);
      const topSch = topEntries(schools,6);
      const labels = topEth.map(x=>x[0]).concat(topSch.map(x=>"Trg: "+x[0]));
      const vals   = topEth.map(x=>x[1].count||0).concat(topSch.map(x=>x[1].count||0));
      drawBar("chartEthnicSchool","D√¢n t·ªôc / Tr∆∞·ªùng",labels,vals,c=>chartEthnicSchool=c);

    }catch(err){
      console.error(err);
      document.getElementById("dashTotalNote").textContent = "L·ªói t·∫£i d·ªØ li·ªáu Dashboard.";
    }
  }

  function drawBar(canvasId,label,labels,values,setRef){
    const ctx = document.getElementById(canvasId).getContext("2d");
    const c = new Chart(ctx,{
      type:"bar",
      data:{labels:labels,datasets:[{label:label,data:values,borderRadius:8}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{font:{size:10}},grid:{display:false}},
          y:{beginAtZero:true,grid:{color:"rgba(209,213,219,.7)"}}
        }
      }
    });
    if(setRef) setRef(c);
  }
  function drawPie(canvasId,labels,values,setRef){
    const ctx = document.getElementById(canvasId).getContext("2d");
    const c = new Chart(ctx,{
      type:"doughnut",
      data:{labels:labels,datasets:[{data:values}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{position:"bottom",labels:{font:{size:10}}}},
        cutout:"58%"
      }
    });
    if(setRef) setRef(c);
  }

  // ---------- XEM K·∫æT QU·∫¢ ----------
  function buildSearchUrl(){
    const cccdRaw = document.getElementById("s_cccd").value.trim();
    const cccd = cccdRaw.replace(/\D/g,"");
    let name = document.getElementById("s_name").value.trim();
    let cls  = document.getElementById("s_class").value.trim();

    if(name) name = name.toLocaleUpperCase("vi-VN");
    if(cls)  cls  = cls.toUpperCase();

    const p = new URLSearchParams();
    if(cccd) p.append("cccd",cccd);
    if(name) p.append("name",name);
    if(cls)  p.append("className",cls);
    p.append("mode","search");
    return WEB_APP_URL + "?" + p.toString();
  }

  function renderSearchResults(data){
    const statusEl = document.getElementById("status");
    const resultsEl= document.getElementById("results");
    resultsEl.innerHTML="";

    if(!data){
      statusEl.textContent = "L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ server.";
      statusEl.className = "status-msg status-error";
      return;
    }
    if(!data.found){
      statusEl.textContent = data.message || "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.";
      statusEl.className = "status-msg status-empty";
      return;
    }
    statusEl.textContent = data.message || "ƒê√£ t√¨m th·∫•y k·∫øt qu·∫£.";
    statusEl.className = "status-msg status-empty";

    (data.results || []).forEach(item=>{
      const card = document.createElement("div");
      card.className = "result-card";
      card.innerHTML = `
        <div class="result-name">${(item.name||"").toUpperCase()}</div>
        <div class="pill-score">
          <span class="score">${item.score!=="" ? item.score : "‚Äì"}</span>
          <span>ƒêi·ªÉm</span>
        </div>
        <div class="meta">
          <span class="badge-meta">L·ªõp: ${item.className||"‚Äì"}</span>
          <span class="badge-meta">Gi·ªõi t√≠nh: ${item.gender||"‚Äì"}</span>
          <span class="badge-meta">D√¢n t·ªôc: ${item.ethnic||"‚Äì"}</span>
          <span class="badge-meta">Tr∆∞·ªùng: ${item.school||"‚Äì"}</span>
          <span class="badge-meta">CCCD: ${item.cccd||"‚Äì"}</span>
        </div>
      `;
      resultsEl.appendChild(card);
    });
  }

  document.getElementById("searchForm").addEventListener("submit",async function(e){
    e.preventDefault();
    const statusEl = document.getElementById("status");
    const resultsEl= document.getElementById("results");
    resultsEl.innerHTML="";
    statusEl.textContent = "ƒêang tra c·ª©u, vui l√≤ng ch·ªù‚Ä¶";
    statusEl.className = "status-msg status-empty";

    try{
      const url = buildSearchUrl();
      const data = await callJsonp(url,"searchCallback");
      renderSearchResults(data);
    }catch(err){
      console.error(err);
      statusEl.textContent = "C√≥ l·ªói khi tra c·ª©u. Th·∫ßy/c√¥ ki·ªÉm tra l·∫°i Code.gs ho·∫∑c k·∫øt n·ªëi m·∫°ng.";
      statusEl.className = "status-msg status-error";
    }
  });

  // T·∫£i Dashboard ngay sau khi trang load (c√≥ s·∫µn d·ªØ li·ªáu cho tab Dashboard)
  document.addEventListener("DOMContentLoaded", loadDashboard);
</script>
</body>
</html>
